
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Zehua Zeng" name="author"/>
<link href="../../../img/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.2" name="generator"/>
<title>Api pl - omicverse Readthedocs</title>
<link href="../../../assets/stylesheets/main.7bf56d0a.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../../css/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#violin-and-distribution-plots">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="omicverse Readthedocs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="omicverse Readthedocs">
<img alt="logo" src="../../../img/ico.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            omicverse Readthedocs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Api pl
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/Starlitnightly/omicverse" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="omicverse Readthedocs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="omicverse Readthedocs">
<img alt="logo" src="../../../img/ico.png"/>
</a>
    omicverse Readthedocs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/Starlitnightly/omicverse" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Index
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Installation_guild/">
        Installation
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          Bulk
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_1">
<span class="md-nav__icon md-icon"></span>
          Bulk
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_bulk_combat/">
        Batch correction in Bulk RNA-seq or microarray data
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_deg/">
        Different Expression Analysis
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_deseq2/">
        Different Expression Analysis with DEseq2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_network/">
        Protein-Protein interaction (PPI) analysis by String-db
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_wgcna/">
        WGCNA (Weighted gene co-expression network analysis) analysis
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk/t_tcga/">
        TCGA database preprocess
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Single
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
          Single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
          Preprocessing
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_1">
<span class="md-nav__icon md-icon"></span>
          Preprocessing
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_preprocess_cpu/">
        Preprocessing the data of scRNA-seq with omicverse[CPU-GPU-mixed]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_preprocess_gpu/">
        Preprocessing the data of scRNA-seq with omicverse[GPU][Bug]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cluster/">
        Clustering space
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_single_batch/">
        Data integration and batch correction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cnmf/">
        Consensus Non-negative Matrix factorization (cNMF)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_lazy/">
        Lazy analysis of scRNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
          Annotation
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_2">
<span class="md-nav__icon md-icon"></span>
          Annotation
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_gptanno/">
        Automatic cell type annotation with GPT/Other
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellmatch/">
        Mapping Cell Names to the Cell Ontology/Taxonomy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellanno/">
        Celltype auto annotation with SCSA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_metatime/">
        Celltype auto annotation with MetaTiME
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_tosica/">
        Celltype annotation migration(mapping) with TOSICA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_scmulan/">
        Celltype auto annotation with scMulan
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellvote/">
        Consensus annotation with CellVote
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_3" id="__nav_3_2_3_label" tabindex="0">
          Trajectory
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_3">
<span class="md-nav__icon md-icon"></span>
          Trajectory
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cytotrace/">
        Prediction of absolute developmental potential using CytoTrace2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_traj/">
        Basic Trajectory Inference
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_stavia/">
        Trajectory Inference with StaVIA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellfate_gene/">
        Timing-associated genes analysis with TimeFateKernel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellfate/">
        Identify the driver regulators of cell fate decisions
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_4" id="__nav_3_2_4_label" tabindex="0">
          Cell Structure
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_4">
<span class="md-nav__icon md-icon"></span>
          Cell Structure
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_metacells/">
        Inference of MetaCell from Single-Cell RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_deg_single/">
        Differential expression and celltype analysis [All Cell]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_scdeg/">
        Differential expression analysis [Meta Cell]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_scenic/">
        Gene Regulatory Network Analysis with SCENIC
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_aucell/">
        Pathway analysis with AUCell
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_cellphonedb/">
        Cell-cell communication using CellPhoneDBViz
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_scdrug/">
        Drug response predict with scDrug
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_simba/">
        Data integration and batch correction with SIMBA
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_5" id="__nav_3_2_5_label" tabindex="0">
          Multi omics
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_5_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_5">
<span class="md-nav__icon md-icon"></span>
          Multi omics
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_mofa/">
        Multi omics analysis by MOFA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_mofa_glue/">
        Multi omics analysis by MOFA and GLUE
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-single/t_anno_trans/">
        Celltype annotation transfer in multi-omics
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          Bulk2Single
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
          Bulk2Single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk2single/t_bulktrajblend/">
        Bulk RNA-seq generate 'interrupted' cells to interpolate scRNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk2single/t_bulk2single/">
        Bulk RNA-seq to Single RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-bulk2single/t_single2spatial/">
        Single RNA-seq to Spatial RNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          Space
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
          Space
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_crop_rotate/">
        Crop and Rotation of spatial transcriptomic data
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_cluster_space/">
        Spatial clustering and denoising expressions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_spaceflow/">
        Identifying Pseudo-Spatial Map
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_mapping/">
        Mapping single-cell profile onto spatial profile
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_starfysh/">
        Deconvolution spatial transcriptomic without scRNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_stt/">
        Spatial transition tensor of single cells
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_commot_flowsig/">
        Spatial Communication
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_staligner/">
        Spatial integration and clustering
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_gaston/">
        Spatial IsoDepth Calculation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-space/t_slat/">
        Single cell spatial alignment tools
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
          Plotting
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
          Plotting
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-plotting/t_visualize_single/">
        Visualization of single cell RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-plotting/t_visualize_bulk/">
        Visualization of Bulk RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tutorials-plotting/t_visualize_colorsystem/">
        Color system
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
        API documentation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Release_notes/">
        Release notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Developer_guild/">
        Developer guild
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#violin-and-distribution-plots">
    Violin and Distribution Plots
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.violin">
    violin()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dot-plots">
    Dot Plots
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.dotplot">
    dotplot()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot">
    rank_genes_groups_dotplot()
  </a>
<nav aria-label="rank_genes_groups_dotplot()" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--parameters">
    Parameters
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--returns">
    Returns
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--examples">
    Examples
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--basic-usage-with-top-genes">
    Basic usage with top genes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--using-logfoldchanges-for-coloring">
    Using logfoldchanges for coloring
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.rank_genes_groups_dotplot--grouping-genes-manually">
    Grouping genes manually
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#embedding-and-scatter-plots">
    Embedding and Scatter Plots
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.embedding">
    embedding()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.embedding_celltype">
    embedding_celltype()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.embedding_adjust">
    embedding_adjust()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.embedding_atlas">
    embedding_atlas()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.embedding_multi">
    embedding_multi()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cell-proportion-and-analysis">
    Cell Proportion and Analysis
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.cellproportion">
    cellproportion()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bulk-data-visualization">
    Bulk Data Visualization
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.volcano">
    volcano()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.venn">
    venn()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.boxplot">
    boxplot()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#density-and-contour">
    Density and Contour
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.calculate_gene_density">
    calculate_gene_density()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.add_density_contour">
    add_density_contour()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#spatial-plotting">
    Spatial Plotting
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment">
    spatial_segment()
  </a>
<nav aria-label="spatial_segment()" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment--parameters">
    Parameters
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment--returns">
    Returns
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment_overlay">
    spatial_segment_overlay()
  </a>
<nav aria-label="spatial_segment_overlay()" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment_overlay--parameters">
    Parameters
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment_overlay--returns">
    Returns
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment_overlay--examples">
    Examples
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.pl.spatial_segment_overlay--overlay-two-genes-with-different-colors">
    Overlay two genes with different colors
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Api pl</h1>
<h2 id="violin-and-distribution-plots">Violin and Distribution Plots<a class="headerlink" href="#violin-and-distribution-plots" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.violin">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">violin</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stripplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_norm</span><span class="o">=</span><span class="s1">'width'</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multi_panel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enhanced_style</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_means</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_boxplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jitter_method</span><span class="o">=</span><span class="s1">'uniform'</span><span class="p">,</span> <span class="n">jitter_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">violin_alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">'white'</span><span class="p">,</span> <span class="n">spine_color</span><span class="o">=</span><span class="s1">'#b4aea9'</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">statistical_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">custom_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">ticks_fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.violin" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Enhanced violin plot compatible with scanpy's interface.</p>
<p>This function provides all the functionality of scanpy's violin plot
with additional customization options for enhanced visualization,
implemented using pure matplotlib.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>AnnData. Annotated data matrix.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>keys</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>str | Sequence[str]. Keys for accessing variables of <code>.var_names</code> or fields of <code>.obs</code>.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>groupby</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str | None. The key of the observation grouping to consider. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>log</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Plot on logarithmic axis. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>use_raw</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool | None. Whether to use <code>raw</code> attribute of <code>adata</code>. Defaults to <code>True</code> if <code>.raw</code> is present. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>stripplot</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Add a stripplot on top of the violin plot. (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>jitter</code></td>
<td>
<code><span title="typing.Union">Union</span>[float, bool]</code>
</td>
<td><p>float | bool. Add jitter to the stripplot (only when stripplot is True). (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>size</code></td>
<td>
<code>int</code>
</td>
<td><p>int. Size of the jitter points. (1)</p></td>
<td>
<code>1</code>
</td>
</tr>
<tr>
<td><code>layer</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str | None. Name of the AnnData object layer that wants to be plotted. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>density_norm</code></td>
<td>
<code><span title="omicverse.pl._violin.DensityNorm">DensityNorm</span></code>
</td>
<td><p>str. The method used to scale the width of each violin. If 'width' (the default), each violin will have the same width. If 'area', each violin will have the same area. If 'count', a violin's width corresponds to the number of observations. ('width')</p></td>
<td>
<code>'width'</code>
</td>
</tr>
<tr>
<td><code>order</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>Sequence[str] | None. Order in which to show the categories. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>multi_panel</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool | None. Display keys in multiple panels also when <code>groupby is not None</code>. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>xlabel</code></td>
<td>
<code>str</code>
</td>
<td><p>str. Label of the x axis. ('')</p></td>
<td>
<code>''</code>
</td>
</tr>
<tr>
<td><code>ylabel</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]]</code>
</td>
<td><p>str | Sequence[str] | None. Label of the y axis. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>rotation</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float | None. Rotation of xtick labels. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>show</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool | None. Whether to show the plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>save</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[bool, str]]</code>
</td>
<td><p>bool | str | None. Path to save the figure. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="matplotlib.axes.Axes">Axes</span>]</code>
</td>
<td><p>Axes | None. A matplotlib axes object. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>enhanced_style</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Whether to apply enhanced styling. (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>show_means</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Whether to show mean values with annotations. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>show_boxplot</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Whether to overlay box plots on violins. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>jitter_method</code></td>
<td>
<code>str</code>
</td>
<td><p>str. Method for jittering: 'uniform' or 't_dist'. ('uniform')</p></td>
<td>
<code>'uniform'</code>
</td>
</tr>
<tr>
<td><code>jitter_alpha</code></td>
<td>
<code>float</code>
</td>
<td><p>float. Transparency of jittered points. (0.4)</p></td>
<td>
<code>0.4</code>
</td>
</tr>
<tr>
<td><code>violin_alpha</code></td>
<td>
<code>float</code>
</td>
<td><p>float. Transparency of violin plots. (0.8)</p></td>
<td>
<code>0.8</code>
</td>
</tr>
<tr>
<td><code>background_color</code></td>
<td>
<code>str</code>
</td>
<td><p>str. Background color of the plot. ('white')</p></td>
<td>
<code>'white'</code>
</td>
</tr>
<tr>
<td><code>spine_color</code></td>
<td>
<code>str</code>
</td>
<td><p>str. Color of plot spines. ('#b4aea9')</p></td>
<td>
<code>'#b4aea9'</code>
</td>
</tr>
<tr>
<td><code>grid_lines</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Whether to show horizontal grid lines. (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>statistical_tests</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool. Whether to perform and display statistical tests. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>custom_colors</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>Sequence[str] | None. Custom colors for groups. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[tuple]</code>
</td>
<td><p>tuple | None. Figure size (width, height). (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>
</td>
<td><p>int. Font size for labels and ticks. (13)</p></td>
<td>
<code>13</code>
</td>
</tr>
<tr>
<td><code>ticks_fontsize</code></td>
<td>
</td>
<td><p>int | None. Font size for axis ticks. If None, uses fontsize-1. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>**kwds</code></td>
<td>
</td>
<td><p>Additional keyword arguments passed to violinplot.</p></td>
<td>
<code>{}</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td> <td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.axes.Axes">Axes</span>, None]</code>
</td>
<td><p>matplotlib.axes.Axes | None. A matplotlib axes object if <code>ax</code> is <code>None</code> else <code>None</code>.</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_violin.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 36 "></span><span class="k">def</span> <span class="nf">violin</span><span class="p">(</span>
<span class="linenos" data-linenos=" 37 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos=" 38 "></span>    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="linenos" data-linenos=" 39 "></span>    <span class="n">groupby</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 40 "></span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos" data-linenos=" 41 "></span>    <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 42 "></span>    <span class="n">use_raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 43 "></span>    <span class="n">stripplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 44 "></span>    <span class="n">jitter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 45 "></span>    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 46 "></span>    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 47 "></span>    <span class="n">density_norm</span><span class="p">:</span> <span class="n">DensityNorm</span> <span class="o">=</span> <span class="s2">"width"</span><span class="p">,</span>
<span class="linenos" data-linenos=" 48 "></span>    <span class="n">order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 49 "></span>    <span class="n">multi_panel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 50 "></span>    <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
<span class="linenos" data-linenos=" 51 "></span>    <span class="n">ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 52 "></span>    <span class="n">rotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 53 "></span>    <span class="n">show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 54 "></span>    <span class="n">save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 55 "></span>    <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 56 "></span>    <span class="c1"># Enhanced features</span>
<span class="linenos" data-linenos=" 57 "></span>    <span class="n">enhanced_style</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 58 "></span>    <span class="n">show_means</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 59 "></span>    <span class="n">show_boxplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 60 "></span>    <span class="n">jitter_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'uniform'</span><span class="p">,</span>  <span class="c1"># 'uniform', 't_dist'</span>
<span class="linenos" data-linenos=" 61 "></span>    <span class="n">jitter_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
<span class="linenos" data-linenos=" 62 "></span>    <span class="n">violin_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
<span class="linenos" data-linenos=" 63 "></span>    <span class="n">background_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'white'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 64 "></span>    <span class="n">spine_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'#b4aea9'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 65 "></span>    <span class="n">grid_lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 66 "></span>    <span class="n">statistical_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 67 "></span>    <span class="n">custom_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 68 "></span>    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 69 "></span>    <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
<span class="linenos" data-linenos=" 70 "></span>    <span class="n">ticks_fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 71 "></span>    <span class="o">**</span><span class="n">kwds</span>
<span class="linenos" data-linenos=" 72 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="linenos" data-linenos=" 73 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 74 "></span><span class="sd">    Enhanced violin plot compatible with scanpy's interface.</span>
<span class="linenos" data-linenos=" 75 "></span>
<span class="linenos" data-linenos=" 76 "></span><span class="sd">    This function provides all the functionality of scanpy's violin plot</span>
<span class="linenos" data-linenos=" 77 "></span><span class="sd">    with additional customization options for enhanced visualization,</span>
<span class="linenos" data-linenos=" 78 "></span><span class="sd">    implemented using pure matplotlib.</span>
<span class="linenos" data-linenos=" 79 "></span>
<span class="linenos" data-linenos=" 80 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 81 "></span><span class="sd">        adata: AnnData. Annotated data matrix.</span>
<span class="linenos" data-linenos=" 82 "></span><span class="sd">        keys: str | Sequence[str]. Keys for accessing variables of `.var_names` or fields of `.obs`.</span>
<span class="linenos" data-linenos=" 83 "></span><span class="sd">        groupby: str | None. The key of the observation grouping to consider. (None)</span>
<span class="linenos" data-linenos=" 84 "></span><span class="sd">        log: bool. Plot on logarithmic axis. (False)</span>
<span class="linenos" data-linenos=" 85 "></span><span class="sd">        use_raw: bool | None. Whether to use `raw` attribute of `adata`. Defaults to `True` if `.raw` is present. (None)</span>
<span class="linenos" data-linenos=" 86 "></span><span class="sd">        stripplot: bool. Add a stripplot on top of the violin plot. (True)</span>
<span class="linenos" data-linenos=" 87 "></span><span class="sd">        jitter: float | bool. Add jitter to the stripplot (only when stripplot is True). (True)</span>
<span class="linenos" data-linenos=" 88 "></span><span class="sd">        size: int. Size of the jitter points. (1)</span>
<span class="linenos" data-linenos=" 89 "></span><span class="sd">        layer: str | None. Name of the AnnData object layer that wants to be plotted. (None)</span>
<span class="linenos" data-linenos=" 90 "></span><span class="sd">        density_norm: str. The method used to scale the width of each violin. If 'width' (the default), each violin will have the same width. If 'area', each violin will have the same area. If 'count', a violin's width corresponds to the number of observations. ('width')</span>
<span class="linenos" data-linenos=" 91 "></span><span class="sd">        order: Sequence[str] | None. Order in which to show the categories. (None)</span>
<span class="linenos" data-linenos=" 92 "></span><span class="sd">        multi_panel: bool | None. Display keys in multiple panels also when `groupby is not None`. (None)</span>
<span class="linenos" data-linenos=" 93 "></span><span class="sd">        xlabel: str. Label of the x axis. ('')</span>
<span class="linenos" data-linenos=" 94 "></span><span class="sd">        ylabel: str | Sequence[str] | None. Label of the y axis. (None)</span>
<span class="linenos" data-linenos=" 95 "></span><span class="sd">        rotation: float | None. Rotation of xtick labels. (None)</span>
<span class="linenos" data-linenos=" 96 "></span><span class="sd">        show: bool | None. Whether to show the plot. (None)</span>
<span class="linenos" data-linenos=" 97 "></span><span class="sd">        save: bool | str | None. Path to save the figure. (None)</span>
<span class="linenos" data-linenos=" 98 "></span><span class="sd">        ax: Axes | None. A matplotlib axes object. (None)</span>
<span class="linenos" data-linenos=" 99 "></span><span class="sd">        enhanced_style: bool. Whether to apply enhanced styling. (True)</span>
<span class="linenos" data-linenos="100 "></span><span class="sd">        show_means: bool. Whether to show mean values with annotations. (False)</span>
<span class="linenos" data-linenos="101 "></span><span class="sd">        show_boxplot: bool. Whether to overlay box plots on violins. (False)</span>
<span class="linenos" data-linenos="102 "></span><span class="sd">        jitter_method: str. Method for jittering: 'uniform' or 't_dist'. ('uniform')</span>
<span class="linenos" data-linenos="103 "></span><span class="sd">        jitter_alpha: float. Transparency of jittered points. (0.4)</span>
<span class="linenos" data-linenos="104 "></span><span class="sd">        violin_alpha: float. Transparency of violin plots. (0.8)</span>
<span class="linenos" data-linenos="105 "></span><span class="sd">        background_color: str. Background color of the plot. ('white')</span>
<span class="linenos" data-linenos="106 "></span><span class="sd">        spine_color: str. Color of plot spines. ('#b4aea9')</span>
<span class="linenos" data-linenos="107 "></span><span class="sd">        grid_lines: bool. Whether to show horizontal grid lines. (True)</span>
<span class="linenos" data-linenos="108 "></span><span class="sd">        statistical_tests: bool. Whether to perform and display statistical tests. (False)</span>
<span class="linenos" data-linenos="109 "></span><span class="sd">        custom_colors: Sequence[str] | None. Custom colors for groups. (None)</span>
<span class="linenos" data-linenos="110 "></span><span class="sd">        figsize: tuple | None. Figure size (width, height). (None)</span>
<span class="linenos" data-linenos="111 "></span><span class="sd">        fontsize: int. Font size for labels and ticks. (13)</span>
<span class="linenos" data-linenos="112 "></span><span class="sd">        ticks_fontsize: int | None. Font size for axis ticks. If None, uses fontsize-1. (None)</span>
<span class="linenos" data-linenos="113 "></span><span class="sd">        **kwds: Additional keyword arguments passed to violinplot.</span>
<span class="linenos" data-linenos="114 "></span>
<span class="linenos" data-linenos="115 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="116 "></span><span class="sd">        ax: matplotlib.axes.Axes | None. A matplotlib axes object if `ax` is `None` else `None`.</span>
<span class="linenos" data-linenos="117 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="118 "></span>
<span class="linenos" data-linenos="119 "></span>    <span class="c1"># Handle AnnData availability</span>
<span class="linenos" data-linenos="120 "></span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">ANNDATA_AVAILABLE</span><span class="p">:</span>
<span class="linenos" data-linenos="121 "></span>        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">"AnnData is required for this function. Install with: pip install anndata"</span><span class="p">)</span>
<span class="linenos" data-linenos="122 "></span>
<span class="linenos" data-linenos="123 "></span>    <span class="c1"># Ensure keys is a list</span>
<span class="linenos" data-linenos="124 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="125 "></span>        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
<span class="linenos" data-linenos="126 "></span>    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>  <span class="c1"># remove duplicates, preserving order</span>
<span class="linenos" data-linenos="127 "></span>
<span class="linenos" data-linenos="128 "></span>    <span class="c1"># Handle ylabel</span>
<span class="linenos" data-linenos="129 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
<span class="linenos" data-linenos="130 "></span>        <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ylabel</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
<span class="linenos" data-linenos="131 "></span>    <span class="n">ylabel</span><span class="o">=</span><span class="n">keys</span>
<span class="linenos" data-linenos="132 "></span>
<span class="linenos" data-linenos="133 "></span>    <span class="c1"># Validate ylabel length</span>
<span class="linenos" data-linenos="134 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="135 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="136 "></span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected number of y-labels to be `1`, found `</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span><span class="si">}</span><span class="s2">`."</span><span class="p">)</span>
<span class="linenos" data-linenos="137 "></span>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
<span class="linenos" data-linenos="138 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected number of y-labels to be `</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">`, found `</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span><span class="si">}</span><span class="s2">`."</span><span class="p">)</span>
<span class="linenos" data-linenos="139 "></span>
<span class="linenos" data-linenos="140 "></span>    <span class="c1"># Extract data from AnnData object</span>
<span class="linenos" data-linenos="141 "></span>    <span class="n">obs_df</span> <span class="o">=</span> <span class="n">_extract_data_from_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">use_raw</span><span class="p">)</span>
<span class="linenos" data-linenos="142 "></span>
<span class="linenos" data-linenos="143 "></span>    <span class="c1"># Colorful data analysis and parameter optimization suggestions</span>
<span class="linenos" data-linenos="144 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">🎻 Violin Plot Analysis:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="145 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Total cells: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="146 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Variables to plot: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">keys</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="147 "></span>
<span class="linenos" data-linenos="148 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="149 "></span>        <span class="n">group_counts</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="150 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Groupby variable: '</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">groupby</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">' with </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">group_counts</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2"> groups</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="151 "></span>
<span class="linenos" data-linenos="152 "></span>        <span class="c1"># Show group distribution</span>
<span class="linenos" data-linenos="153 "></span>        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># Show top 10 groups</span>
<span class="linenos" data-linenos="154 "></span>            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="155 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span>
<span class="linenos" data-linenos="156 "></span>            <span class="k">elif</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
<span class="linenos" data-linenos="157 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span>
<span class="linenos" data-linenos="158 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="159 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span>
<span class="linenos" data-linenos="160 "></span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">• </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">count</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">color</span><span class="si">}</span><span class="s2"> cells</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="161 "></span>
<span class="linenos" data-linenos="162 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="163 "></span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">... and </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">group_counts</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2"> more groups</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="164 "></span>
<span class="linenos" data-linenos="165 "></span>        <span class="c1"># Check for imbalanced groups</span>
<span class="linenos" data-linenos="166 "></span>        <span class="n">min_count</span> <span class="o">=</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="linenos" data-linenos="167 "></span>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos" data-linenos="168 "></span>        <span class="k">if</span> <span class="n">max_count</span> <span class="o">/</span> <span class="n">min_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="169 "></span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">⚠️  Imbalanced groups detected: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">min_count</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_count</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2"> cells per group</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="170 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="171 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Groupby: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">None</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2"> (comparing variables)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="172 "></span>
<span class="linenos" data-linenos="173 "></span>    <span class="c1"># Analyze data distribution for each variable</span>
<span class="linenos" data-linenos="174 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📊 Data Distribution Analysis:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="175 "></span>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<span class="linenos" data-linenos="176 "></span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos" data-linenos="177 "></span>            <span class="n">data_vals</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="linenos" data-linenos="178 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="179 "></span>                <span class="n">data_range</span> <span class="o">=</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="linenos" data-linenos="180 "></span>                <span class="n">zero_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_vals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span>
<span class="linenos" data-linenos="181 "></span>
<span class="linenos" data-linenos="182 "></span>                <span class="c1"># Determine if data might be log-transformed already</span>
<span class="linenos" data-linenos="183 "></span>                <span class="n">log_suggestion</span> <span class="o">=</span> <span class="s2">""</span>
<span class="linenos" data-linenos="184 "></span>                <span class="k">if</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<span class="linenos" data-linenos="185 "></span>                    <span class="n">log_suggestion</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">(consider log=True)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="186 "></span>                <span class="k">elif</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="187 "></span>                    <span class="n">log_suggestion</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">(negative values detected)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="188 "></span>
<span class="linenos" data-linenos="189 "></span>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">'</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">': range </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">zero_fraction</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2"> zeros</span><span class="si">{</span><span class="n">log_suggestion</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="190 "></span>
<span class="linenos" data-linenos="191 "></span>    <span class="c1"># Display current function parameters</span>
<span class="linenos" data-linenos="192 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">⚙️  Current Function Parameters:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="193 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Plot style: enhanced_style=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">enhanced_style</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, stripplot=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">stripplot</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, jitter=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">jitter</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="194 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Additional features: show_means=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">show_means</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, show_boxplot=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">show_boxplot</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, statistical_tests=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">statistical_tests</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="195 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Figure settings: figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, fontsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fontsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, violin_alpha=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">violin_alpha</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="196 "></span>    <span class="k">if</span> <span class="n">custom_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="197 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Colors: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_colors</span><span class="p">)</span><span class="si">}</span><span class="s2"> custom colors specified</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="198 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="199 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Colors: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">Default palette</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="200 "></span>
<span class="linenos" data-linenos="201 "></span>    <span class="c1"># Parameter optimization suggestions</span>
<span class="linenos" data-linenos="202 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">💡 Parameter Optimization Suggestions:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="203 "></span>    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="204 "></span>
<span class="linenos" data-linenos="205 "></span>    <span class="c1"># Check for too many groups</span>
<span class="linenos" data-linenos="206 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="207 "></span>        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="208 "></span>        <span class="k">if</span> <span class="n">n_groups</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
<span class="linenos" data-linenos="209 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Many groups detected (</span><span class="si">{</span><span class="n">n_groups</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="210 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="211 "></span>            <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_groups</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="linenos" data-linenos="212 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">figsize</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">6</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="213 "></span>
<span class="linenos" data-linenos="214 "></span>            <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="215 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Consider adding: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">rotation=45</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> for better label readability"</span><span class="p">)</span>
<span class="linenos" data-linenos="216 "></span>
<span class="linenos" data-linenos="217 "></span>        <span class="c1"># Check for small sample sizes</span>
<span class="linenos" data-linenos="218 "></span>        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="219 "></span>            <span class="n">group_counts</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="220 "></span>            <span class="k">if</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="221 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Small sample sizes detected (min: </span><span class="si">{</span><span class="n">group_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="222 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">stripplot=True, jitter=0.3</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> to show individual points"</span><span class="p">)</span>
<span class="linenos" data-linenos="223 "></span>
<span class="linenos" data-linenos="224 "></span>    <span class="c1"># Check data distribution and log scale</span>
<span class="linenos" data-linenos="225 "></span>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<span class="linenos" data-linenos="226 "></span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos" data-linenos="227 "></span>            <span class="n">data_vals</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="linenos" data-linenos="228 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<span class="linenos" data-linenos="229 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Wide data range for '</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">' (</span><span class="si">{</span><span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x):</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="230 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: log=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">log</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="231 "></span>                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">log=True</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> for better visualization"</span><span class="p">)</span>
<span class="linenos" data-linenos="232 "></span>                <span class="k">break</span>
<span class="linenos" data-linenos="233 "></span>
<span class="linenos" data-linenos="234 "></span>    <span class="c1"># Check figure size vs number of variables</span>
<span class="linenos" data-linenos="235 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos" data-linenos="236 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Multiple variables with small figure:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="237 "></span>        <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="linenos" data-linenos="238 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="239 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}</span><span class="s2">, 6)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">multi_panel=True</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="240 "></span>
<span class="linenos" data-linenos="241 "></span>    <span class="c1"># Font size optimization</span>
<span class="linenos" data-linenos="242 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="243 "></span>        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="244 "></span>        <span class="n">max_label_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="245 "></span>        <span class="k">if</span> <span class="n">max_label_length</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">fontsize</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
<span class="linenos" data-linenos="246 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Long group labels detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="247 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: fontsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fontsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="248 "></span>            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">fontsize=10, rotation=45</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="249 "></span>
<span class="linenos" data-linenos="250 "></span>    <span class="c1"># Enhanced features suggestions</span>
<span class="linenos" data-linenos="251 "></span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_means</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">show_boxplot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">statistical_tests</span><span class="p">:</span>
<span class="linenos" data-linenos="252 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">▶ Consider enhancing your plot:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="253 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Options: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">show_means=True</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">show_boxplot=True</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">, or </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">statistical_tests=True</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="254 "></span>
<span class="linenos" data-linenos="255 "></span>    <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="256 "></span>        <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="257 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
<span class="linenos" data-linenos="258 "></span>
<span class="linenos" data-linenos="259 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📋 Copy-paste ready function call:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="260 "></span>
<span class="linenos" data-linenos="261 "></span>        <span class="c1"># Generate optimized function call</span>
<span class="linenos" data-linenos="262 "></span>        <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="263 "></span>
<span class="linenos" data-linenos="264 "></span>        <span class="c1"># Core parameters</span>
<span class="linenos" data-linenos="265 "></span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="266 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"adata, keys='</span><span class="si">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos" data-linenos="267 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="268 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"adata, keys=</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="269 "></span>
<span class="linenos" data-linenos="270 "></span>        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="271 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"groupby='</span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos" data-linenos="272 "></span>
<span class="linenos" data-linenos="273 "></span>        <span class="c1"># Add optimized parameters based on suggestions</span>
<span class="linenos" data-linenos="274 "></span>        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="275 "></span>            <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="276 "></span>            <span class="k">if</span> <span class="n">n_groups</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
<span class="linenos" data-linenos="277 "></span>                <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_groups</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="linenos" data-linenos="278 "></span>                <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"figsize=(</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}</span><span class="s2">, 6)"</span><span class="p">)</span>
<span class="linenos" data-linenos="279 "></span>
<span class="linenos" data-linenos="280 "></span>            <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_groups</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos" data-linenos="281 "></span>                <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"rotation=45"</span><span class="p">)</span>
<span class="linenos" data-linenos="282 "></span>
<span class="linenos" data-linenos="283 "></span>            <span class="n">group_counts</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="284 "></span>            <span class="k">if</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="285 "></span>                <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"stripplot=True"</span><span class="p">)</span>
<span class="linenos" data-linenos="286 "></span>                <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"jitter=0.3"</span><span class="p">)</span>
<span class="linenos" data-linenos="287 "></span>
<span class="linenos" data-linenos="288 "></span>        <span class="c1"># Check for log scale suggestion</span>
<span class="linenos" data-linenos="289 "></span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<span class="linenos" data-linenos="290 "></span>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos" data-linenos="291 "></span>                <span class="n">data_vals</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="linenos" data-linenos="292 "></span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">data_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<span class="linenos" data-linenos="293 "></span>                    <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"log=True"</span><span class="p">)</span>
<span class="linenos" data-linenos="294 "></span>                    <span class="k">break</span>
<span class="linenos" data-linenos="295 "></span>
<span class="linenos" data-linenos="296 "></span>        <span class="c1"># Multi-panel suggestion</span>
<span class="linenos" data-linenos="297 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos" data-linenos="298 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"multi_panel=True"</span><span class="p">)</span>
<span class="linenos" data-linenos="299 "></span>
<span class="linenos" data-linenos="300 "></span>        <span class="c1"># Enhanced features</span>
<span class="linenos" data-linenos="301 "></span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_means</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">show_boxplot</span><span class="p">:</span>
<span class="linenos" data-linenos="302 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"show_means=True"</span><span class="p">)</span>
<span class="linenos" data-linenos="303 "></span>
<span class="linenos" data-linenos="304 "></span>        <span class="n">optimized_call</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">ov.pl.violin(</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">optimized_params</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="305 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">optimized_call</span><span class="p">)</span>
<span class="linenos" data-linenos="306 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="307 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✅ Current parameters are optimal for your data!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="308 "></span>
<span class="linenos" data-linenos="309 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}{</span><span class="s1">'─'</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="310 "></span>
<span class="linenos" data-linenos="311 "></span>    <span class="c1"># Prepare data for plotting</span>
<span class="linenos" data-linenos="312 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="313 "></span>        <span class="n">obs_tidy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">obs_df</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<span class="linenos" data-linenos="314 "></span>        <span class="n">x_col</span> <span class="o">=</span> <span class="s2">"variable"</span>
<span class="linenos" data-linenos="315 "></span>        <span class="n">y_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"value"</span><span class="p">]</span>
<span class="linenos" data-linenos="316 "></span>        <span class="n">group_categories</span> <span class="o">=</span> <span class="n">keys</span>
<span class="linenos" data-linenos="317 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="318 "></span>        <span class="n">obs_tidy</span> <span class="o">=</span> <span class="n">obs_df</span>
<span class="linenos" data-linenos="319 "></span>        <span class="n">x_col</span> <span class="o">=</span> <span class="n">groupby</span>
<span class="linenos" data-linenos="320 "></span>        <span class="n">y_cols</span> <span class="o">=</span> <span class="n">keys</span>
<span class="linenos" data-linenos="321 "></span>        <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="linenos" data-linenos="322 "></span>        <span class="n">group_categories</span> <span class="o">=</span> <span class="n">obs_df</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span> <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">order</span>
<span class="linenos" data-linenos="323 "></span>
<span class="linenos" data-linenos="324 "></span>    <span class="c1"># Set up colors</span>
<span class="linenos" data-linenos="325 "></span>    <span class="n">colors</span> <span class="o">=</span> <span class="n">_setup_colors</span><span class="p">(</span><span class="n">custom_colors</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
<span class="linenos" data-linenos="326 "></span>
<span class="linenos" data-linenos="327 "></span>    <span class="c1"># Handle multi-panel case</span>
<span class="linenos" data-linenos="328 "></span>    <span class="k">if</span> <span class="n">multi_panel</span> <span class="ow">and</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="329 "></span>        <span class="k">return</span> <span class="n">_create_multi_panel_plot</span><span class="p">(</span>
<span class="linenos" data-linenos="330 "></span>            <span class="n">obs_tidy</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">y_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">stripplot</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> 
<span class="linenos" data-linenos="331 "></span>            <span class="n">size</span><span class="p">,</span> <span class="n">density_norm</span><span class="p">,</span> <span class="n">enhanced_style</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span>
<span class="linenos" data-linenos="332 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="333 "></span>
<span class="linenos" data-linenos="334 "></span>    <span class="c1"># Create single or multiple axis plots</span>
<span class="linenos" data-linenos="335 "></span>    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="336 "></span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="337 "></span>    <span class="k">elif</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="338 "></span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="linenos" data-linenos="339 "></span>
<span class="linenos" data-linenos="340 "></span>    <span class="c1"># Apply enhanced styling</span>
<span class="linenos" data-linenos="341 "></span>    <span class="k">if</span> <span class="n">enhanced_style</span><span class="p">:</span>
<span class="linenos" data-linenos="342 "></span>        <span class="n">_apply_enhanced_styling</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">background_color</span><span class="p">,</span> <span class="n">spine_color</span><span class="p">,</span> <span class="n">grid_lines</span><span class="p">)</span>
<span class="linenos" data-linenos="343 "></span>
<span class="linenos" data-linenos="344 "></span>    <span class="c1"># Create plots for each y variable</span>
<span class="linenos" data-linenos="345 "></span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">y_col</span><span class="p">,</span> <span class="n">y_label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">y_cols</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">)):</span>
<span class="linenos" data-linenos="346 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="347 "></span>            <span class="c1"># Create subplots for multiple keys</span>
<span class="linenos" data-linenos="348 "></span>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="349 "></span>                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
<span class="linenos" data-linenos="350 "></span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="351 "></span>                    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
<span class="linenos" data-linenos="352 "></span>            <span class="n">current_ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ax</span>
<span class="linenos" data-linenos="353 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="354 "></span>            <span class="n">current_ax</span> <span class="o">=</span> <span class="n">ax</span>
<span class="linenos" data-linenos="355 "></span>
<span class="linenos" data-linenos="356 "></span>        <span class="c1"># Prepare data for current y variable</span>
<span class="linenos" data-linenos="357 "></span>        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">_prepare_plot_data</span><span class="p">(</span><span class="n">obs_tidy</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
<span class="linenos" data-linenos="358 "></span>
<span class="linenos" data-linenos="359 "></span>        <span class="c1"># Create violin plots</span>
<span class="linenos" data-linenos="360 "></span>        <span class="n">_create_violin_plots</span><span class="p">(</span>
<span class="linenos" data-linenos="361 "></span>            <span class="n">current_ax</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">density_norm</span><span class="p">,</span> 
<span class="linenos" data-linenos="362 "></span>            <span class="n">violin_alpha</span><span class="p">,</span> <span class="n">enhanced_style</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span>
<span class="linenos" data-linenos="363 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="364 "></span>
<span class="linenos" data-linenos="365 "></span>        <span class="c1"># Add box plots if requested</span>
<span class="linenos" data-linenos="366 "></span>        <span class="k">if</span> <span class="n">show_boxplot</span><span class="p">:</span>
<span class="linenos" data-linenos="367 "></span>            <span class="n">_add_box_plots</span><span class="p">(</span><span class="n">current_ax</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">)</span>
<span class="linenos" data-linenos="368 "></span>
<span class="linenos" data-linenos="369 "></span>        <span class="c1"># Add strip plot (jittered points)</span>
<span class="linenos" data-linenos="370 "></span>        <span class="k">if</span> <span class="n">stripplot</span><span class="p">:</span>
<span class="linenos" data-linenos="371 "></span>            <span class="n">_add_strip_plot</span><span class="p">(</span>
<span class="linenos" data-linenos="372 "></span>                <span class="n">current_ax</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">jitter_method</span><span class="p">,</span> 
<span class="linenos" data-linenos="373 "></span>                <span class="n">size</span><span class="p">,</span> <span class="n">jitter_alpha</span><span class="p">,</span> <span class="n">colors</span>
<span class="linenos" data-linenos="374 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="375 "></span>
<span class="linenos" data-linenos="376 "></span>        <span class="c1"># Add mean annotations</span>
<span class="linenos" data-linenos="377 "></span>        <span class="k">if</span> <span class="n">show_means</span><span class="p">:</span>
<span class="linenos" data-linenos="378 "></span>            <span class="n">_add_mean_annotations</span><span class="p">(</span><span class="n">current_ax</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">)</span>
<span class="linenos" data-linenos="379 "></span>
<span class="linenos" data-linenos="380 "></span>        <span class="c1"># Add statistical tests</span>
<span class="linenos" data-linenos="381 "></span>        <span class="k">if</span> <span class="n">statistical_tests</span><span class="p">:</span>
<span class="linenos" data-linenos="382 "></span>            <span class="n">_add_statistical_tests</span><span class="p">(</span><span class="n">current_ax</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">)</span>
<span class="linenos" data-linenos="383 "></span>
<span class="linenos" data-linenos="384 "></span>        <span class="c1"># Customize axis</span>
<span class="linenos" data-linenos="385 "></span>        <span class="n">_customize_axis</span><span class="p">(</span>
<span class="linenos" data-linenos="386 "></span>            <span class="n">current_ax</span><span class="p">,</span> <span class="n">group_categories</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> 
<span class="linenos" data-linenos="387 "></span>            <span class="n">rotation</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">order</span>
<span class="linenos" data-linenos="388 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="389 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="390 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="391 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="392 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="393 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="394 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="395 "></span>        <span class="k">if</span> <span class="n">ticks_fontsize</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="396 "></span>            <span class="n">ticks_fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span>
<span class="linenos" data-linenos="397 "></span>
<span class="linenos" data-linenos="398 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">current_ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
<span class="linenos" data-linenos="399 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">current_ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="400 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="401 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="402 "></span>        <span class="c1">#print(y_label)</span>
<span class="linenos" data-linenos="403 "></span>
<span class="linenos" data-linenos="404 "></span>    <span class="c1">#plt.tight_layout()</span>
<span class="linenos" data-linenos="405 "></span>
<span class="linenos" data-linenos="406 "></span>        <span class="n">current_ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="407 "></span>
<span class="linenos" data-linenos="408 "></span>
<span class="linenos" data-linenos="409 "></span>
<span class="linenos" data-linenos="410 "></span>    <span class="c1"># Save figure if requested</span>
<span class="linenos" data-linenos="411 "></span>    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
<span class="linenos" data-linenos="412 "></span>        <span class="n">save_path</span> <span class="o">=</span> <span class="n">save</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">"violin_plot.pdf"</span>
<span class="linenos" data-linenos="413 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<span class="linenos" data-linenos="414 "></span>
<span class="linenos" data-linenos="415 "></span>    <span class="c1"># Show figure if requested</span>
<span class="linenos" data-linenos="416 "></span>    <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">show</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos" data-linenos="417 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos" data-linenos="418 "></span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos" data-linenos="419 "></span>
<span class="linenos" data-linenos="420 "></span>    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div><h2 id="dot-plots">Dot Plots<a class="headerlink" href="#dot-plots" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.dotplot">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">dotplot</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_categories</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">categories_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expression_cutoff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mean_only_expressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standard_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar_title</span><span class="o">=</span><span class="s1">'Mean expression</span><span class="se">\n</span><span class="s1">in group'</span><span class="p">,</span> <span class="n">size_title</span><span class="o">=</span><span class="s1">'Fraction of cells</span><span class="se">\n</span><span class="s1">in group (%)'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gene_symbols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_group_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_group_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_group_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swap_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dot_color_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Reds'</span><span class="p">,</span> <span class="n">dot_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smallest_dot</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">preserve_dict_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.dotplot" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Make a dot plot of the expression values of <code>var_names</code>.</p>
<p>For each var_name and each <code>groupby</code> category a dot is plotted.
Each dot represents two values: mean expression within each category
(visualized by color) and fraction of cells expressing the <code>var_name</code> in the
category (visualized by the size of the dot).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>AnnData
Annotated data matrix.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>var_names</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="omicverse.pl._dotplot._VarNames">_VarNames</span>, <span title="typing.Mapping">Mapping</span>[str, <span title="omicverse.pl._dotplot._VarNames">_VarNames</span>]]</code>
</td>
<td><p>str or list of str or dict
Variables to plot.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>groupby</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>str or list of str
The key of the observation grouping to consider.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>use_raw</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool, optional (default=None)
Use <code>raw</code> attribute of <code>adata</code> if present.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>log</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool, optional (default=False)
Whether to log-transform the data.</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>num_categories</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=7)
Number of categories to show.</p></td>
<td>
<code>7</code>
</td>
</tr>
<tr>
<td><code>categories_order</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>list of str, optional (default=None)
Order of categories to display.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>expression_cutoff</code></td>
<td>
<code>float</code>
</td>
<td><p>float, optional (default=0.0)
Expression cutoff for calculating fraction of expressing cells.</p></td>
<td>
<code>0.0</code>
</td>
</tr>
<tr>
<td><code>mean_only_expressed</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool, optional (default=False)
Whether to calculate mean only for expressing cells.</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>standard_scale</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Literal">Literal</span>['var', 'group']]</code>
</td>
<td><p>{'var', 'group'} or None, optional (default=None)
Whether to standardize data.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str, optional (default=None)
Title for the plot.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>colorbar_title</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str, optional (default='Mean expression\nin group')
Title for the color bar.</p></td>
<td>
<code>'Mean expression\nin group'</code>
</td>
</tr>
<tr>
<td><code>size_title</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str, optional (default='Fraction of cells\nin group (%)')
Title for the size legend.</p></td>
<td>
<code>'Fraction of cells\nin group (%)'</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[float, float]]</code>
</td>
<td><p>tuple, optional (default=None)
Figure size (width, height) in inches. If provided, the plot dimensions will be scaled accordingly.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>dendrogram</code></td>
<td>
<code><span title="typing.Union">Union</span>[bool, str]</code>
</td>
<td><p>bool or str, optional (default=False)
Whether to add dendrogram to the plot.</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>gene_symbols</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str, optional (default=None)
Key for gene symbols in <code>adata.var</code>.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>var_group_positions</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[<span title="typing.Tuple">Tuple</span>[int, int]]]</code>
</td>
<td><p>list of tuples, optional (default=None)
Positions for variable groups.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>var_group_labels</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>list of str, optional (default=None)
Labels for variable groups.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>var_group_rotation</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Rotation angle for variable group labels.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>layer</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>str, optional (default=None)
Layer to use for expression data.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>swap_axes</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool, optional (default=False)
Whether to swap x and y axes.</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>dot_color_df</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span>]</code>
</td>
<td><p>pandas.DataFrame, optional (default=None)
DataFrame for dot colors.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>show</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool, optional (default=None)
Whether to show the plot.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>save</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[str, bool]]</code>
</td>
<td><p>str or bool, optional (default=None)
Whether to save the plot.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="matplotlib.axes.Axes">_AxesSubplot</span>]</code>
</td>
<td><p>matplotlib.axes.Axes, optional (default=None)
Axes object to plot on.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>return_fig</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>bool, optional (default=False)
Whether to return the figure object.</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>vmin</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Minimum value for color scaling.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>vmax</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Maximum value for color scaling.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>vcenter</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Center value for diverging colormap.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>norm</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="matplotlib.colors.Normalize">Normalize</span>]</code>
</td>
<td><p>matplotlib.colors.Normalize, optional (default=None)
Normalization object for colors.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>cmap</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.colors.Colormap">Colormap</span>, str, None]</code>
</td>
<td><p>str or matplotlib.colors.Colormap, optional (default='Reds')
Colormap for the plot.</p></td>
<td>
<code>'Reds'</code>
</td>
</tr>
<tr>
<td><code>dot_max</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Maximum dot size.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>dot_min</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>float, optional (default=None)
Minimum dot size.</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>smallest_dot</code></td>
<td>
<code>float</code>
</td>
<td><p>float, optional (default=0.0)
Size of the smallest dot.</p></td>
<td>
<code>0.0</code>
</td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=12)
Font size for labels and legends. Titles will be one point larger.</p></td>
<td>
<code>12</code>
</td>
</tr>
<tr>
<td><code>preserve_dict_order</code></td>
<td>
<code>bool</code>
</td>
<td><p>bool, optional (default=False)
When var_names is a dictionary, whether to preserve the original dictionary order.
If True, genes will be ordered according to the dictionary's insertion order.
If False (default), genes will be ordered according to cell type categories.</p></td>
<td>
<code>False</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Dict">Dict</span>, DotPlot]]</code>
</td>
<td><p>If <code>return_fig</code> is True, returns the figure object.</p></td>
</tr>
<tr>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Dict">Dict</span>, DotPlot]]</code>
</td>
<td><p>If <code>show</code> is False, returns axes dictionary.</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_dotplot.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 16 "></span><span class="k">def</span> <span class="nf">dotplot</span><span class="p">(</span>
<span class="linenos" data-linenos=" 17 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos=" 18 "></span>    <span class="n">var_names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VarNames</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_VarNames</span><span class="p">]],</span>
<span class="linenos" data-linenos=" 19 "></span>    <span class="n">groupby</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="linenos" data-linenos=" 20 "></span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos" data-linenos=" 21 "></span>    <span class="n">use_raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 22 "></span>    <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 23 "></span>    <span class="n">num_categories</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="linenos" data-linenos=" 24 "></span>    <span class="n">categories_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 25 "></span>    <span class="n">expression_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 26 "></span>    <span class="n">mean_only_expressed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 27 "></span>    <span class="n">standard_scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'var'</span><span class="p">,</span> <span class="s1">'group'</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 28 "></span>    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 29 "></span>    <span class="n">colorbar_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Mean expression</span><span class="se">\n</span><span class="s1">in group'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 30 "></span>    <span class="n">size_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Fraction of cells</span><span class="se">\n</span><span class="s1">in group (%)'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 31 "></span>    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 32 "></span>    <span class="n">dendrogram</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 33 "></span>    <span class="n">gene_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 34 "></span>    <span class="n">var_group_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 35 "></span>    <span class="n">var_group_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 36 "></span>    <span class="n">var_group_rotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 37 "></span>    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 38 "></span>    <span class="n">swap_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 39 "></span>    <span class="n">dot_color_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 40 "></span>    <span class="n">show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 41 "></span>    <span class="n">save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 42 "></span>    <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AxesSubplot</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 43 "></span>    <span class="n">return_fig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 44 "></span>    <span class="n">vmin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 45 "></span>    <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 46 "></span>    <span class="n">vcenter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 47 "></span>    <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Normalize</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 48 "></span>    <span class="n">cmap</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Reds'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 49 "></span>    <span class="n">dot_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 50 "></span>    <span class="n">dot_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 51 "></span>    <span class="n">smallest_dot</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 52 "></span>    <span class="n">fontsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="linenos" data-linenos=" 53 "></span>    <span class="n">preserve_dict_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 54 "></span>    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="linenos" data-linenos=" 55 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="s1">'DotPlot'</span><span class="p">]]:</span>
<span class="linenos" data-linenos=" 56 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 57 "></span><span class="sd">    Make a dot plot of the expression values of `var_names`.</span>
<span class="linenos" data-linenos=" 58 "></span>
<span class="linenos" data-linenos=" 59 "></span><span class="sd">    For each var_name and each `groupby` category a dot is plotted.</span>
<span class="linenos" data-linenos=" 60 "></span><span class="sd">    Each dot represents two values: mean expression within each category</span>
<span class="linenos" data-linenos=" 61 "></span><span class="sd">    (visualized by color) and fraction of cells expressing the `var_name` in the</span>
<span class="linenos" data-linenos=" 62 "></span><span class="sd">    category (visualized by the size of the dot).</span>
<span class="linenos" data-linenos=" 63 "></span>
<span class="linenos" data-linenos=" 64 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 65 "></span><span class="sd">        adata: AnnData</span>
<span class="linenos" data-linenos=" 66 "></span><span class="sd">            Annotated data matrix.</span>
<span class="linenos" data-linenos=" 67 "></span><span class="sd">        var_names: str or list of str or dict</span>
<span class="linenos" data-linenos=" 68 "></span><span class="sd">            Variables to plot.</span>
<span class="linenos" data-linenos=" 69 "></span><span class="sd">        groupby: str or list of str</span>
<span class="linenos" data-linenos=" 70 "></span><span class="sd">            The key of the observation grouping to consider.</span>
<span class="linenos" data-linenos=" 71 "></span><span class="sd">        use_raw: bool, optional (default=None)</span>
<span class="linenos" data-linenos=" 72 "></span><span class="sd">            Use `raw` attribute of `adata` if present.</span>
<span class="linenos" data-linenos=" 73 "></span><span class="sd">        log: bool, optional (default=False)</span>
<span class="linenos" data-linenos=" 74 "></span><span class="sd">            Whether to log-transform the data.</span>
<span class="linenos" data-linenos=" 75 "></span><span class="sd">        num_categories: int, optional (default=7)</span>
<span class="linenos" data-linenos=" 76 "></span><span class="sd">            Number of categories to show.</span>
<span class="linenos" data-linenos=" 77 "></span><span class="sd">        categories_order: list of str, optional (default=None)</span>
<span class="linenos" data-linenos=" 78 "></span><span class="sd">            Order of categories to display.</span>
<span class="linenos" data-linenos=" 79 "></span><span class="sd">        expression_cutoff: float, optional (default=0.0)</span>
<span class="linenos" data-linenos=" 80 "></span><span class="sd">            Expression cutoff for calculating fraction of expressing cells.</span>
<span class="linenos" data-linenos=" 81 "></span><span class="sd">        mean_only_expressed: bool, optional (default=False)</span>
<span class="linenos" data-linenos=" 82 "></span><span class="sd">            Whether to calculate mean only for expressing cells.</span>
<span class="linenos" data-linenos=" 83 "></span><span class="sd">        standard_scale: {'var', 'group'} or None, optional (default=None)</span>
<span class="linenos" data-linenos=" 84 "></span><span class="sd">            Whether to standardize data.</span>
<span class="linenos" data-linenos=" 85 "></span><span class="sd">        title: str, optional (default=None)</span>
<span class="linenos" data-linenos=" 86 "></span><span class="sd">            Title for the plot.</span>
<span class="linenos" data-linenos=" 87 "></span><span class="sd">        colorbar_title: str, optional (default='Mean expression\nin group')</span>
<span class="linenos" data-linenos=" 88 "></span><span class="sd">            Title for the color bar.</span>
<span class="linenos" data-linenos=" 89 "></span><span class="sd">        size_title: str, optional (default='Fraction of cells\nin group (%)')</span>
<span class="linenos" data-linenos=" 90 "></span><span class="sd">            Title for the size legend.</span>
<span class="linenos" data-linenos=" 91 "></span><span class="sd">        figsize: tuple, optional (default=None)</span>
<span class="linenos" data-linenos=" 92 "></span><span class="sd">            Figure size (width, height) in inches. If provided, the plot dimensions will be scaled accordingly.</span>
<span class="linenos" data-linenos=" 93 "></span><span class="sd">        dendrogram: bool or str, optional (default=False)</span>
<span class="linenos" data-linenos=" 94 "></span><span class="sd">            Whether to add dendrogram to the plot.</span>
<span class="linenos" data-linenos=" 95 "></span><span class="sd">        gene_symbols: str, optional (default=None)</span>
<span class="linenos" data-linenos=" 96 "></span><span class="sd">            Key for gene symbols in `adata.var`.</span>
<span class="linenos" data-linenos=" 97 "></span><span class="sd">        var_group_positions: list of tuples, optional (default=None)</span>
<span class="linenos" data-linenos=" 98 "></span><span class="sd">            Positions for variable groups.</span>
<span class="linenos" data-linenos=" 99 "></span><span class="sd">        var_group_labels: list of str, optional (default=None)</span>
<span class="linenos" data-linenos="100 "></span><span class="sd">            Labels for variable groups.</span>
<span class="linenos" data-linenos="101 "></span><span class="sd">        var_group_rotation: float, optional (default=None)</span>
<span class="linenos" data-linenos="102 "></span><span class="sd">            Rotation angle for variable group labels.</span>
<span class="linenos" data-linenos="103 "></span><span class="sd">        layer: str, optional (default=None)</span>
<span class="linenos" data-linenos="104 "></span><span class="sd">            Layer to use for expression data.</span>
<span class="linenos" data-linenos="105 "></span><span class="sd">        swap_axes: bool, optional (default=False)</span>
<span class="linenos" data-linenos="106 "></span><span class="sd">            Whether to swap x and y axes.</span>
<span class="linenos" data-linenos="107 "></span><span class="sd">        dot_color_df: pandas.DataFrame, optional (default=None)</span>
<span class="linenos" data-linenos="108 "></span><span class="sd">            DataFrame for dot colors.</span>
<span class="linenos" data-linenos="109 "></span><span class="sd">        show: bool, optional (default=None)</span>
<span class="linenos" data-linenos="110 "></span><span class="sd">            Whether to show the plot.</span>
<span class="linenos" data-linenos="111 "></span><span class="sd">        save: str or bool, optional (default=None)</span>
<span class="linenos" data-linenos="112 "></span><span class="sd">            Whether to save the plot.</span>
<span class="linenos" data-linenos="113 "></span><span class="sd">        ax: matplotlib.axes.Axes, optional (default=None)</span>
<span class="linenos" data-linenos="114 "></span><span class="sd">            Axes object to plot on.</span>
<span class="linenos" data-linenos="115 "></span><span class="sd">        return_fig: bool, optional (default=False)</span>
<span class="linenos" data-linenos="116 "></span><span class="sd">            Whether to return the figure object.</span>
<span class="linenos" data-linenos="117 "></span><span class="sd">        vmin: float, optional (default=None)</span>
<span class="linenos" data-linenos="118 "></span><span class="sd">            Minimum value for color scaling.</span>
<span class="linenos" data-linenos="119 "></span><span class="sd">        vmax: float, optional (default=None)</span>
<span class="linenos" data-linenos="120 "></span><span class="sd">            Maximum value for color scaling.</span>
<span class="linenos" data-linenos="121 "></span><span class="sd">        vcenter: float, optional (default=None)</span>
<span class="linenos" data-linenos="122 "></span><span class="sd">            Center value for diverging colormap.</span>
<span class="linenos" data-linenos="123 "></span><span class="sd">        norm: matplotlib.colors.Normalize, optional (default=None)</span>
<span class="linenos" data-linenos="124 "></span><span class="sd">            Normalization object for colors.</span>
<span class="linenos" data-linenos="125 "></span><span class="sd">        cmap: str or matplotlib.colors.Colormap, optional (default='Reds')</span>
<span class="linenos" data-linenos="126 "></span><span class="sd">            Colormap for the plot.</span>
<span class="linenos" data-linenos="127 "></span><span class="sd">        dot_max: float, optional (default=None)</span>
<span class="linenos" data-linenos="128 "></span><span class="sd">            Maximum dot size.</span>
<span class="linenos" data-linenos="129 "></span><span class="sd">        dot_min: float, optional (default=None)</span>
<span class="linenos" data-linenos="130 "></span><span class="sd">            Minimum dot size.</span>
<span class="linenos" data-linenos="131 "></span><span class="sd">        smallest_dot: float, optional (default=0.0)</span>
<span class="linenos" data-linenos="132 "></span><span class="sd">            Size of the smallest dot.</span>
<span class="linenos" data-linenos="133 "></span><span class="sd">        fontsize: int, optional (default=12)</span>
<span class="linenos" data-linenos="134 "></span><span class="sd">            Font size for labels and legends. Titles will be one point larger.</span>
<span class="linenos" data-linenos="135 "></span><span class="sd">        preserve_dict_order: bool, optional (default=False)</span>
<span class="linenos" data-linenos="136 "></span><span class="sd">            When var_names is a dictionary, whether to preserve the original dictionary order.</span>
<span class="linenos" data-linenos="137 "></span><span class="sd">            If True, genes will be ordered according to the dictionary's insertion order.</span>
<span class="linenos" data-linenos="138 "></span><span class="sd">            If False (default), genes will be ordered according to cell type categories.</span>
<span class="linenos" data-linenos="139 "></span>
<span class="linenos" data-linenos="140 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="141 "></span><span class="sd">        If `return_fig` is True, returns the figure object.</span>
<span class="linenos" data-linenos="142 "></span><span class="sd">        If `show` is False, returns axes dictionary.</span>
<span class="linenos" data-linenos="143 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="144 "></span>    <span class="c1"># Convert var_names to list if string</span>
<span class="linenos" data-linenos="145 "></span>    <span class="n">original_var_names_dict</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="146 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="147 "></span>        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_names</span><span class="p">]</span>
<span class="linenos" data-linenos="148 "></span>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="linenos" data-linenos="149 "></span>        <span class="c1"># Save original dictionary reference for color bar ordering</span>
<span class="linenos" data-linenos="150 "></span>        <span class="k">if</span> <span class="n">preserve_dict_order</span><span class="p">:</span>
<span class="linenos" data-linenos="151 "></span>            <span class="n">original_var_names_dict</span> <span class="o">=</span> <span class="n">var_names</span>
<span class="linenos" data-linenos="152 "></span>
<span class="linenos" data-linenos="153 "></span>        <span class="c1"># Get gene groups</span>
<span class="linenos" data-linenos="154 "></span>        <span class="n">gene_groups</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="155 "></span>        <span class="n">var_names_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="156 "></span>
<span class="linenos" data-linenos="157 "></span>        <span class="k">if</span> <span class="n">preserve_dict_order</span><span class="p">:</span>
<span class="linenos" data-linenos="158 "></span>            <span class="c1"># Preserve the original dictionary order</span>
<span class="linenos" data-linenos="159 "></span>            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">genes</span> <span class="ow">in</span> <span class="n">var_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos" data-linenos="160 "></span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="161 "></span>                    <span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">genes</span><span class="p">]</span>
<span class="linenos" data-linenos="162 "></span>                <span class="n">var_names_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
<span class="linenos" data-linenos="163 "></span>                <span class="n">gene_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">group</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span>
<span class="linenos" data-linenos="164 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="165 "></span>            <span class="c1"># Get cell type order (original behavior)</span>
<span class="linenos" data-linenos="166 "></span>            <span class="k">if</span> <span class="n">categories_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="167 "></span>                <span class="n">group_order</span> <span class="o">=</span> <span class="n">categories_order</span>
<span class="linenos" data-linenos="168 "></span>            <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]):</span>
<span class="linenos" data-linenos="169 "></span>                <span class="n">group_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
<span class="linenos" data-linenos="170 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="171 "></span>                <span class="n">group_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="172 "></span>
<span class="linenos" data-linenos="173 "></span>            <span class="c1"># Order gene groups according to cell types</span>
<span class="linenos" data-linenos="174 "></span>            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">group_order</span><span class="p">:</span>
<span class="linenos" data-linenos="175 "></span>                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
<span class="linenos" data-linenos="176 "></span>                    <span class="n">genes</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
<span class="linenos" data-linenos="177 "></span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="178 "></span>                        <span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">genes</span><span class="p">]</span>
<span class="linenos" data-linenos="179 "></span>                    <span class="n">var_names_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
<span class="linenos" data-linenos="180 "></span>                    <span class="n">gene_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">group</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span>
<span class="linenos" data-linenos="181 "></span>
<span class="linenos" data-linenos="182 "></span>            <span class="c1"># Add any remaining groups that weren't in the cell types</span>
<span class="linenos" data-linenos="183 "></span>            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">genes</span> <span class="ow">in</span> <span class="n">var_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos" data-linenos="184 "></span>                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_order</span><span class="p">:</span>
<span class="linenos" data-linenos="185 "></span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="186 "></span>                        <span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">genes</span><span class="p">]</span>
<span class="linenos" data-linenos="187 "></span>                    <span class="n">var_names_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
<span class="linenos" data-linenos="188 "></span>                    <span class="n">gene_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">group</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span>
<span class="linenos" data-linenos="189 "></span>
<span class="linenos" data-linenos="190 "></span>        <span class="n">var_names</span> <span class="o">=</span> <span class="n">var_names_list</span>
<span class="linenos" data-linenos="191 "></span>
<span class="linenos" data-linenos="192 "></span>    <span class="c1"># Get expression matrix</span>
<span class="linenos" data-linenos="193 "></span>    <span class="k">if</span> <span class="n">use_raw</span> <span class="ow">and</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="194 "></span>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span>
<span class="linenos" data-linenos="195 "></span>        <span class="n">var_names_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">]</span>
<span class="linenos" data-linenos="196 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="197 "></span>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
<span class="linenos" data-linenos="198 "></span>        <span class="n">var_names_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">]</span>
<span class="linenos" data-linenos="199 "></span>
<span class="linenos" data-linenos="200 "></span>    <span class="c1"># Determine category order</span>
<span class="linenos" data-linenos="201 "></span>    <span class="k">if</span> <span class="n">categories_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="202 "></span>        <span class="n">cats</span> <span class="o">=</span> <span class="n">categories_order</span>
<span class="linenos" data-linenos="203 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="204 "></span>        <span class="c1"># Use the categorical order from adata if available</span>
<span class="linenos" data-linenos="205 "></span>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]):</span>
<span class="linenos" data-linenos="206 "></span>            <span class="n">cats</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
<span class="linenos" data-linenos="207 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="208 "></span>            <span class="c1"># If not categorical, get unique values</span>
<span class="linenos" data-linenos="209 "></span>            <span class="n">cats</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="linenos" data-linenos="210 "></span>
<span class="linenos" data-linenos="211 "></span>    <span class="c1"># Get aggregated data with specified order</span>
<span class="linenos" data-linenos="212 "></span>    <span class="n">agg</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span>
<span class="linenos" data-linenos="213 "></span>    <span class="n">cell_counts</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="linenos" data-linenos="214 "></span>
<span class="linenos" data-linenos="215 "></span>    <span class="c1"># Get colors for cell types if available</span>
<span class="linenos" data-linenos="216 "></span>    <span class="n">cell_colors</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="217 "></span>    <span class="n">color_dict</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="218 "></span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="219 "></span>        <span class="n">color_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2">_colors"</span>
<span class="linenos" data-linenos="220 "></span>        <span class="k">if</span> <span class="n">color_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
<span class="linenos" data-linenos="221 "></span>            <span class="n">colors</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">color_key</span><span class="p">]</span>
<span class="linenos" data-linenos="222 "></span>            <span class="c1"># Create color dictionary mapping cell types to colors</span>
<span class="linenos" data-linenos="223 "></span>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]):</span>
<span class="linenos" data-linenos="224 "></span>                <span class="c1"># Use categorical order for colors</span>
<span class="linenos" data-linenos="225 "></span>                <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
<span class="linenos" data-linenos="226 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="227 "></span>                <span class="c1"># Use unique order for colors</span>
<span class="linenos" data-linenos="228 "></span>                <span class="n">unique_cats</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="linenos" data-linenos="229 "></span>                <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_cats</span><span class="p">,</span> <span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cats</span><span class="p">)]))</span>
<span class="linenos" data-linenos="230 "></span>
<span class="linenos" data-linenos="231 "></span>            <span class="c1"># Get colors for the actual categories in the plot</span>
<span class="linenos" data-linenos="232 "></span>            <span class="n">cell_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="s1">'#CCCCCC'</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">agg</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="linenos" data-linenos="233 "></span>    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
<span class="linenos" data-linenos="234 "></span>        <span class="n">cell_colors</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="235 "></span>        <span class="n">color_dict</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="236 "></span>
<span class="linenos" data-linenos="237 "></span>    <span class="c1"># Calculate mean expression and fraction of expressing cells</span>
<span class="linenos" data-linenos="238 "></span>    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">agg</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)))</span>
<span class="linenos" data-linenos="239 "></span>    <span class="n">fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="linenos" data-linenos="240 "></span>
<span class="linenos" data-linenos="241 "></span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
<span class="linenos" data-linenos="242 "></span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span>
<span class="linenos" data-linenos="243 "></span>        <span class="n">group_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">mask</span><span class="p">][:,</span> <span class="n">var_names_idx</span><span class="p">]</span>
<span class="linenos" data-linenos="244 "></span>
<span class="linenos" data-linenos="245 "></span>        <span class="c1"># Calculate mean expression</span>
<span class="linenos" data-linenos="246 "></span>        <span class="k">if</span> <span class="n">mean_only_expressed</span><span class="p">:</span>
<span class="linenos" data-linenos="247 "></span>            <span class="n">expressed</span> <span class="o">=</span> <span class="n">group_matrix</span> <span class="o">&gt;</span> <span class="n">expression_cutoff</span>
<span class="linenos" data-linenos="248 "></span>            <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
<span class="linenos" data-linenos="249 "></span>                <span class="n">group_matrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">expressed</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="n">expressed</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos" data-linenos="250 "></span>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos" data-linenos="251 "></span>            <span class="p">])</span>
<span class="linenos" data-linenos="252 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="253 "></span>            <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">group_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos" data-linenos="254 "></span>
<span class="linenos" data-linenos="255 "></span>        <span class="c1"># Calculate fraction of expressing cells</span>
<span class="linenos" data-linenos="256 "></span>        <span class="n">fractions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">group_matrix</span> <span class="o">&gt;</span> <span class="n">expression_cutoff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos" data-linenos="257 "></span>
<span class="linenos" data-linenos="258 "></span>    <span class="c1"># Scale if requested</span>
<span class="linenos" data-linenos="259 "></span>    <span class="k">if</span> <span class="n">standard_scale</span> <span class="o">==</span> <span class="s1">'group'</span><span class="p">:</span>
<span class="linenos" data-linenos="260 "></span>        <span class="n">means</span> <span class="o">=</span> <span class="p">(</span><span class="n">means</span> <span class="o">-</span> <span class="n">means</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="n">means</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos" data-linenos="261 "></span>    <span class="k">elif</span> <span class="n">standard_scale</span> <span class="o">==</span> <span class="s1">'var'</span><span class="p">:</span>
<span class="linenos" data-linenos="262 "></span>        <span class="n">means</span> <span class="o">=</span> <span class="p">(</span><span class="n">means</span> <span class="o">-</span> <span class="n">means</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">means</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos" data-linenos="263 "></span>
<span class="linenos" data-linenos="264 "></span>    <span class="c1"># Handle dot size limits</span>
<span class="linenos" data-linenos="265 "></span>    <span class="k">if</span> <span class="n">dot_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="266 "></span>        <span class="n">fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">dot_max</span><span class="p">)</span>
<span class="linenos" data-linenos="267 "></span>    <span class="k">if</span> <span class="n">dot_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="268 "></span>        <span class="n">fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">dot_min</span><span class="p">)</span>
<span class="linenos" data-linenos="269 "></span>
<span class="linenos" data-linenos="270 "></span>    <span class="c1"># Scale dot sizes to account for smallest_dot</span>
<span class="linenos" data-linenos="271 "></span>    <span class="k">if</span> <span class="n">smallest_dot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="272 "></span>        <span class="n">fractions</span> <span class="o">=</span> <span class="n">smallest_dot</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">smallest_dot</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractions</span>
<span class="linenos" data-linenos="273 "></span>
<span class="linenos" data-linenos="274 "></span>    <span class="c1"># Create the plot</span>
<span class="linenos" data-linenos="275 "></span>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos" data-linenos="276 "></span>
<span class="linenos" data-linenos="277 "></span>    <span class="c1"># Calculate dimensions based on figsize if provided</span>
<span class="linenos" data-linenos="278 "></span>    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="279 "></span>        <span class="c1"># Use figsize to determine height and width</span>
<span class="linenos" data-linenos="280 "></span>        <span class="c1"># Adjust for the number of rows and columns to maintain aspect ratio</span>
<span class="linenos" data-linenos="281 "></span>        <span class="n">base_height</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.7</span>  <span class="c1"># Use 70% of figsize height for main plot</span>
<span class="linenos" data-linenos="282 "></span>        <span class="n">base_width</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.7</span>   <span class="c1"># Use 70% of figsize width for main plot</span>
<span class="linenos" data-linenos="283 "></span>
<span class="linenos" data-linenos="284 "></span>        <span class="c1"># Scale based on data dimensions</span>
<span class="linenos" data-linenos="285 "></span>        <span class="n">height</span> <span class="o">=</span> <span class="n">base_height</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
<span class="linenos" data-linenos="286 "></span>        <span class="n">width</span> <span class="o">=</span> <span class="n">base_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
<span class="linenos" data-linenos="287 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="288 "></span>        <span class="c1"># Default behavior</span>
<span class="linenos" data-linenos="289 "></span>        <span class="n">height</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">3</span>
<span class="linenos" data-linenos="290 "></span>        <span class="n">width</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">3</span>
<span class="linenos" data-linenos="291 "></span>
<span class="linenos" data-linenos="292 "></span>
<span class="linenos" data-linenos="293 "></span>    <span class="c1"># Create SizedHeatmap</span>
<span class="linenos" data-linenos="294 "></span>    <span class="n">m</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SizedHeatmap</span><span class="p">(</span>
<span class="linenos" data-linenos="295 "></span>        <span class="n">size</span><span class="o">=</span><span class="n">fractions</span><span class="p">,</span>
<span class="linenos" data-linenos="296 "></span>        <span class="n">color</span><span class="o">=</span><span class="n">means</span><span class="p">,</span>
<span class="linenos" data-linenos="297 "></span>        <span class="n">cluster_data</span><span class="o">=</span><span class="n">fractions</span> <span class="k">if</span> <span class="n">dendrogram</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="298 "></span>        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
<span class="linenos" data-linenos="299 "></span>        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
<span class="linenos" data-linenos="300 "></span>        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"lightgray"</span><span class="p">,</span>
<span class="linenos" data-linenos="301 "></span>        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
<span class="linenos" data-linenos="302 "></span>        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
<span class="linenos" data-linenos="303 "></span>        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
<span class="linenos" data-linenos="304 "></span>        <span class="c1">#norm=norm,</span>
<span class="linenos" data-linenos="305 "></span>        <span class="n">size_legend_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<span class="linenos" data-linenos="306 "></span>            <span class="n">colors</span><span class="o">=</span><span class="s2">"#c2c2c2"</span><span class="p">,</span>
<span class="linenos" data-linenos="307 "></span>            <span class="n">title</span><span class="o">=</span><span class="n">size_title</span><span class="p">,</span>
<span class="linenos" data-linenos="308 "></span>            <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span>
<span class="linenos" data-linenos="309 "></span>            <span class="n">show_at</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
<span class="linenos" data-linenos="310 "></span>            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
<span class="linenos" data-linenos="311 "></span>            <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="linenos" data-linenos="312 "></span>            <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s2">"size"</span><span class="p">:</span> <span class="n">fontsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
<span class="linenos" data-linenos="313 "></span>        <span class="p">),</span>
<span class="linenos" data-linenos="314 "></span>        <span class="n">color_legend_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<span class="linenos" data-linenos="315 "></span>            <span class="n">title</span><span class="o">=</span><span class="n">colorbar_title</span><span class="p">,</span>
<span class="linenos" data-linenos="316 "></span>            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
<span class="linenos" data-linenos="317 "></span>            <span class="n">orientation</span><span class="o">=</span><span class="s2">"horizontal"</span><span class="p">,</span>
<span class="linenos" data-linenos="318 "></span>            <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s2">"size"</span><span class="p">:</span> <span class="n">fontsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
<span class="linenos" data-linenos="319 "></span>        <span class="p">),</span>
<span class="linenos" data-linenos="320 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="321 "></span>
<span class="linenos" data-linenos="322 "></span>    <span class="c1"># Add labels</span>
<span class="linenos" data-linenos="323 "></span>    <span class="n">m</span><span class="o">.</span><span class="n">add_top</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Labels</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos" data-linenos="324 "></span>
<span class="linenos" data-linenos="325 "></span>    <span class="c1"># Group genes if var_names was a dictionary</span>
<span class="linenos" data-linenos="326 "></span>    <span class="k">if</span> <span class="s1">'gene_groups'</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
<span class="linenos" data-linenos="327 "></span>        <span class="c1"># Get colors for gene groups</span>
<span class="linenos" data-linenos="328 "></span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="329 "></span>            <span class="c1"># Use the same color_dict that was created for cell types</span>
<span class="linenos" data-linenos="330 "></span>            <span class="k">if</span> <span class="n">color_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="331 "></span>                <span class="c1"># Get unique groups and check which ones are not in color_dict</span>
<span class="linenos" data-linenos="332 "></span>                <span class="n">unique_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">))</span>
<span class="linenos" data-linenos="333 "></span>                <span class="n">missing_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">unique_groups</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="p">]</span>
<span class="linenos" data-linenos="334 "></span>
<span class="linenos" data-linenos="335 "></span>                <span class="c1"># If there are missing groups, add colors from palette</span>
<span class="linenos" data-linenos="336 "></span>                <span class="k">if</span> <span class="n">missing_groups</span><span class="p">:</span>
<span class="linenos" data-linenos="337 "></span>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette_28</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_dict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_groups</span><span class="p">):</span>
<span class="linenos" data-linenos="338 "></span>                        <span class="n">extra_colors</span> <span class="o">=</span> <span class="n">palette_28</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">color_dict</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">color_dict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_groups</span><span class="p">)]</span>
<span class="linenos" data-linenos="339 "></span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="340 "></span>                        <span class="n">extra_colors</span> <span class="o">=</span> <span class="n">palette_56</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">color_dict</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">color_dict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_groups</span><span class="p">)]</span>
<span class="linenos" data-linenos="341 "></span>                    <span class="n">color_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">missing_groups</span><span class="p">,</span> <span class="n">extra_colors</span><span class="p">)))</span>
<span class="linenos" data-linenos="342 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="343 "></span>                <span class="c1"># If no colors found in uns, use default palette</span>
<span class="linenos" data-linenos="344 "></span>                <span class="n">unique_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">))</span>
<span class="linenos" data-linenos="345 "></span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
<span class="linenos" data-linenos="346 "></span>                    <span class="n">palette</span> <span class="o">=</span> <span class="n">palette_28</span>
<span class="linenos" data-linenos="347 "></span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="348 "></span>                    <span class="n">palette</span> <span class="o">=</span> <span class="n">palette_56</span>
<span class="linenos" data-linenos="349 "></span>                <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">,</span> <span class="n">palette</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">)]))</span>
<span class="linenos" data-linenos="350 "></span>        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
<span class="linenos" data-linenos="351 "></span>            <span class="c1"># If colors not found in uns, use default palette</span>
<span class="linenos" data-linenos="352 "></span>            <span class="n">unique_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">))</span>
<span class="linenos" data-linenos="353 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
<span class="linenos" data-linenos="354 "></span>                <span class="n">palette</span> <span class="o">=</span> <span class="n">palette_28</span>
<span class="linenos" data-linenos="355 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="356 "></span>                <span class="n">palette</span> <span class="o">=</span> <span class="n">palette_56</span>
<span class="linenos" data-linenos="357 "></span>            <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">,</span> <span class="n">palette</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">)]))</span>
<span class="linenos" data-linenos="358 "></span>
<span class="linenos" data-linenos="359 "></span>        <span class="c1"># Add color bars with matching order</span>
<span class="linenos" data-linenos="360 "></span>        <span class="c1"># Add group labels</span>
<span class="linenos" data-linenos="361 "></span>        <span class="c1"># Only show used colors in legend and increase group spacing</span>
<span class="linenos" data-linenos="362 "></span>        <span class="k">if</span> <span class="n">preserve_dict_order</span> <span class="ow">and</span> <span class="n">original_var_names_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="363 "></span>            <span class="c1"># When preserving dict order, use the original dictionary key order</span>
<span class="linenos" data-linenos="364 "></span>            <span class="n">used_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_var_names_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos" data-linenos="365 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="366 "></span>            <span class="c1"># Use the order as they appear in gene_groups</span>
<span class="linenos" data-linenos="367 "></span>            <span class="n">used_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">))</span>
<span class="linenos" data-linenos="368 "></span>
<span class="linenos" data-linenos="369 "></span>        <span class="n">used_color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">used_groups</span><span class="p">}</span>
<span class="linenos" data-linenos="370 "></span>        <span class="n">m</span><span class="o">.</span><span class="n">add_top</span><span class="p">(</span>
<span class="linenos" data-linenos="371 "></span>            <span class="n">mp</span><span class="o">.</span><span class="n">Colors</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">used_color_dict</span><span class="p">),</span>
<span class="linenos" data-linenos="372 "></span>            <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="linenos" data-linenos="373 "></span>            <span class="n">size</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
<span class="linenos" data-linenos="374 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="375 "></span>        <span class="c1"># Add group labels with increased spacing</span>
<span class="linenos" data-linenos="376 "></span>        <span class="n">m</span><span class="o">.</span><span class="n">group_cols</span><span class="p">(</span><span class="n">gene_groups</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">used_groups</span><span class="p">)</span>
<span class="linenos" data-linenos="377 "></span>
<span class="linenos" data-linenos="378 "></span>    <span class="c1"># Add cell type colors if available</span>
<span class="linenos" data-linenos="379 "></span>    <span class="k">if</span> <span class="n">color_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="380 "></span>        <span class="c1"># Add color bar using the properly created color_dict</span>
<span class="linenos" data-linenos="381 "></span>        <span class="n">m</span><span class="o">.</span><span class="n">add_left</span><span class="p">(</span>
<span class="linenos" data-linenos="382 "></span>            <span class="n">mp</span><span class="o">.</span><span class="n">Colors</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">color_dict</span><span class="p">),</span>
<span class="linenos" data-linenos="383 "></span>            <span class="n">size</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
<span class="linenos" data-linenos="384 "></span>            <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="linenos" data-linenos="385 "></span>            <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="386 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="387 "></span>
<span class="linenos" data-linenos="388 "></span>    <span class="c1"># Add cell type labels</span>
<span class="linenos" data-linenos="389 "></span>    <span class="n">m</span><span class="o">.</span><span class="n">add_left</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Labels</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">"right"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos" data-linenos="390 "></span>
<span class="linenos" data-linenos="391 "></span>    <span class="c1"># Add cell counts</span>
<span class="linenos" data-linenos="392 "></span>    <span class="n">m</span><span class="o">.</span><span class="n">add_right</span><span class="p">(</span>
<span class="linenos" data-linenos="393 "></span>        <span class="n">mp</span><span class="o">.</span><span class="n">Numbers</span><span class="p">(</span>
<span class="linenos" data-linenos="394 "></span>            <span class="n">cell_counts</span><span class="p">,</span>
<span class="linenos" data-linenos="395 "></span>            <span class="n">color</span><span class="o">=</span><span class="s2">"#EEB76B"</span><span class="p">,</span>
<span class="linenos" data-linenos="396 "></span>            <span class="n">label</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span>
<span class="linenos" data-linenos="397 "></span>            <span class="n">label_props</span><span class="o">=</span><span class="p">{</span><span class="s1">'size'</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">},</span>
<span class="linenos" data-linenos="398 "></span>            <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s1">'size'</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">},</span>
<span class="linenos" data-linenos="399 "></span>            <span class="n">show_value</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos" data-linenos="400 "></span>        <span class="p">),</span>
<span class="linenos" data-linenos="401 "></span>        <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="linenos" data-linenos="402 "></span>        <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="linenos" data-linenos="403 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="404 "></span>
<span class="linenos" data-linenos="405 "></span>    <span class="c1"># Add dendrogram if requested</span>
<span class="linenos" data-linenos="406 "></span>    <span class="k">if</span> <span class="n">dendrogram</span><span class="p">:</span>
<span class="linenos" data-linenos="407 "></span>        <span class="n">m</span><span class="o">.</span><span class="n">add_dendrogram</span><span class="p">(</span><span class="s2">"right"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos" data-linenos="408 "></span>
<span class="linenos" data-linenos="409 "></span>    <span class="c1"># Add legends</span>
<span class="linenos" data-linenos="410 "></span>    <span class="n">m</span><span class="o">.</span><span class="n">add_legends</span><span class="p">(</span><span class="n">box_padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos" data-linenos="411 "></span>
<span class="linenos" data-linenos="412 "></span>    <span class="c1"># Render the plot</span>
<span class="linenos" data-linenos="413 "></span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="linenos" data-linenos="414 "></span>
<span class="linenos" data-linenos="415 "></span>    <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
<span class="linenos" data-linenos="416 "></span>        <span class="k">return</span> <span class="n">fig</span>
<span class="linenos" data-linenos="417 "></span>    <span class="k">elif</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
<span class="linenos" data-linenos="418 "></span>        <span class="k">return</span> <span class="n">m</span>
<span class="linenos" data-linenos="419 "></span>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.rank_genes_groups_dotplot">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">rank_genes_groups_dotplot</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">'dotplot'</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values_to_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_logfoldchange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gene_symbols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create a dot plot from rank_genes_groups results.</p>
<h4 id="omicverse.pl.rank_genes_groups_dotplot--parameters">Parameters<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--parameters" title="Permanent link">¶</a></h4>
<details class="adata-">
<summary>AnnData</summary>
<p>Annotated data matrix.</p>
</details>
<details class="plot_type-">
<summary>str</summary>
<p>Currently only 'dotplot' is supported.</p>
</details>
<details class="groups-">
<summary>str or list of str, optional</summary>
<p>Groups to include in the plot.</p>
</details>
<details class="n_genes-">
<summary>int, optional</summary>
<p>Number of genes to include in the plot.</p>
</details>
<details class="groupby-">
<summary>str, optional</summary>
<p>Key in <code>adata.obs</code> to group by.</p>
</details>
<details class="values_to_plot-">
<summary>str, optional</summary>
<p>Key in rank_genes_groups results to plot (e.g. 'logfoldchanges', 'scores').</p>
</details>
<details class="var_names-">
<summary>str or list of str or dict, optional</summary>
<p>Variables to include in the plot. Can be:
- A list of gene names: ['gene1', 'gene2', ...]
- A dictionary mapping group names to gene lists: {'group1': ['gene1', 'gene2'], 'group2': ['gene3', 'gene4']}
When a dictionary is provided, genes will be grouped and labeled accordingly in the plot.</p>
</details>
<details class="min_logfoldchange-">
<summary>float, optional</summary>
<p>Minimum log fold change to include in the plot.</p>
</details>
<details class="key-">
<summary>str, optional</summary>
<p>Key in <code>adata.uns</code> to use for rank_genes_groups results.</p>
</details>
<details class="show-">
<summary>bool, optional</summary>
<p>Whether to show the plot.</p>
</details>
<details class="save-">
<summary>bool, optional</summary>
<p>Whether to save the plot.</p>
</details>
<details class="return_fig-">
<summary>bool</summary>
<p>Whether to return the figure object.</p>
</details>
<details class="gene_symbols-">
<summary>str, optional</summary>
<p>Key for gene symbols in <code>adata.var</code>.</p>
</details> <p>**kwds : dict
    Additional keyword arguments to pass to dotplot.</p>
<h4 id="omicverse.pl.rank_genes_groups_dotplot--returns">Returns<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--returns" title="Permanent link">¶</a></h4>
<p>If <code>return_fig</code> is True, returns the figure object.
If <code>show</code> is False, returns axes dictionary.</p>
<h4 id="omicverse.pl.rank_genes_groups_dotplot--examples">Examples<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--examples" title="Permanent link">¶</a></h4>
<blockquote>
<blockquote>
<blockquote>
<h3 id="omicverse.pl.rank_genes_groups_dotplot--basic-usage-with-top-genes">Basic usage with top genes<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--basic-usage-with-top-genes" title="Permanent link">¶</a></h3>
<p>sc.pl.rank_genes_groups_dotplot(adata, n_genes=5)</p>
<h3 id="omicverse.pl.rank_genes_groups_dotplot--using-logfoldchanges-for-coloring">Using logfoldchanges for coloring<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--using-logfoldchanges-for-coloring" title="Permanent link">¶</a></h3>
<p>sc.pl.rank_genes_groups_dotplot(adata, n_genes=5, values_to_plot='logfoldchanges')</p>
<h3 id="omicverse.pl.rank_genes_groups_dotplot--grouping-genes-manually">Grouping genes manually<a class="headerlink" href="#omicverse.pl.rank_genes_groups_dotplot--grouping-genes-manually" title="Permanent link">¶</a></h3>
<p>gene_groups = {
...     'Group1': ['gene1', 'gene2'],
...     'Group2': ['gene3', 'gene4']
... }
sc.pl.rank_genes_groups_dotplot(adata, var_names=gene_groups)</p>
</blockquote>
</blockquote>
</blockquote>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_dotplot.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="459 "></span><span class="k">def</span> <span class="nf">rank_genes_groups_dotplot</span><span class="p">(</span>
<span class="linenos" data-linenos="460 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos="461 "></span>    <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"dotplot"</span><span class="p">,</span>
<span class="linenos" data-linenos="462 "></span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos" data-linenos="463 "></span>    <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="464 "></span>    <span class="n">n_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="465 "></span>    <span class="n">groupby</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="466 "></span>    <span class="n">values_to_plot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="467 "></span>    <span class="n">var_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="468 "></span>    <span class="n">min_logfoldchange</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="469 "></span>    <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="470 "></span>    <span class="n">show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="471 "></span>    <span class="n">save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="472 "></span>    <span class="n">return_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="473 "></span>    <span class="n">gene_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="474 "></span>    <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos" data-linenos="475 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="linenos" data-linenos="476 "></span><span class="w">    </span><span class="sd">"""</span>
<span class="linenos" data-linenos="477 "></span><span class="sd">    Create a dot plot from rank_genes_groups results.</span>
<span class="linenos" data-linenos="478 "></span>
<span class="linenos" data-linenos="479 "></span><span class="sd">    Parameters</span>
<span class="linenos" data-linenos="480 "></span><span class="sd">    ----------</span>
<span class="linenos" data-linenos="481 "></span><span class="sd">    adata : AnnData</span>
<span class="linenos" data-linenos="482 "></span><span class="sd">        Annotated data matrix.</span>
<span class="linenos" data-linenos="483 "></span><span class="sd">    plot_type : str</span>
<span class="linenos" data-linenos="484 "></span><span class="sd">        Currently only 'dotplot' is supported.</span>
<span class="linenos" data-linenos="485 "></span><span class="sd">    groups : str or list of str, optional</span>
<span class="linenos" data-linenos="486 "></span><span class="sd">        Groups to include in the plot.</span>
<span class="linenos" data-linenos="487 "></span><span class="sd">    n_genes : int, optional</span>
<span class="linenos" data-linenos="488 "></span><span class="sd">        Number of genes to include in the plot.</span>
<span class="linenos" data-linenos="489 "></span><span class="sd">    groupby : str, optional</span>
<span class="linenos" data-linenos="490 "></span><span class="sd">        Key in `adata.obs` to group by.</span>
<span class="linenos" data-linenos="491 "></span><span class="sd">    values_to_plot : str, optional</span>
<span class="linenos" data-linenos="492 "></span><span class="sd">        Key in rank_genes_groups results to plot (e.g. 'logfoldchanges', 'scores').</span>
<span class="linenos" data-linenos="493 "></span><span class="sd">    var_names : str or list of str or dict, optional</span>
<span class="linenos" data-linenos="494 "></span><span class="sd">        Variables to include in the plot. Can be:</span>
<span class="linenos" data-linenos="495 "></span><span class="sd">        - A list of gene names: ['gene1', 'gene2', ...]</span>
<span class="linenos" data-linenos="496 "></span><span class="sd">        - A dictionary mapping group names to gene lists: {'group1': ['gene1', 'gene2'], 'group2': ['gene3', 'gene4']}</span>
<span class="linenos" data-linenos="497 "></span><span class="sd">        When a dictionary is provided, genes will be grouped and labeled accordingly in the plot.</span>
<span class="linenos" data-linenos="498 "></span><span class="sd">    min_logfoldchange : float, optional</span>
<span class="linenos" data-linenos="499 "></span><span class="sd">        Minimum log fold change to include in the plot.</span>
<span class="linenos" data-linenos="500 "></span><span class="sd">    key : str, optional</span>
<span class="linenos" data-linenos="501 "></span><span class="sd">        Key in `adata.uns` to use for rank_genes_groups results.</span>
<span class="linenos" data-linenos="502 "></span><span class="sd">    show : bool, optional</span>
<span class="linenos" data-linenos="503 "></span><span class="sd">        Whether to show the plot.</span>
<span class="linenos" data-linenos="504 "></span><span class="sd">    save : bool, optional</span>
<span class="linenos" data-linenos="505 "></span><span class="sd">        Whether to save the plot.</span>
<span class="linenos" data-linenos="506 "></span><span class="sd">    return_fig : bool</span>
<span class="linenos" data-linenos="507 "></span><span class="sd">        Whether to return the figure object.</span>
<span class="linenos" data-linenos="508 "></span><span class="sd">    gene_symbols : str, optional</span>
<span class="linenos" data-linenos="509 "></span><span class="sd">        Key for gene symbols in `adata.var`.</span>
<span class="linenos" data-linenos="510 "></span><span class="sd">    **kwds : dict</span>
<span class="linenos" data-linenos="511 "></span><span class="sd">        Additional keyword arguments to pass to dotplot.</span>
<span class="linenos" data-linenos="512 "></span>
<span class="linenos" data-linenos="513 "></span><span class="sd">    Returns</span>
<span class="linenos" data-linenos="514 "></span><span class="sd">    -------</span>
<span class="linenos" data-linenos="515 "></span><span class="sd">    If `return_fig` is True, returns the figure object.</span>
<span class="linenos" data-linenos="516 "></span><span class="sd">    If `show` is False, returns axes dictionary.</span>
<span class="linenos" data-linenos="517 "></span>
<span class="linenos" data-linenos="518 "></span><span class="sd">    Examples</span>
<span class="linenos" data-linenos="519 "></span><span class="sd">    --------</span>
<span class="linenos" data-linenos="520 "></span><span class="sd">    &gt;&gt;&gt; # Basic usage with top genes</span>
<span class="linenos" data-linenos="521 "></span><span class="sd">    &gt;&gt;&gt; sc.pl.rank_genes_groups_dotplot(adata, n_genes=5)</span>
<span class="linenos" data-linenos="522 "></span>
<span class="linenos" data-linenos="523 "></span><span class="sd">    &gt;&gt;&gt; # Using logfoldchanges for coloring</span>
<span class="linenos" data-linenos="524 "></span><span class="sd">    &gt;&gt;&gt; sc.pl.rank_genes_groups_dotplot(adata, n_genes=5, values_to_plot='logfoldchanges')</span>
<span class="linenos" data-linenos="525 "></span>
<span class="linenos" data-linenos="526 "></span><span class="sd">    &gt;&gt;&gt; # Grouping genes manually</span>
<span class="linenos" data-linenos="527 "></span><span class="sd">    &gt;&gt;&gt; gene_groups = {</span>
<span class="linenos" data-linenos="528 "></span><span class="sd">    ...     'Group1': ['gene1', 'gene2'],</span>
<span class="linenos" data-linenos="529 "></span><span class="sd">    ...     'Group2': ['gene3', 'gene4']</span>
<span class="linenos" data-linenos="530 "></span><span class="sd">    ... }</span>
<span class="linenos" data-linenos="531 "></span><span class="sd">    &gt;&gt;&gt; sc.pl.rank_genes_groups_dotplot(adata, var_names=gene_groups)</span>
<span class="linenos" data-linenos="532 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="533 "></span>    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">!=</span> <span class="s2">"dotplot"</span><span class="p">:</span>
<span class="linenos" data-linenos="534 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Only 'dotplot' is currently supported"</span><span class="p">)</span>
<span class="linenos" data-linenos="535 "></span>
<span class="linenos" data-linenos="536 "></span>    <span class="k">if</span> <span class="n">var_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="537 "></span>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos" data-linenos="538 "></span>            <span class="s2">"The arguments n_genes and var_names are mutually exclusive. Please "</span>
<span class="linenos" data-linenos="539 "></span>            <span class="s2">"select only one."</span>
<span class="linenos" data-linenos="540 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="541 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos" data-linenos="542 "></span>
<span class="linenos" data-linenos="543 "></span>    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="544 "></span>        <span class="n">key</span> <span class="o">=</span> <span class="s2">"rank_genes_groups"</span>
<span class="linenos" data-linenos="545 "></span>
<span class="linenos" data-linenos="546 "></span>    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="547 "></span>        <span class="n">groupby</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"params"</span><span class="p">][</span><span class="s2">"groupby"</span><span class="p">])</span>
<span class="linenos" data-linenos="548 "></span>    <span class="n">group_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"names"</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">groups</span>
<span class="linenos" data-linenos="549 "></span>
<span class="linenos" data-linenos="550 "></span>    <span class="k">if</span> <span class="n">var_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="551 "></span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="linenos" data-linenos="552 "></span>            <span class="c1"># get a single list of all gene names in the dictionary</span>
<span class="linenos" data-linenos="553 "></span>            <span class="n">var_names_list</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<span class="linenos" data-linenos="554 "></span>                <span class="n">operator</span><span class="o">.</span><span class="n">iadd</span><span class="p">,</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="p">[]</span>
<span class="linenos" data-linenos="555 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="556 "></span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="557 "></span>            <span class="n">var_names_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_names</span><span class="p">]</span>
<span class="linenos" data-linenos="558 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="559 "></span>            <span class="n">var_names_list</span> <span class="o">=</span> <span class="n">var_names</span>
<span class="linenos" data-linenos="560 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="561 "></span>        <span class="c1"># set n_genes = 10 as default when none of the options is given</span>
<span class="linenos" data-linenos="562 "></span>        <span class="k">if</span> <span class="n">n_genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="563 "></span>            <span class="n">n_genes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos" data-linenos="564 "></span>
<span class="linenos" data-linenos="565 "></span>        <span class="c1"># dict in which each group is the key and the n_genes are the values</span>
<span class="linenos" data-linenos="566 "></span>        <span class="n">var_names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos" data-linenos="567 "></span>        <span class="n">var_names_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="568 "></span>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">group_names</span><span class="p">:</span>
<span class="linenos" data-linenos="569 "></span>            <span class="n">df</span> <span class="o">=</span> <span class="n">rank_genes_groups_df</span><span class="p">(</span>
<span class="linenos" data-linenos="570 "></span>                <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="571 "></span>                <span class="n">group</span><span class="p">,</span>
<span class="linenos" data-linenos="572 "></span>                <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
<span class="linenos" data-linenos="573 "></span>                <span class="n">gene_symbols</span><span class="o">=</span><span class="n">gene_symbols</span><span class="p">,</span>
<span class="linenos" data-linenos="574 "></span>                <span class="n">log2fc_min</span><span class="o">=</span><span class="n">min_logfoldchange</span><span class="p">,</span>
<span class="linenos" data-linenos="575 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="576 "></span>
<span class="linenos" data-linenos="577 "></span>            <span class="k">if</span> <span class="n">gene_symbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="578 "></span>                <span class="n">df</span><span class="p">[</span><span class="s2">"names"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">gene_symbols</span><span class="p">]</span>
<span class="linenos" data-linenos="579 "></span>
<span class="linenos" data-linenos="580 "></span>            <span class="n">genes_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos" data-linenos="581 "></span>
<span class="linenos" data-linenos="582 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="583 "></span>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: No genes found for group </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="584 "></span>                <span class="k">continue</span>
<span class="linenos" data-linenos="585 "></span>            <span class="n">genes_list</span> <span class="o">=</span> <span class="n">genes_list</span><span class="p">[</span><span class="n">n_genes</span><span class="p">:]</span> <span class="k">if</span> <span class="n">n_genes</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">genes_list</span><span class="p">[:</span><span class="n">n_genes</span><span class="p">]</span>
<span class="linenos" data-linenos="586 "></span>            <span class="n">var_names</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">genes_list</span>
<span class="linenos" data-linenos="587 "></span>            <span class="n">var_names_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">genes_list</span><span class="p">)</span>
<span class="linenos" data-linenos="588 "></span>
<span class="linenos" data-linenos="589 "></span>    <span class="c1"># by default add dendrogram to plots</span>
<span class="linenos" data-linenos="590 "></span>    <span class="n">kwds</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"dendrogram"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="591 "></span>
<span class="linenos" data-linenos="592 "></span>    <span class="c1"># Get values to plot if specified</span>
<span class="linenos" data-linenos="593 "></span>    <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="594 "></span>    <span class="n">values_df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos" data-linenos="595 "></span>    <span class="k">if</span> <span class="n">values_to_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="596 "></span>        <span class="n">values_df</span> <span class="o">=</span> <span class="n">_get_values_to_plot</span><span class="p">(</span>
<span class="linenos" data-linenos="597 "></span>            <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="598 "></span>            <span class="n">values_to_plot</span><span class="p">,</span>
<span class="linenos" data-linenos="599 "></span>            <span class="n">var_names_list</span><span class="p">,</span>
<span class="linenos" data-linenos="600 "></span>            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
<span class="linenos" data-linenos="601 "></span>            <span class="n">gene_symbols</span><span class="o">=</span><span class="n">gene_symbols</span><span class="p">,</span>
<span class="linenos" data-linenos="602 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="603 "></span>        <span class="n">title</span> <span class="o">=</span> <span class="n">values_to_plot</span>
<span class="linenos" data-linenos="604 "></span>        <span class="k">if</span> <span class="n">values_to_plot</span> <span class="o">==</span> <span class="s2">"logfoldchanges"</span><span class="p">:</span>
<span class="linenos" data-linenos="605 "></span>            <span class="n">title</span> <span class="o">=</span> <span class="s2">"log fold change"</span>
<span class="linenos" data-linenos="606 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="607 "></span>            <span class="n">title</span> <span class="o">=</span> <span class="n">values_to_plot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"pvals"</span><span class="p">,</span> <span class="s2">"p-value"</span><span class="p">)</span>
<span class="linenos" data-linenos="608 "></span>
<span class="linenos" data-linenos="609 "></span>    <span class="c1"># Create the plot</span>
<span class="linenos" data-linenos="610 "></span>    <span class="n">_pl</span> <span class="o">=</span> <span class="n">dotplot</span><span class="p">(</span>
<span class="linenos" data-linenos="611 "></span>        <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="612 "></span>        <span class="n">var_names</span><span class="p">,</span>
<span class="linenos" data-linenos="613 "></span>        <span class="n">groupby</span><span class="p">,</span>
<span class="linenos" data-linenos="614 "></span>        <span class="n">dot_color_df</span><span class="o">=</span><span class="n">values_df</span><span class="p">,</span>
<span class="linenos" data-linenos="615 "></span>        <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="616 "></span>        <span class="n">gene_symbols</span><span class="o">=</span><span class="n">gene_symbols</span><span class="p">,</span>
<span class="linenos" data-linenos="617 "></span>        <span class="n">preserve_dict_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="618 "></span>        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="linenos" data-linenos="619 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="620 "></span>
<span class="linenos" data-linenos="621 "></span>    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">"colorbar_title"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
<span class="linenos" data-linenos="622 "></span>        <span class="n">_pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
<span class="linenos" data-linenos="623 "></span>
<span class="linenos" data-linenos="624 "></span>    <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
<span class="linenos" data-linenos="625 "></span>        <span class="k">return</span> <span class="n">_pl</span>
<span class="linenos" data-linenos="626 "></span>    <span class="k">elif</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
<span class="linenos" data-linenos="627 "></span>        <span class="k">return</span> <span class="n">_pl</span>
<span class="linenos" data-linenos="628 "></span>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</details>
</div>
</div><h2 id="embedding-and-scatter-plots">Embedding and Scatter Plots<a class="headerlink" href="#embedding-and-scatter-plots" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.embedding">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gene_symbols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edges_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">edges_color</span><span class="o">=</span><span class="s1">'grey'</span><span class="p">,</span> <span class="n">neighbors_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">arrows_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">'2d'</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">na_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">na_in_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="s1">'small'</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">'right margin'</span><span class="p">,</span> <span class="n">legend_fontoutline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar_loc</span><span class="o">=</span><span class="s1">'right'</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_outline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outline_width</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">outline_color</span><span class="o">=</span><span class="p">(</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.embedding" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Scatter plot for user specified embedding basis (e.g. umap, pca, etc).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>Annotated data matrix.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
<code>str</code>
</td>
<td><p>Name of the <code>obsm</code> basis to use.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>color</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str], None]</code>
</td>
<td><p>Keys for annotations of observations/cells or variables/genes. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>gene_symbols</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Key for field in <code>.var</code> that stores gene symbols. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>use_raw</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Use <code>.raw</code> attribute of <code>adata</code> if present. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>sort_order</code></td>
<td>
<code>bool</code>
</td>
<td><p>For continuous annotations used as color parameter, plot data points with higher values on top of others. (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>edges</code></td>
<td>
<code>bool</code>
</td>
<td><p>Show edges between cells. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>edges_width</code></td>
<td>
<code>float</code>
</td>
<td><p>Width of edges. (0.1)</p></td>
<td>
<code>0.1</code>
</td>
</tr>
<tr>
<td><code>edges_color</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[float], <span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>Color of edges. ('grey')</p></td>
<td>
<code>'grey'</code>
</td>
</tr>
<tr>
<td><code>neighbors_key</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Key to use for neighbors. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>arrows</code></td>
<td>
<code>bool</code>
</td>
<td><p>Show arrows for velocity. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>arrows_kwds</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Mapping">Mapping</span>[str, <span title="typing.Any">Any</span>]]</code>
</td>
<td><p>Keyword arguments for arrow plots. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>groups</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Groups to highlight. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>components</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>Components to plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>dimensions</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[int, int], <span title="typing.Sequence">Sequence</span>[<span title="typing.Tuple">Tuple</span>[int, int]]]]</code>
</td>
<td><p>Dimensions to plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>layer</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Name of the layer to use for coloring. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>projection</code></td>
<td>
<code><span title="typing.Literal">Literal</span>['2d', '3d']</code>
</td>
<td><p>Type of projection ('2d' or '3d'). ('2d')</p></td>
<td>
<code>'2d'</code>
</td>
</tr>
<tr>
<td><code>scale_factor</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>Scaling factor for sizes. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>color_map</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.colors.Colormap">Colormap</span>, str, None]</code>
</td>
<td><p>Colormap to use for continuous variables. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>cmap</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.colors.Colormap">Colormap</span>, str, None]</code>
</td>
<td><p>Colormap to use for continuous variables. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>palette</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str], <span title="cycler.Cycler">Cycler</span>, None]</code>
</td>
<td><p>Colors to use for categorical variables. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>na_color</code></td>
<td>
<code><span title="scanpy.plotting._utils.ColorLike">ColorLike</span></code>
</td>
<td><p>Color to use for NaN values. ('lightgray')</p></td>
<td>
<code>'lightgray'</code>
</td>
</tr>
<tr>
<td><code>na_in_legend</code></td>
<td>
<code>bool</code>
</td>
<td><p>Include NaN values in legend. (True)</p></td>
<td>
<code>True</code>
</td>
</tr>
<tr>
<td><code>size</code></td>
<td>
<code><span title="typing.Union">Union</span>[float, <span title="typing.Sequence">Sequence</span>[float], None]</code>
</td>
<td><p>Size of the dots. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>frameon</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Draw a frame around the plot. ('small')</p></td>
<td>
<code>'small'</code>
</td>
</tr>
<tr>
<td><code>legend_fontsize</code></td>
<td>
<code><span title="typing.Union">Union</span>[int, float, <span title="scanpy.plotting._utils._FontSize">_FontSize</span>, None]</code>
</td>
<td><p>Font size for legend. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>legend_fontweight</code></td>
<td>
<code><span title="typing.Union">Union</span>[int, <span title="scanpy.plotting._utils._FontWeight">_FontWeight</span>]</code>
</td>
<td><p>Font weight for legend. ('bold')</p></td>
<td>
<code>'bold'</code>
</td>
</tr>
<tr>
<td><code>legend_loc</code></td>
<td>
<code>str</code>
</td>
<td><p>Location of legend. ('right margin')</p></td>
<td>
<code>'right margin'</code>
</td>
</tr>
<tr>
<td><code>legend_fontoutline</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[int]</code>
</td>
<td><p>Outline width for legend text. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>colorbar_loc</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Location of colorbar. ('right')</p></td>
<td>
<code>'right'</code>
</td>
</tr>
<tr>
<td><code>vmax</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>, <span title="typing.Sequence">Sequence</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>], None]</code>
</td>
<td><p>Maximum value for colorbar. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>vmin</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>, <span title="typing.Sequence">Sequence</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>], None]</code>
</td>
<td><p>Minimum value for colorbar. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>vcenter</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>, <span title="typing.Sequence">Sequence</span>[<span title="scanpy.plotting._utils.VBound">VBound</span>], None]</code>
</td>
<td><p>Center value for colorbar. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>norm</code></td>
<td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.colors.Normalize">Normalize</span>, <span title="typing.Sequence">Sequence</span>[<span title="matplotlib.colors.Normalize">Normalize</span>], None]</code>
</td>
<td><p>Normalization for colorbar. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>add_outline</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Add outline to points. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>outline_width</code></td>
<td>
<code><span title="typing.Tuple">Tuple</span>[float, float]</code>
</td>
<td><p>Width of outline. ((0.3, 0.05))</p></td>
<td>
<code>(0.3, 0.05)</code>
</td>
</tr>
<tr>
<td><code>outline_color</code></td>
<td>
<code><span title="typing.Tuple">Tuple</span>[str, str]</code>
</td>
<td><p>Color of outline. (('black', 'white'))</p></td>
<td>
<code>('black', 'white')</code>
</td>
</tr>
<tr>
<td><code>ncols</code></td>
<td>
<code>int</code>
</td>
<td><p>Number of columns for subplots. (4)</p></td>
<td>
<code>4</code>
</td>
</tr>
<tr>
<td><code>hspace</code></td>
<td>
<code>float</code>
</td>
<td><p>Height spacing between subplots. (0.25)</p></td>
<td>
<code>0.25</code>
</td>
</tr>
<tr>
<td><code>wspace</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[float]</code>
</td>
<td><p>Width spacing between subplots. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str], None]</code>
</td>
<td><p>Title for the plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>show</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Show the plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>save</code></td>
<td>
<code><span title="typing.Union">Union</span>[bool, str, None]</code>
</td>
<td><p>Save the plot. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="matplotlib.axes.Axes">Axes</span>]</code>
</td>
<td><p>Matplotlib axes object. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>return_fig</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Return figure object. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>marker</code></td>
<td>
<code><span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]</code>
</td>
<td><p>Marker style. ('.')</p></td>
<td>
<code>'.'</code>
</td>
</tr>
<tr>
<td><code>**kwargs</code></td>
<td>
</td>
<td><p>Additional keyword arguments.</p></td>
<td>
<code>{}</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td> <td>
<code><span title="typing.Union">Union</span>[<span title="matplotlib.figure.Figure">Figure</span>, <span title="matplotlib.axes.Axes">Axes</span>, None]</code>
</td>
<td><p>If <code>show==False</code> a :class:<code>~matplotlib.axes.Axes</code> or a list of it.</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_single.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 47 "></span><span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span>
<span class="linenos" data-linenos=" 48 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos=" 49 "></span>    <span class="n">basis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos" data-linenos=" 50 "></span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos" data-linenos=" 51 "></span>    <span class="n">color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 52 "></span>    <span class="n">gene_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 53 "></span>    <span class="n">use_raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 54 "></span>    <span class="n">sort_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 55 "></span>    <span class="n">edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 56 "></span>    <span class="n">edges_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 57 "></span>    <span class="n">edges_color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">'grey'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 58 "></span>    <span class="n">neighbors_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 59 "></span>    <span class="n">arrows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 60 "></span>    <span class="n">arrows_kwds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 61 "></span>    <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 62 "></span>    <span class="n">components</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 63 "></span>    <span class="n">dimensions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 64 "></span>    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 65 "></span>    <span class="n">projection</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">'2d'</span><span class="p">,</span> <span class="s1">'3d'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'2d'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 66 "></span>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 67 "></span>    <span class="n">color_map</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 68 "></span>    <span class="n">cmap</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 69 "></span>    <span class="n">palette</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Cycler</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 70 "></span>    <span class="n">na_color</span><span class="p">:</span> <span class="n">ColorLike</span> <span class="o">=</span> <span class="s2">"lightgray"</span><span class="p">,</span>
<span class="linenos" data-linenos=" 71 "></span>    <span class="n">na_in_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos=" 72 "></span>    <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 73 "></span>    <span class="n">frameon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'small'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 74 "></span>    <span class="n">legend_fontsize</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_FontSize</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 75 "></span>    <span class="n">legend_fontweight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">_FontWeight</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'bold'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 76 "></span>    <span class="n">legend_loc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'right margin'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 77 "></span>    <span class="n">legend_fontoutline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 78 "></span>    <span class="n">colorbar_loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"right"</span><span class="p">,</span>
<span class="linenos" data-linenos=" 79 "></span>    <span class="n">vmax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VBound</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">VBound</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 80 "></span>    <span class="n">vmin</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VBound</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">VBound</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 81 "></span>    <span class="n">vcenter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VBound</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">VBound</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 82 "></span>    <span class="n">norm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Normalize</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Normalize</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 83 "></span>    <span class="n">add_outline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 84 "></span>    <span class="n">outline_width</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
<span class="linenos" data-linenos=" 85 "></span>    <span class="n">outline_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">),</span>
<span class="linenos" data-linenos=" 86 "></span>    <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos" data-linenos=" 87 "></span>    <span class="n">hspace</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
<span class="linenos" data-linenos=" 88 "></span>    <span class="n">wspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 89 "></span>    <span class="n">title</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 90 "></span>    <span class="n">show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 91 "></span>    <span class="n">save</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 92 "></span>    <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 93 "></span>    <span class="n">return_fig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 94 "></span>    <span class="n">marker</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">'.'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 95 "></span>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos" data-linenos=" 96 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">Axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="linenos" data-linenos=" 97 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""Scatter plot for user specified embedding basis (e.g. umap, pca, etc).</span>
<span class="linenos" data-linenos=" 98 "></span>
<span class="linenos" data-linenos=" 99 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="100 "></span><span class="sd">        adata: Annotated data matrix.</span>
<span class="linenos" data-linenos="101 "></span><span class="sd">        basis: Name of the `obsm` basis to use.</span>
<span class="linenos" data-linenos="102 "></span><span class="sd">        color: Keys for annotations of observations/cells or variables/genes. (None)</span>
<span class="linenos" data-linenos="103 "></span><span class="sd">        gene_symbols: Key for field in `.var` that stores gene symbols. (None)</span>
<span class="linenos" data-linenos="104 "></span><span class="sd">        use_raw: Use `.raw` attribute of `adata` if present. (None)</span>
<span class="linenos" data-linenos="105 "></span><span class="sd">        sort_order: For continuous annotations used as color parameter, plot data points with higher values on top of others. (True)</span>
<span class="linenos" data-linenos="106 "></span><span class="sd">        edges: Show edges between cells. (False)</span>
<span class="linenos" data-linenos="107 "></span><span class="sd">        edges_width: Width of edges. (0.1)</span>
<span class="linenos" data-linenos="108 "></span><span class="sd">        edges_color: Color of edges. ('grey')</span>
<span class="linenos" data-linenos="109 "></span><span class="sd">        neighbors_key: Key to use for neighbors. (None)</span>
<span class="linenos" data-linenos="110 "></span><span class="sd">        arrows: Show arrows for velocity. (False)</span>
<span class="linenos" data-linenos="111 "></span><span class="sd">        arrows_kwds: Keyword arguments for arrow plots. (None)</span>
<span class="linenos" data-linenos="112 "></span><span class="sd">        groups: Groups to highlight. (None)</span>
<span class="linenos" data-linenos="113 "></span><span class="sd">        components: Components to plot. (None)</span>
<span class="linenos" data-linenos="114 "></span><span class="sd">        dimensions: Dimensions to plot. (None)</span>
<span class="linenos" data-linenos="115 "></span><span class="sd">        layer: Name of the layer to use for coloring. (None)</span>
<span class="linenos" data-linenos="116 "></span><span class="sd">        projection: Type of projection ('2d' or '3d'). ('2d')</span>
<span class="linenos" data-linenos="117 "></span><span class="sd">        scale_factor: Scaling factor for sizes. (None)</span>
<span class="linenos" data-linenos="118 "></span><span class="sd">        color_map: Colormap to use for continuous variables. (None)</span>
<span class="linenos" data-linenos="119 "></span><span class="sd">        cmap: Colormap to use for continuous variables. (None)</span>
<span class="linenos" data-linenos="120 "></span><span class="sd">        palette: Colors to use for categorical variables. (None)</span>
<span class="linenos" data-linenos="121 "></span><span class="sd">        na_color: Color to use for NaN values. ('lightgray')</span>
<span class="linenos" data-linenos="122 "></span><span class="sd">        na_in_legend: Include NaN values in legend. (True)</span>
<span class="linenos" data-linenos="123 "></span><span class="sd">        size: Size of the dots. (None)</span>
<span class="linenos" data-linenos="124 "></span><span class="sd">        frameon: Draw a frame around the plot. ('small')</span>
<span class="linenos" data-linenos="125 "></span><span class="sd">        legend_fontsize: Font size for legend. (None)</span>
<span class="linenos" data-linenos="126 "></span><span class="sd">        legend_fontweight: Font weight for legend. ('bold')</span>
<span class="linenos" data-linenos="127 "></span><span class="sd">        legend_loc: Location of legend. ('right margin')</span>
<span class="linenos" data-linenos="128 "></span><span class="sd">        legend_fontoutline: Outline width for legend text. (None)</span>
<span class="linenos" data-linenos="129 "></span><span class="sd">        colorbar_loc: Location of colorbar. ('right')</span>
<span class="linenos" data-linenos="130 "></span><span class="sd">        vmax: Maximum value for colorbar. (None)</span>
<span class="linenos" data-linenos="131 "></span><span class="sd">        vmin: Minimum value for colorbar. (None)</span>
<span class="linenos" data-linenos="132 "></span><span class="sd">        vcenter: Center value for colorbar. (None)</span>
<span class="linenos" data-linenos="133 "></span><span class="sd">        norm: Normalization for colorbar. (None)</span>
<span class="linenos" data-linenos="134 "></span><span class="sd">        add_outline: Add outline to points. (False)</span>
<span class="linenos" data-linenos="135 "></span><span class="sd">        outline_width: Width of outline. ((0.3, 0.05))</span>
<span class="linenos" data-linenos="136 "></span><span class="sd">        outline_color: Color of outline. (('black', 'white'))</span>
<span class="linenos" data-linenos="137 "></span><span class="sd">        ncols: Number of columns for subplots. (4)</span>
<span class="linenos" data-linenos="138 "></span><span class="sd">        hspace: Height spacing between subplots. (0.25)</span>
<span class="linenos" data-linenos="139 "></span><span class="sd">        wspace: Width spacing between subplots. (None)</span>
<span class="linenos" data-linenos="140 "></span><span class="sd">        title: Title for the plot. (None)</span>
<span class="linenos" data-linenos="141 "></span><span class="sd">        show: Show the plot. (None)</span>
<span class="linenos" data-linenos="142 "></span><span class="sd">        save: Save the plot. (None)</span>
<span class="linenos" data-linenos="143 "></span><span class="sd">        ax: Matplotlib axes object. (None)</span>
<span class="linenos" data-linenos="144 "></span><span class="sd">        return_fig: Return figure object. (None)</span>
<span class="linenos" data-linenos="145 "></span><span class="sd">        marker: Marker style. ('.')</span>
<span class="linenos" data-linenos="146 "></span><span class="sd">        **kwargs: Additional keyword arguments.</span>
<span class="linenos" data-linenos="147 "></span>
<span class="linenos" data-linenos="148 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="149 "></span><span class="sd">        ax: If `show==False` a :class:`~matplotlib.axes.Axes` or a list of it.</span>
<span class="linenos" data-linenos="150 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="151 "></span>
<span class="linenos" data-linenos="152 "></span>    <span class="k">return</span> <span class="n">_embedding</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
<span class="linenos" data-linenos="153 "></span>                     <span class="n">gene_symbols</span><span class="o">=</span><span class="n">gene_symbols</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span><span class="p">,</span> 
<span class="linenos" data-linenos="154 "></span>                     <span class="n">sort_order</span><span class="o">=</span><span class="n">sort_order</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> 
<span class="linenos" data-linenos="155 "></span>                     <span class="n">edges_width</span><span class="o">=</span><span class="n">edges_width</span><span class="p">,</span> <span class="n">edges_color</span><span class="o">=</span><span class="n">edges_color</span><span class="p">,</span> 
<span class="linenos" data-linenos="156 "></span>                     <span class="n">neighbors_key</span><span class="o">=</span><span class="n">neighbors_key</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="n">arrows</span><span class="p">,</span> 
<span class="linenos" data-linenos="157 "></span>                     <span class="n">arrows_kwds</span><span class="o">=</span><span class="n">arrows_kwds</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> 
<span class="linenos" data-linenos="158 "></span>                     <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span> 
<span class="linenos" data-linenos="159 "></span>                     <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span>
<span class="linenos" data-linenos="160 "></span>                       <span class="n">color_map</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> 
<span class="linenos" data-linenos="161 "></span>                       <span class="n">na_color</span><span class="o">=</span><span class="n">na_color</span><span class="p">,</span> <span class="n">na_in_legend</span><span class="o">=</span><span class="n">na_in_legend</span><span class="p">,</span> 
<span class="linenos" data-linenos="162 "></span>                       <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="n">frameon</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="n">legend_fontsize</span><span class="p">,</span> 
<span class="linenos" data-linenos="163 "></span>                       <span class="n">legend_fontweight</span><span class="o">=</span><span class="n">legend_fontweight</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">,</span> 
<span class="linenos" data-linenos="164 "></span>                       <span class="n">legend_fontoutline</span><span class="o">=</span><span class="n">legend_fontoutline</span><span class="p">,</span> <span class="n">colorbar_loc</span><span class="o">=</span><span class="n">colorbar_loc</span><span class="p">,</span> 
<span class="linenos" data-linenos="165 "></span>                       <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="n">vcenter</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> 
<span class="linenos" data-linenos="166 "></span>                       <span class="n">add_outline</span><span class="o">=</span><span class="n">add_outline</span><span class="p">,</span> <span class="n">outline_width</span><span class="o">=</span><span class="n">outline_width</span><span class="p">,</span> 
<span class="linenos" data-linenos="167 "></span>                       <span class="n">outline_color</span><span class="o">=</span><span class="n">outline_color</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span>
<span class="linenos" data-linenos="168 "></span>                         <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="linenos" data-linenos="169 "></span>                           <span class="n">return_fig</span><span class="o">=</span><span class="n">return_fig</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.embedding_celltype">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding_celltype</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">basis</span><span class="o">=</span><span class="s1">'umap'</span><span class="p">,</span> <span class="n">celltype_key</span><span class="o">=</span><span class="s1">'major_celltype'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">celltype_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">embedding_range</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=-</span><span class="mi">1000</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.embedding_celltype" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Plot embedding with celltype color by omicverse.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>AnnData object  </p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
<code>tuple</code>
</td>
<td><p>tuple, optional (default=(6,4))
Figure size</p></td>
<td>
<code>(6, 4)</code>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='umap')
Embedding method</p></td>
<td>
<code>'umap'</code>
</td>
</tr>
<tr>
<td><code>celltype_key</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='major_celltype')
Celltype key in adata.obs</p></td>
<td>
<code>'major_celltype'</code>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default=None)
Figure title</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>celltype_range</code></td>
<td>
<code>tuple</code>
</td>
<td><p>tuple, optional (default=(2,9))
Celltype range to plot</p></td>
<td>
<code>(2, 9)</code>
</td>
</tr>
<tr>
<td><code>embedding_range</code></td>
<td>
<code>tuple</code>
</td>
<td><p>tuple, optional (default=(3,10))
Embedding range to plot</p></td>
<td>
<code>(3, 10)</code>
</td>
</tr>
<tr>
<td><code>xlim</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=-1000)
X axis limit</p></td>
<td>
<code>-1000</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fig</code></td> <td>
<code>tuple</code>
</td>
<td><p>figure and axis</p></td>
</tr>
<tr>
<td><code>ax</code></td> <td>
<code>tuple</code>
</td>
<td><p>axis</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_single.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="281 "></span><span class="k">def</span> <span class="nf">embedding_celltype</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span><span class="n">AnnData</span><span class="p">,</span><span class="n">figsize</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">basis</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'umap'</span><span class="p">,</span>
<span class="linenos" data-linenos="282 "></span>                            <span class="n">celltype_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'major_celltype'</span><span class="p">,</span><span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="283 "></span>                            <span class="n">celltype_range</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span>
<span class="linenos" data-linenos="284 "></span>                            <span class="n">embedding_range</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
<span class="linenos" data-linenos="285 "></span>                            <span class="n">xlim</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1000</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
<span class="linenos" data-linenos="286 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos="287 "></span><span class="sd">    Plot embedding with celltype color by omicverse.</span>
<span class="linenos" data-linenos="288 "></span>
<span class="linenos" data-linenos="289 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="290 "></span><span class="sd">        adata: AnnData object  </span>
<span class="linenos" data-linenos="291 "></span><span class="sd">        figsize: tuple, optional (default=(6,4))</span>
<span class="linenos" data-linenos="292 "></span><span class="sd">            Figure size</span>
<span class="linenos" data-linenos="293 "></span><span class="sd">        basis: str, optional (default='umap')</span>
<span class="linenos" data-linenos="294 "></span><span class="sd">            Embedding method</span>
<span class="linenos" data-linenos="295 "></span><span class="sd">        celltype_key: str, optional (default='major_celltype')</span>
<span class="linenos" data-linenos="296 "></span><span class="sd">            Celltype key in adata.obs</span>
<span class="linenos" data-linenos="297 "></span><span class="sd">        title: str, optional (default=None)</span>
<span class="linenos" data-linenos="298 "></span><span class="sd">            Figure title</span>
<span class="linenos" data-linenos="299 "></span><span class="sd">        celltype_range: tuple, optional (default=(2,9))</span>
<span class="linenos" data-linenos="300 "></span><span class="sd">            Celltype range to plot</span>
<span class="linenos" data-linenos="301 "></span><span class="sd">        embedding_range: tuple, optional (default=(3,10))</span>
<span class="linenos" data-linenos="302 "></span><span class="sd">            Embedding range to plot</span>
<span class="linenos" data-linenos="303 "></span><span class="sd">        xlim: int, optional (default=-1000)</span>
<span class="linenos" data-linenos="304 "></span><span class="sd">            X axis limit</span>
<span class="linenos" data-linenos="305 "></span>
<span class="linenos" data-linenos="306 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="307 "></span><span class="sd">        fig: figure and axis</span>
<span class="linenos" data-linenos="308 "></span><span class="sd">        ax: axis</span>
<span class="linenos" data-linenos="309 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="310 "></span>
<span class="linenos" data-linenos="311 "></span>    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="linenos" data-linenos="312 "></span>    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="o">&gt;=</span><span class="s2">"2.0.0"</span><span class="p">:</span>
<span class="linenos" data-linenos="313 "></span>        <span class="n">cell_num_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="linenos" data-linenos="314 "></span>        <span class="n">cell_num_pd</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">=</span><span class="n">cell_num_pd</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span>
<span class="linenos" data-linenos="315 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="316 "></span>        <span class="n">cell_num_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="linenos" data-linenos="317 "></span>
<span class="linenos" data-linenos="318 "></span>    <span class="k">if</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">_colors'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">celltype_key</span><span class="p">)</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<span class="linenos" data-linenos="319 "></span>        <span class="n">cell_color_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<span class="linenos" data-linenos="320 "></span>                        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">'</span><span class="si">{}</span><span class="s1">_colors'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">celltype_key</span><span class="p">)]))</span>
<span class="linenos" data-linenos="321 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="322 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">28</span><span class="p">:</span>
<span class="linenos" data-linenos="323 "></span>            <span class="n">cell_color_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">default_102</span><span class="p">))</span>
<span class="linenos" data-linenos="324 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="325 "></span>            <span class="n">cell_color_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">zeileis_28</span><span class="p">))</span>
<span class="linenos" data-linenos="326 "></span>
<span class="linenos" data-linenos="327 "></span>    <span class="k">if</span> <span class="n">figsize</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="328 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="329 "></span>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="linenos" data-linenos="330 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="331 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s1">'The number of cell types is too large, please set the figsize parameter'</span><span class="p">)</span>
<span class="linenos" data-linenos="332 "></span>            <span class="k">return</span>
<span class="linenos" data-linenos="333 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="334 "></span>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="335 "></span>    <span class="n">grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="linenos" data-linenos="336 "></span>    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[:,</span> <span class="n">embedding_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">embedding_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>       <span class="c1"># 占据第一行的所有列</span>
<span class="linenos" data-linenos="337 "></span>    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">celltype_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">celltype_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> 
<span class="linenos" data-linenos="338 "></span>    <span class="c1"># 定义子图的大小和位置</span>
<span class="linenos" data-linenos="339 "></span>         <span class="c1"># 占据第二行的前两列</span>
<span class="linenos" data-linenos="340 "></span>    <span class="c1">#ax3 = fig.add_subplot(grid[1:, 2])      # 占据第二行及以后的最后一列</span>
<span class="linenos" data-linenos="341 "></span>    <span class="c1">#ax4 = fig.add_subplot(grid[2, 0])       # 占据最后一行的第一列</span>
<span class="linenos" data-linenos="342 "></span>    <span class="c1">#ax5 = fig.add_subplot(grid[2, 1])       # 占据最后一行的第二列</span>
<span class="linenos" data-linenos="343 "></span>
<span class="linenos" data-linenos="344 "></span>    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
<span class="linenos" data-linenos="345 "></span>        <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="346 "></span>        <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span>
<span class="linenos" data-linenos="347 "></span>        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">],</span>
<span class="linenos" data-linenos="348 "></span>        <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
<span class="linenos" data-linenos="349 "></span>        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="350 "></span>        <span class="c1">#wspace=0.65,</span>
<span class="linenos" data-linenos="351 "></span>        <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="linenos" data-linenos="352 "></span>        <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
<span class="linenos" data-linenos="353 "></span>        <span class="n">legend_loc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="354 "></span>        <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos" data-linenos="355 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="356 "></span>
<span class="linenos" data-linenos="357 "></span>
<span class="linenos" data-linenos="358 "></span>
<span class="linenos" data-linenos="359 "></span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">cell</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cell_num_pd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="linenos" data-linenos="360 "></span>                        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">):</span>
<span class="linenos" data-linenos="361 "></span>        <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span>
<span class="linenos" data-linenos="362 "></span>                <span class="n">cell</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">cell_color_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="linenos" data-linenos="363 "></span>        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="n">cell_num_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell</span><span class="p">,</span><span class="n">celltype_key</span><span class="p">]),(</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">),</span>
<span class="linenos" data-linenos="364 "></span>                <span class="n">c</span><span class="o">=</span><span class="n">cell_color_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="linenos" data-linenos="365 "></span>        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">idx</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span>
<span class="linenos" data-linenos="366 "></span>                <span class="n">cell</span><span class="o">+</span><span class="s1">'('</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s2">"</span><span class="si">{:,}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_num_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell</span><span class="p">,</span><span class="n">celltype_key</span><span class="p">]))</span><span class="o">+</span><span class="s1">')'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="linenos" data-linenos="367 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">,</span><span class="n">cell_num_pd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
<span class="linenos" data-linenos="368 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim</span><span class="p">,</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="linenos" data-linenos="369 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="370 "></span>    <span class="c1">#ax2.legend(bbox_to_anchor=(1.05, -0.05), loc=3, borderaxespad=0,fontsize=10,**legend_awargs)</span>
<span class="linenos" data-linenos="371 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="372 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="373 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="374 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="375 "></span>    <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<span class="linenos" data-linenos="376 "></span>
<span class="linenos" data-linenos="377 "></span>    <span class="c1"># ——关键：确保 ax2 没有图例——</span>
<span class="linenos" data-linenos="378 "></span>    <span class="k">if</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># 如果有，就移除</span>
<span class="linenos" data-linenos="379 "></span>        <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="linenos" data-linenos="380 "></span>    <span class="k">if</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># 如果有，就移除</span>
<span class="linenos" data-linenos="381 "></span>        <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="linenos" data-linenos="382 "></span>
<span class="linenos" data-linenos="383 "></span>    <span class="k">return</span> <span class="n">fig</span><span class="p">,[</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">]</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.embedding_adjust">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding_adjust</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> <span class="n">basis</span><span class="o">=</span><span class="s1">'X_umap'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adjust_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.embedding_adjust" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Get locations of cluster median and adjust text labels accordingly.</p>
<p>Borrowed from scanpy github forum.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
</td>
<td><p>AnnData object</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>groupby</code></td>
<td>
</td>
<td><p>str
Key in adata.obs for grouping</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>exclude</code></td>
<td>
</td>
<td><p>tuple, optional (default=())
Groups to exclude from labeling</p></td>
<td>
<code>()</code>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
</td>
<td><p>str, optional (default='X_umap')
Embedding basis key in adata.obsm</p></td>
<td>
<code>'X_umap'</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>matplotlib.axes.Axes, optional (default=None)
Axes object to plot on</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>adjust_kwargs</code></td>
<td>
</td>
<td><p>dict, optional (default=None)
Arguments for adjust_text function</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>text_kwargs</code></td>
<td>
</td>
<td><p>dict, optional (default=None)
Arguments for text annotation</p></td>
<td>
<code>None</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>medians</code></td> <td>
</td>
<td><p>dict
Dictionary of median positions for each group</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_single.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="434 "></span><span class="k">def</span> <span class="nf">embedding_adjust</span><span class="p">(</span>
<span class="linenos" data-linenos="435 "></span>    <span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> 
<span class="linenos" data-linenos="436 "></span>    <span class="n">basis</span><span class="o">=</span><span class="s1">'X_umap'</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adjust_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_kwargs</span><span class="o">=</span><span class="kc">None</span>
<span class="linenos" data-linenos="437 "></span><span class="p">):</span>
<span class="linenos" data-linenos="438 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos="439 "></span><span class="sd">    Get locations of cluster median and adjust text labels accordingly.</span>
<span class="linenos" data-linenos="440 "></span>
<span class="linenos" data-linenos="441 "></span><span class="sd">    Borrowed from scanpy github forum.</span>
<span class="linenos" data-linenos="442 "></span>
<span class="linenos" data-linenos="443 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="444 "></span><span class="sd">        adata: AnnData object</span>
<span class="linenos" data-linenos="445 "></span><span class="sd">        groupby: str</span>
<span class="linenos" data-linenos="446 "></span><span class="sd">            Key in adata.obs for grouping</span>
<span class="linenos" data-linenos="447 "></span><span class="sd">        exclude: tuple, optional (default=())</span>
<span class="linenos" data-linenos="448 "></span><span class="sd">            Groups to exclude from labeling</span>
<span class="linenos" data-linenos="449 "></span><span class="sd">        basis: str, optional (default='X_umap')</span>
<span class="linenos" data-linenos="450 "></span><span class="sd">            Embedding basis key in adata.obsm</span>
<span class="linenos" data-linenos="451 "></span><span class="sd">        ax: matplotlib.axes.Axes, optional (default=None)</span>
<span class="linenos" data-linenos="452 "></span><span class="sd">            Axes object to plot on</span>
<span class="linenos" data-linenos="453 "></span><span class="sd">        adjust_kwargs: dict, optional (default=None)</span>
<span class="linenos" data-linenos="454 "></span><span class="sd">            Arguments for adjust_text function</span>
<span class="linenos" data-linenos="455 "></span><span class="sd">        text_kwargs: dict, optional (default=None)</span>
<span class="linenos" data-linenos="456 "></span><span class="sd">            Arguments for text annotation</span>
<span class="linenos" data-linenos="457 "></span>
<span class="linenos" data-linenos="458 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="459 "></span><span class="sd">        medians: dict</span>
<span class="linenos" data-linenos="460 "></span><span class="sd">            Dictionary of median positions for each group</span>
<span class="linenos" data-linenos="461 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="462 "></span>    <span class="k">if</span> <span class="n">adjust_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="463 "></span>        <span class="n">adjust_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"text_from_points"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="linenos" data-linenos="464 "></span>    <span class="k">if</span> <span class="n">text_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="465 "></span>        <span class="n">text_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos" data-linenos="466 "></span>
<span class="linenos" data-linenos="467 "></span>    <span class="n">medians</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos" data-linenos="468 "></span>
<span class="linenos" data-linenos="469 "></span>    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">g_idx</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos" data-linenos="470 "></span>        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
<span class="linenos" data-linenos="471 "></span>            <span class="k">continue</span>
<span class="linenos" data-linenos="472 "></span>        <span class="n">medians</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">adata</span><span class="p">[</span><span class="n">g_idx</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">basis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos" data-linenos="473 "></span>
<span class="linenos" data-linenos="474 "></span>    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="475 "></span>        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="476 "></span>            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">text_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">medians</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos" data-linenos="477 "></span>        <span class="p">]</span>
<span class="linenos" data-linenos="478 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="479 "></span>        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">text_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">medians</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos" data-linenos="480 "></span>    <span class="kn">from</span> <span class="nn">adjustText</span> <span class="kn">import</span> <span class="n">adjust_text</span>
<span class="linenos" data-linenos="481 "></span>    <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="o">**</span><span class="n">adjust_kwargs</span><span class="p">)</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.embedding_atlas">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding_atlas</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'RdBu'</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">'right margin'</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="s1">'small'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.embedding_atlas" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create high-resolution embedding plots using Datashader for large datasets.</p>
<p>Uses Datashader to render embeddings at high resolution, suitable for datasets
with millions of cells where standard scatter plots become ineffective.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
</td>
<td><p>Annotated data object with embedding coordinates</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
</td>
<td><p>Key in adata.obsm containing embedding coordinates (e.g., 'X_umap')</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>color</code></td>
<td>
</td>
<td><p>Gene name or obs column to color cells by</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
</td>
<td><p>Plot title (None, uses color name)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
</td>
<td><p>Figure dimensions as (width, height) ((4,4))</p></td>
<td>
<code>(4, 4)</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>Existing matplotlib axes object (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>cmap</code></td>
<td>
</td>
<td><p>Colormap for continuous values ('RdBu')</p></td>
<td>
<code>'RdBu'</code>
</td>
</tr>
<tr>
<td><code>legend_loc</code></td>
<td>
</td>
<td><p>Legend position ('right margin')</p></td>
<td>
<code>'right margin'</code>
</td>
</tr>
<tr>
<td><code>frameon</code></td>
<td>
</td>
<td><p>Frame style - False, 'small', or True ('small')</p></td>
<td>
<code>'small'</code>
</td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>
</td>
<td><p>Font size for labels and title (12)</p></td>
<td>
<code>12</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td> <td>
</td>
<td><p>matplotlib.axes.Axes object with rendered embedding</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_embedding.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  7 "></span><span class="k">def</span> <span class="nf">embedding_atlas</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">color</span><span class="p">,</span>
<span class="linenos" data-linenos="  8 "></span>                    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">'RdBu'</span><span class="p">,</span>
<span class="linenos" data-linenos="  9 "></span>                    <span class="n">legend_loc</span> <span class="o">=</span> <span class="s1">'right margin'</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="s1">'small'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 10 "></span>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
<span class="linenos" data-linenos=" 11 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 12 "></span><span class="sd">    Create high-resolution embedding plots using Datashader for large datasets.</span>
<span class="linenos" data-linenos=" 13 "></span>
<span class="linenos" data-linenos=" 14 "></span><span class="sd">    Uses Datashader to render embeddings at high resolution, suitable for datasets</span>
<span class="linenos" data-linenos=" 15 "></span><span class="sd">    with millions of cells where standard scatter plots become ineffective.</span>
<span class="linenos" data-linenos=" 16 "></span>
<span class="linenos" data-linenos=" 17 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 18 "></span><span class="sd">        adata: Annotated data object with embedding coordinates</span>
<span class="linenos" data-linenos=" 19 "></span><span class="sd">        basis: Key in adata.obsm containing embedding coordinates (e.g., 'X_umap')</span>
<span class="linenos" data-linenos=" 20 "></span><span class="sd">        color: Gene name or obs column to color cells by</span>
<span class="linenos" data-linenos=" 21 "></span><span class="sd">        title: Plot title (None, uses color name)</span>
<span class="linenos" data-linenos=" 22 "></span><span class="sd">        figsize: Figure dimensions as (width, height) ((4,4))</span>
<span class="linenos" data-linenos=" 23 "></span><span class="sd">        ax: Existing matplotlib axes object (None)</span>
<span class="linenos" data-linenos=" 24 "></span><span class="sd">        cmap: Colormap for continuous values ('RdBu')</span>
<span class="linenos" data-linenos=" 25 "></span><span class="sd">        legend_loc: Legend position ('right margin')</span>
<span class="linenos" data-linenos=" 26 "></span><span class="sd">        frameon: Frame style - False, 'small', or True ('small')</span>
<span class="linenos" data-linenos=" 27 "></span><span class="sd">        fontsize: Font size for labels and title (12)</span>
<span class="linenos" data-linenos=" 28 "></span>
<span class="linenos" data-linenos=" 29 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos=" 30 "></span><span class="sd">        ax: matplotlib.axes.Axes object with rendered embedding</span>
<span class="linenos" data-linenos=" 31 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos=" 32 "></span>    <span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="linenos" data-linenos=" 33 "></span>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos=" 34 "></span>    <span class="kn">import</span> <span class="nn">datashader</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="linenos" data-linenos=" 35 "></span>    <span class="kn">import</span> <span class="nn">datashader.transfer_functions</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="linenos" data-linenos=" 36 "></span>    <span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">issparse</span>
<span class="linenos" data-linenos=" 37 "></span>    <span class="kn">from</span> <span class="nn">bokeh.palettes</span> <span class="kn">import</span> <span class="n">RdBu9</span>
<span class="linenos" data-linenos=" 38 "></span>    <span class="kn">import</span> <span class="nn">bokeh</span>
<span class="linenos" data-linenos=" 39 "></span>    <span class="c1"># 创建一个 Canvas 对象</span>
<span class="linenos" data-linenos=" 40 "></span>    <span class="n">cvs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">plot_width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="linenos" data-linenos=" 41 "></span>
<span class="linenos" data-linenos=" 42 "></span>
<span class="linenos" data-linenos=" 43 "></span>    <span class="n">embedding</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">basis</span><span class="p">]</span>
<span class="linenos" data-linenos=" 44 "></span>    <span class="c1"># 如果你有一个感兴趣的分类标签，比如细胞类型</span>
<span class="linenos" data-linenos=" 45 "></span>
<span class="linenos" data-linenos=" 46 "></span>    <span class="c1"># 将数据转换为 DataFrame</span>
<span class="linenos" data-linenos=" 47 "></span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">])</span>
<span class="linenos" data-linenos=" 48 "></span>
<span class="linenos" data-linenos=" 49 "></span>    <span class="k">if</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos" data-linenos=" 50 "></span>        <span class="n">labels</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># 假设'cell_type'是一个列名</span>
<span class="linenos" data-linenos=" 51 "></span>    <span class="k">elif</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">:</span>
<span class="linenos" data-linenos=" 52 "></span>        <span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
<span class="linenos" data-linenos=" 53 "></span>        <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="linenos" data-linenos=" 54 "></span>            <span class="n">labels</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos=" 55 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 56 "></span>            <span class="n">labels</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos=" 57 "></span>    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">color</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
<span class="linenos" data-linenos=" 58 "></span>        <span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">raw</span><span class="p">[:,</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
<span class="linenos" data-linenos=" 59 "></span>        <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="linenos" data-linenos=" 60 "></span>            <span class="n">labels</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos=" 61 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 62 "></span>            <span class="n">labels</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos=" 63 "></span>
<span class="linenos" data-linenos=" 64 "></span>
<span class="linenos" data-linenos=" 65 "></span>    <span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
<span class="linenos" data-linenos=" 66 "></span>    <span class="c1">#return labels</span>
<span class="linenos" data-linenos=" 67 "></span>    <span class="c1">#print(labels[0],type(labels[0]))</span>
<span class="linenos" data-linenos=" 68 "></span>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos" data-linenos=" 69 "></span>        <span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="linenos" data-linenos=" 70 "></span>        <span class="c1"># 聚合数据</span>
<span class="linenos" data-linenos=" 71 "></span>        <span class="n">agg</span> <span class="o">=</span> <span class="n">cvs</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">count_cat</span><span class="p">(</span><span class="s1">'label'</span><span class="p">),</span>
<span class="linenos" data-linenos=" 72 "></span>                        <span class="p">)</span>
<span class="linenos" data-linenos=" 73 "></span>        <span class="n">legend_tag</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos" data-linenos=" 74 "></span>        <span class="n">color_key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
<span class="linenos" data-linenos=" 75 "></span>                        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s1">_colors'</span><span class="p">]))</span>
<span class="linenos" data-linenos=" 76 "></span>
<span class="linenos" data-linenos=" 77 "></span>
<span class="linenos" data-linenos=" 78 "></span>        <span class="c1"># 使用色彩映射</span>
<span class="linenos" data-linenos=" 79 "></span>        <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">spread</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span><span class="n">px</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">color_key</span><span class="o">=</span><span class="p">[</span><span class="n">color_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">],</span> 
<span class="linenos" data-linenos=" 80 "></span>                       <span class="n">how</span><span class="o">=</span><span class="s1">'eq_hist'</span><span class="p">)</span>
<span class="linenos" data-linenos=" 81 "></span>    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>\
<span class="linenos" data-linenos=" 82 "></span>    <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">):</span>
<span class="linenos" data-linenos=" 83 "></span>        <span class="c1"># 聚合数据</span>
<span class="linenos" data-linenos=" 84 "></span>        <span class="n">agg</span> <span class="o">=</span> <span class="n">cvs</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">'label'</span><span class="p">),</span>
<span class="linenos" data-linenos=" 85 "></span>                        <span class="p">)</span>
<span class="linenos" data-linenos=" 86 "></span>        <span class="n">legend_tag</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos" data-linenos=" 87 "></span>        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">all_palettes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<span class="linenos" data-linenos=" 88 "></span>            <span class="n">num</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">all_palettes</span><span class="p">[</span><span class="n">cmap</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos" data-linenos=" 89 "></span>            <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">bokeh</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">all_palettes</span><span class="p">[</span><span class="n">cmap</span><span class="p">][</span><span class="n">num</span><span class="p">],</span> 
<span class="linenos" data-linenos=" 90 "></span>                           <span class="p">)</span>
<span class="linenos" data-linenos=" 91 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 92 "></span>            <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
<span class="linenos" data-linenos=" 93 "></span>                           <span class="p">)</span>
<span class="linenos" data-linenos=" 94 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 95 "></span>        <span class="nb">print</span><span class="p">(</span><span class="s1">'Unrecognized label type'</span><span class="p">)</span>
<span class="linenos" data-linenos=" 96 "></span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos" data-linenos=" 97 "></span>
<span class="linenos" data-linenos=" 98 "></span>
<span class="linenos" data-linenos=" 99 "></span>
<span class="linenos" data-linenos="100 "></span>        <span class="c1"># 假设 img 是 Datashader 渲染的图像</span>
<span class="linenos" data-linenos="101 "></span>    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="102 "></span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="103 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="104 "></span>        <span class="n">fig</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
<span class="linenos" data-linenos="105 "></span>
<span class="linenos" data-linenos="106 "></span>    <span class="c1"># 假设 img 是一个 NumPy 数组或类似的对象，这里使用 img 的占位符</span>
<span class="linenos" data-linenos="107 "></span>    <span class="c1"># img = np.random.rand(100, 100)  # 示例数据</span>
<span class="linenos" data-linenos="108 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">to_pil</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
<span class="linenos" data-linenos="109 "></span>
<span class="linenos" data-linenos="110 "></span>
<span class="linenos" data-linenos="111 "></span>    <span class="c1"># 自定义格式化函数以显示坐标</span>
<span class="linenos" data-linenos="112 "></span>    <span class="k">def</span> <span class="nf">format_coord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="linenos" data-linenos="113 "></span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="114 "></span>
<span class="linenos" data-linenos="115 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
<span class="linenos" data-linenos="116 "></span>
<span class="linenos" data-linenos="117 "></span>    <span class="k">if</span> <span class="n">legend_tag</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
<span class="linenos" data-linenos="118 "></span>        <span class="c1"># 手动创建图例</span>
<span class="linenos" data-linenos="119 "></span>        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
<span class="linenos" data-linenos="120 "></span>
<span class="linenos" data-linenos="121 "></span>        <span class="c1"># 创建图例项</span>
<span class="linenos" data-linenos="122 "></span>        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
<span class="linenos" data-linenos="123 "></span>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">color_key</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
<span class="linenos" data-linenos="124 "></span>
<span class="linenos" data-linenos="125 "></span>        <span class="k">if</span> <span class="n">legend_loc</span> <span class="o">==</span> <span class="s2">"right margin"</span><span class="p">:</span>
<span class="linenos" data-linenos="126 "></span>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
<span class="linenos" data-linenos="127 "></span>                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="128 "></span>                <span class="n">loc</span><span class="o">=</span><span class="s2">"center left"</span><span class="p">,</span>
<span class="linenos" data-linenos="129 "></span>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<span class="linenos" data-linenos="130 "></span>                <span class="n">ncol</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">14</span> <span class="k">else</span> <span class="mi">2</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">30</span> <span class="k">else</span> <span class="mi">3</span><span class="p">),</span>
<span class="linenos" data-linenos="131 "></span>                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="132 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="133 "></span>    <span class="k">if</span> <span class="n">frameon</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
<span class="linenos" data-linenos="134 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<span class="linenos" data-linenos="135 "></span>    <span class="k">elif</span> <span class="n">frameon</span><span class="o">==</span><span class="s1">'small'</span><span class="p">:</span>
<span class="linenos" data-linenos="136 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'on'</span><span class="p">)</span>
<span class="linenos" data-linenos="137 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="138 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="139 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="140 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="141 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="142 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="143 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_bounds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>
<span class="linenos" data-linenos="144 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_bounds</span><span class="p">(</span><span class="mi">650</span><span class="p">,</span><span class="mi">800</span><span class="p">)</span>
<span class="linenos" data-linenos="145 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s1">1'</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">'left'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="146 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s1">2'</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="147 "></span>
<span class="linenos" data-linenos="148 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="149 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'on'</span><span class="p">)</span>
<span class="linenos" data-linenos="150 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="151 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="152 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="153 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="154 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="155 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="156 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s1">1'</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="157 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s1">2'</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="158 "></span>
<span class="linenos" data-linenos="159 "></span>
<span class="linenos" data-linenos="160 "></span>    <span class="c1"># 调整坐标轴线的粗细</span>
<span class="linenos" data-linenos="161 "></span>    <span class="n">line_width</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># 设置线宽</span>
<span class="linenos" data-linenos="162 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">line_width</span><span class="p">)</span>
<span class="linenos" data-linenos="163 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">line_width</span><span class="p">)</span>
<span class="linenos" data-linenos="164 "></span>
<span class="linenos" data-linenos="165 "></span>
<span class="linenos" data-linenos="166 "></span>    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="167 "></span>        <span class="n">title</span><span class="o">=</span><span class="n">color</span>
<span class="linenos" data-linenos="168 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="169 "></span>
<span class="linenos" data-linenos="170 "></span>    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.embedding_multi">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding_multi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.embedding_multi" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create embedding scatter plots for multi-modal data (MuData) or single-cell data.</p>
<p>Produces scatter plots on specified embeddings, supporting cross-modality feature visualization.
For modality-specific embeddings, use format 'modality:embedding' (e.g., 'rna:X_pca').</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>data</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>AnnData or MuData object containing embedding and feature data</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
<code>str</code>
</td>
<td><p>Name of embedding in obsm (e.g., 'X_umap') or modality-specific ('rna:X_pca')</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>color</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]]</code>
</td>
<td><p>Gene names or obs columns to color points by (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>use_raw</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[bool]</code>
</td>
<td><p>Whether to use .raw attribute for features (None, auto-determined)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>layer</code></td>
<td>
<code><span title="typing.Optional">Optional</span>[str]</code>
</td>
<td><p>Specific data layer to use for coloring (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>**kwargs</code></td>
<td>
</td>
<td><p>Additional arguments passed to embedding plotting function</p></td>
<td>
<code>{}</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
</td>
<td><p>Plot axes or figure depending on underlying plotting function</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_multi.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 14 "></span><span class="k">def</span> <span class="nf">embedding_multi</span><span class="p">(</span>
<span class="linenos" data-linenos=" 15 "></span>    <span class="n">data</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos=" 16 "></span>    <span class="n">basis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos" data-linenos=" 17 "></span>    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 18 "></span>    <span class="n">use_raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 19 "></span>    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 20 "></span>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos" data-linenos=" 21 "></span><span class="p">):</span>
<span class="linenos" data-linenos=" 22 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 23 "></span><span class="sd">    Create embedding scatter plots for multi-modal data (MuData) or single-cell data.</span>
<span class="linenos" data-linenos=" 24 "></span>
<span class="linenos" data-linenos=" 25 "></span><span class="sd">    Produces scatter plots on specified embeddings, supporting cross-modality feature visualization.</span>
<span class="linenos" data-linenos=" 26 "></span><span class="sd">    For modality-specific embeddings, use format 'modality:embedding' (e.g., 'rna:X_pca').</span>
<span class="linenos" data-linenos=" 27 "></span>
<span class="linenos" data-linenos=" 28 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 29 "></span><span class="sd">        data: AnnData or MuData object containing embedding and feature data</span>
<span class="linenos" data-linenos=" 30 "></span><span class="sd">        basis: Name of embedding in obsm (e.g., 'X_umap') or modality-specific ('rna:X_pca')</span>
<span class="linenos" data-linenos=" 31 "></span><span class="sd">        color: Gene names or obs columns to color points by (None)</span>
<span class="linenos" data-linenos=" 32 "></span><span class="sd">        use_raw: Whether to use .raw attribute for features (None, auto-determined)</span>
<span class="linenos" data-linenos=" 33 "></span><span class="sd">        layer: Specific data layer to use for coloring (None)</span>
<span class="linenos" data-linenos=" 34 "></span><span class="sd">        **kwargs: Additional arguments passed to embedding plotting function</span>
<span class="linenos" data-linenos=" 35 "></span>
<span class="linenos" data-linenos=" 36 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos=" 37 "></span><span class="sd">        Plot axes or figure depending on underlying plotting function</span>
<span class="linenos" data-linenos=" 38 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos=" 39 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
<span class="linenos" data-linenos=" 40 "></span>        <span class="k">return</span> <span class="n">embedding</span><span class="p">(</span>
<span class="linenos" data-linenos=" 41 "></span>            <span class="n">data</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos" data-linenos=" 42 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos=" 43 "></span>
<span class="linenos" data-linenos=" 44 "></span>    <span class="c1"># `data` is MuData</span>
<span class="linenos" data-linenos=" 45 "></span>    <span class="k">if</span> <span class="n">basis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">obsm</span> <span class="ow">and</span> <span class="s2">"X_"</span> <span class="o">+</span> <span class="n">basis</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
<span class="linenos" data-linenos=" 46 "></span>        <span class="n">basis</span> <span class="o">=</span> <span class="s2">"X_"</span> <span class="o">+</span> <span class="n">basis</span>
<span class="linenos" data-linenos=" 47 "></span>
<span class="linenos" data-linenos=" 48 "></span>    <span class="k">if</span> <span class="n">basis</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
<span class="linenos" data-linenos=" 49 "></span>        <span class="n">adata</span> <span class="o">=</span> <span class="n">data</span>
<span class="linenos" data-linenos=" 50 "></span>        <span class="n">basis_mod</span> <span class="o">=</span> <span class="n">basis</span>
<span class="linenos" data-linenos=" 51 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 52 "></span>        <span class="c1"># basis is not a joint embedding</span>
<span class="linenos" data-linenos=" 53 "></span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos=" 54 "></span>            <span class="n">mod</span><span class="p">,</span> <span class="n">basis_mod</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 55 "></span>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos" data-linenos=" 56 "></span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Basis </span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s2"> is not present in the MuData object (.obsm)"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 57 "></span>
<span class="linenos" data-linenos=" 58 "></span>        <span class="k">if</span> <span class="n">mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>
<span class="linenos" data-linenos=" 59 "></span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos" data-linenos=" 60 "></span>                <span class="sa">f</span><span class="s2">"Modality </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2"> is not present in the MuData object with modalities </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos=" 61 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos=" 62 "></span>
<span class="linenos" data-linenos=" 63 "></span>        <span class="n">adata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>
<span class="linenos" data-linenos=" 64 "></span>        <span class="k">if</span> <span class="n">basis_mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
<span class="linenos" data-linenos=" 65 "></span>            <span class="k">if</span> <span class="s2">"X_"</span> <span class="o">+</span> <span class="n">basis_mod</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
<span class="linenos" data-linenos=" 66 "></span>                <span class="n">basis_mod</span> <span class="o">=</span> <span class="s2">"X_"</span> <span class="o">+</span> <span class="n">basis_mod</span>
<span class="linenos" data-linenos=" 67 "></span>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos=" 68 "></span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos" data-linenos=" 69 "></span>                    <span class="sa">f</span><span class="s2">"Basis </span><span class="si">{</span><span class="n">basis_mod</span><span class="si">}</span><span class="s2"> is not present in the modality </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2"> with embeddings </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos=" 70 "></span>                <span class="p">)</span>
<span class="linenos" data-linenos=" 71 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 72 "></span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos" data-linenos=" 73 "></span>                    <span class="sa">f</span><span class="s2">"Basis </span><span class="si">{</span><span class="n">basis_mod</span><span class="si">}</span><span class="s2"> is not present in the modality </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2"> with no embeddings"</span>
<span class="linenos" data-linenos=" 74 "></span>                <span class="p">)</span>
<span class="linenos" data-linenos=" 75 "></span>
<span class="linenos" data-linenos=" 76 "></span>    <span class="n">obs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="linenos" data-linenos=" 77 "></span>
<span class="linenos" data-linenos=" 78 "></span>    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos=" 79 "></span>        <span class="n">ad</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">obsm</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">,</span> <span class="n">obsp</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">)</span>
<span class="linenos" data-linenos=" 80 "></span>        <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis_mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos" data-linenos=" 81 "></span>
<span class="linenos" data-linenos=" 82 "></span>    <span class="c1"># Some `color` has been provided</span>
<span class="linenos" data-linenos=" 83 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos=" 84 "></span>        <span class="n">keys</span> <span class="o">=</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="p">]</span>
<span class="linenos" data-linenos=" 85 "></span>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
<span class="linenos" data-linenos=" 86 "></span>        <span class="n">keys</span> <span class="o">=</span> <span class="n">color</span>
<span class="linenos" data-linenos=" 87 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos=" 88 "></span>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected color to be a string or an iterable."</span><span class="p">)</span>
<span class="linenos" data-linenos=" 89 "></span>
<span class="linenos" data-linenos=" 90 "></span>    <span class="c1"># Fetch respective features</span>
<span class="linenos" data-linenos=" 91 "></span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="n">obs</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]):</span>
<span class="linenos" data-linenos=" 92 "></span>        <span class="c1"># {'rna': [True, False], 'prot': [False, True]}</span>
<span class="linenos" data-linenos=" 93 "></span>        <span class="n">keys_in_mod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">}</span>
<span class="linenos" data-linenos=" 94 "></span>
<span class="linenos" data-linenos=" 95 "></span>        <span class="c1"># .raw slots might have exclusive var_names</span>
<span class="linenos" data-linenos=" 96 "></span>        <span class="k">if</span> <span class="n">use_raw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos=" 97 "></span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
<span class="linenos" data-linenos=" 98 "></span>                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>
<span class="linenos" data-linenos=" 99 "></span>                    <span class="k">if</span> <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="100 "></span>                        <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="linenos" data-linenos="101 "></span>
<span class="linenos" data-linenos="102 "></span>        <span class="c1"># e.g. color="rna:CD8A" - especially relevant for mdata.axis == -1</span>
<span class="linenos" data-linenos="103 "></span>        <span class="n">mod_key_modifier</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="linenos" data-linenos="104 "></span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
<span class="linenos" data-linenos="105 "></span>            <span class="n">mod_key_modifier</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
<span class="linenos" data-linenos="106 "></span>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>
<span class="linenos" data-linenos="107 "></span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
<span class="linenos" data-linenos="108 "></span>                    <span class="n">k_clean</span> <span class="o">=</span> <span class="n">k</span>
<span class="linenos" data-linenos="109 "></span>                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">:"</span><span class="p">):</span>
<span class="linenos" data-linenos="110 "></span>                        <span class="n">k_clean</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos" data-linenos="111 "></span>
<span class="linenos" data-linenos="112 "></span>                    <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_clean</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span>
<span class="linenos" data-linenos="113 "></span>                    <span class="k">if</span> <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
<span class="linenos" data-linenos="114 "></span>                        <span class="n">mod_key_modifier</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_clean</span>
<span class="linenos" data-linenos="115 "></span>                    <span class="k">if</span> <span class="n">use_raw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos="116 "></span>                        <span class="k">if</span> <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="117 "></span>                            <span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_clean</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="linenos" data-linenos="118 "></span>
<span class="linenos" data-linenos="119 "></span>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>
<span class="linenos" data-linenos="120 "></span>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="121 "></span>                <span class="n">mod_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keys</span><span class="p">)[</span><span class="n">keys_in_mod</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span>
<span class="linenos" data-linenos="122 "></span>                <span class="n">mod_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mod_key_modifier</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mod_keys</span><span class="p">])</span>
<span class="linenos" data-linenos="123 "></span>
<span class="linenos" data-linenos="124 "></span>                <span class="k">if</span> <span class="n">use_raw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos="125 "></span>                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="126 "></span>                        <span class="n">keysidx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer_for</span><span class="p">(</span><span class="n">mod_keys</span><span class="p">)</span>
<span class="linenos" data-linenos="127 "></span>                        <span class="n">fmod_adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
<span class="linenos" data-linenos="128 "></span>                            <span class="n">X</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">keysidx</span><span class="p">],</span>
<span class="linenos" data-linenos="129 "></span>                            <span class="n">var</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">mod_keys</span><span class="p">),</span>
<span class="linenos" data-linenos="130 "></span>                            <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
<span class="linenos" data-linenos="131 "></span>                        <span class="p">)</span>
<span class="linenos" data-linenos="132 "></span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="133 "></span>                        <span class="k">if</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos="134 "></span>                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="linenos" data-linenos="135 "></span>                                <span class="sa">f</span><span class="s2">"Attibute .raw is None for the modality </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">, using .X instead"</span>
<span class="linenos" data-linenos="136 "></span>                            <span class="p">)</span>
<span class="linenos" data-linenos="137 "></span>                        <span class="n">fmod_adata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span> <span class="n">mod_keys</span><span class="p">]</span>
<span class="linenos" data-linenos="138 "></span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="139 "></span>                    <span class="n">fmod_adata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span> <span class="n">mod_keys</span><span class="p">]</span>
<span class="linenos" data-linenos="140 "></span>
<span class="linenos" data-linenos="141 "></span>                <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="142 "></span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
<span class="linenos" data-linenos="143 "></span>                        <span class="n">m_layer</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos" data-linenos="144 "></span>                        <span class="k">if</span> <span class="n">m_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="145 "></span>                            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span> <span class="n">mod_keys</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">m_layer</span><span class="p">]</span>
<span class="linenos" data-linenos="146 "></span>                            <span class="n">fmod_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span> <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
<span class="linenos" data-linenos="147 "></span>                            <span class="k">if</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos="148 "></span>                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Layer='</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">' superseded use_raw=</span><span class="si">{</span><span class="n">use_raw</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="149 "></span>                    <span class="k">elif</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<span class="linenos" data-linenos="150 "></span>                        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span> <span class="n">mod_keys</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
<span class="linenos" data-linenos="151 "></span>                        <span class="n">fmod_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span> <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
<span class="linenos" data-linenos="152 "></span>                        <span class="k">if</span> <span class="n">use_raw</span><span class="p">:</span>
<span class="linenos" data-linenos="153 "></span>                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Layer='</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">' superseded use_raw=</span><span class="si">{</span><span class="n">use_raw</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="154 "></span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="155 "></span>                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="linenos" data-linenos="156 "></span>                            <span class="sa">f</span><span class="s2">"Layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> is not present for the modality </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">, using count matrix instead"</span>
<span class="linenos" data-linenos="157 "></span>                        <span class="p">)</span>
<span class="linenos" data-linenos="158 "></span>                <span class="n">x</span> <span class="o">=</span> <span class="n">fmod_adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span> <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">fmod_adata</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="k">else</span> <span class="n">fmod_adata</span><span class="o">.</span><span class="n">X</span>
<span class="linenos" data-linenos="159 "></span>                <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos" data-linenos="160 "></span>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">mod_keys</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">fmod_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">),</span>
<span class="linenos" data-linenos="161 "></span>                    <span class="n">how</span><span class="o">=</span><span class="s2">"left"</span><span class="p">,</span>
<span class="linenos" data-linenos="162 "></span>                <span class="p">)</span>
<span class="linenos" data-linenos="163 "></span>
<span class="linenos" data-linenos="164 "></span>        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod_key_modifier</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
<span class="linenos" data-linenos="165 "></span>
<span class="linenos" data-linenos="166 "></span>    <span class="n">ad</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">obsm</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">,</span> <span class="n">obsp</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">,</span> <span class="n">uns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">)</span>
<span class="linenos" data-linenos="167 "></span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">embedding</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis_mod</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos" data-linenos="168 "></span>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="linenos" data-linenos="169 "></span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="170 "></span>            <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_colors"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_colors"</span><span class="p">]</span>
<span class="linenos" data-linenos="171 "></span>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="linenos" data-linenos="172 "></span>            <span class="k">pass</span>
<span class="linenos" data-linenos="173 "></span>    <span class="k">return</span> <span class="n">retval</span>
</code></pre></div>
</details>
</div>
</div><h2 id="cell-proportion-and-analysis">Cell Proportion and Analysis<a class="headerlink" href="#cell-proportion-and-analysis" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.cellproportion">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">cellproportion</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">celltype_clusters</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">groupby_li</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ticks_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">labels_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_awargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'ncol'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.cellproportion" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Plot cell proportion of each cell type in each visual cluster.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
<code><span title="anndata.AnnData">AnnData</span></code>
</td>
<td><p>AnnData object.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>celltype_clusters</code></td>
<td>
<code>str</code>
</td>
<td><p>Cell type clusters.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>groupby</code></td>
<td>
<code>str</code>
</td>
<td><p>Visual clusters.</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>groupby_li</code></td>
<td>
</td>
<td><p>Visual cluster list. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
<code>tuple</code>
</td>
<td><p>Figure size. ((4,6))</p></td>
<td>
<code>(4, 6)</code>
</td>
</tr>
<tr>
<td><code>ticks_fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>Ticks fontsize. (12)</p></td>
<td>
<code>12</code>
</td>
</tr>
<tr>
<td><code>labels_fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>Labels fontsize. (12)</p></td>
<td>
<code>12</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>Matplotlib axes object. (None)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>legend</code></td>
<td>
<code>bool</code>
</td>
<td><p>Whether to show legend. (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>legend_awargs</code></td>
<td>
</td>
<td><p>Legend arguments. ({'ncol':1})</p></td>
<td>
<code>{'ncol': 1}</code>
</td>
</tr>
<tr>
<td><code>transpose</code></td>
<td>
<code>bool</code>
</td>
<td><p>Whether to transpose the plot (horizontal bars). (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
</td>
<td><p>None</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_single.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="173 "></span><span class="k">def</span> <span class="nf">cellproportion</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span><span class="n">AnnData</span><span class="p">,</span><span class="n">celltype_clusters</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">groupby</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos" data-linenos="174 "></span>                       <span class="n">groupby_li</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
<span class="linenos" data-linenos="175 "></span>                       <span class="n">ticks_fontsize</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">labels_fontsize</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="176 "></span>                       <span class="n">legend</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend_awargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'ncol'</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="n">transpose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos" data-linenos="177 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""Plot cell proportion of each cell type in each visual cluster.</span>
<span class="linenos" data-linenos="178 "></span>
<span class="linenos" data-linenos="179 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="180 "></span><span class="sd">        adata: AnnData object.</span>
<span class="linenos" data-linenos="181 "></span><span class="sd">        celltype_clusters: Cell type clusters.</span>
<span class="linenos" data-linenos="182 "></span><span class="sd">        groupby: Visual clusters.</span>
<span class="linenos" data-linenos="183 "></span><span class="sd">        groupby_li: Visual cluster list. (None)</span>
<span class="linenos" data-linenos="184 "></span><span class="sd">        figsize: Figure size. ((4,6))</span>
<span class="linenos" data-linenos="185 "></span><span class="sd">        ticks_fontsize: Ticks fontsize. (12)</span>
<span class="linenos" data-linenos="186 "></span><span class="sd">        labels_fontsize: Labels fontsize. (12)</span>
<span class="linenos" data-linenos="187 "></span><span class="sd">        ax: Matplotlib axes object. (None)</span>
<span class="linenos" data-linenos="188 "></span><span class="sd">        legend: Whether to show legend. (False)</span>
<span class="linenos" data-linenos="189 "></span><span class="sd">        legend_awargs: Legend arguments. ({'ncol':1})</span>
<span class="linenos" data-linenos="190 "></span><span class="sd">        transpose: Whether to transpose the plot (horizontal bars). (False)</span>
<span class="linenos" data-linenos="191 "></span>
<span class="linenos" data-linenos="192 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="193 "></span><span class="sd">        None</span>
<span class="linenos" data-linenos="194 "></span>
<span class="linenos" data-linenos="195 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="196 "></span>
<span class="linenos" data-linenos="197 "></span>    <span class="n">b</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'cell_type'</span><span class="p">,</span><span class="s1">'value'</span><span class="p">,</span><span class="s1">'Week'</span><span class="p">])</span>
<span class="linenos" data-linenos="198 "></span>    <span class="n">visual_clusters</span><span class="o">=</span><span class="n">groupby</span>
<span class="linenos" data-linenos="199 "></span>    <span class="n">visual_li</span><span class="o">=</span><span class="n">groupby_li</span>
<span class="linenos" data-linenos="200 "></span>    <span class="k">if</span> <span class="n">visual_li</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="201 "></span>        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="linenos" data-linenos="202 "></span>        <span class="n">visual_li</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
<span class="linenos" data-linenos="203 "></span>
<span class="linenos" data-linenos="204 "></span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visual_li</span><span class="p">:</span>
<span class="linenos" data-linenos="205 "></span>        <span class="n">b1</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="linenos" data-linenos="206 "></span>        <span class="n">test</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="n">celltype_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="207 "></span>        <span class="n">b1</span><span class="p">[</span><span class="s1">'cell_type'</span><span class="p">]</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span>
<span class="linenos" data-linenos="208 "></span>        <span class="n">b1</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos" data-linenos="209 "></span>        <span class="n">b1</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'Retinoblastoma_'</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
<span class="linenos" data-linenos="210 "></span>        <span class="n">b</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">b</span><span class="p">,</span><span class="n">b1</span><span class="p">])</span>
<span class="linenos" data-linenos="211 "></span>
<span class="linenos" data-linenos="212 "></span>    <span class="n">plt_data2</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="213 "></span>    <span class="n">plot_data2_color_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
<span class="linenos" data-linenos="214 "></span>                                   <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">'</span><span class="si">{}</span><span class="s1">_colors'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">celltype_clusters</span><span class="p">)]))</span>
<span class="linenos" data-linenos="215 "></span>    <span class="n">plt_data3</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="216 "></span>    <span class="n">plot_data3_color_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'Retinoblastoma_'</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">visual_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">],</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">'</span><span class="si">{}</span><span class="s1">_colors'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">visual_clusters</span><span class="p">)]))</span>
<span class="linenos" data-linenos="217 "></span>    <span class="n">b</span><span class="p">[</span><span class="s1">'cell_type_color'</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">'cell_type'</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plot_data2_color_dict</span><span class="p">)</span>
<span class="linenos" data-linenos="218 "></span>    <span class="n">b</span><span class="p">[</span><span class="s1">'stage_color'</span><span class="p">]</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plot_data3_color_dict</span><span class="p">)</span>
<span class="linenos" data-linenos="219 "></span>
<span class="linenos" data-linenos="220 "></span>    <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="221 "></span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="222 "></span>    <span class="c1">#用ax控制图片</span>
<span class="linenos" data-linenos="223 "></span>    <span class="c1">#sns.set_theme(style="whitegrid")</span>
<span class="linenos" data-linenos="224 "></span>    <span class="c1">#sns.set_theme(style="ticks")</span>
<span class="linenos" data-linenos="225 "></span>    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
<span class="linenos" data-linenos="226 "></span>    <span class="n">all_celltype</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">celltype_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
<span class="linenos" data-linenos="227 "></span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_celltype</span><span class="p">:</span>
<span class="linenos" data-linenos="228 "></span>        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="229 "></span>            <span class="n">test1</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="s1">'cell_type'</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
<span class="linenos" data-linenos="230 "></span>            <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
<span class="linenos" data-linenos="231 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'value'</span><span class="p">],</span><span class="n">height</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test1</span><span class="p">[</span><span class="s1">'cell_type_color'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="232 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="233 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">],</span><span class="n">height</span><span class="o">=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'value'</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test1</span><span class="p">[</span><span class="s1">'cell_type_color'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="234 "></span>            <span class="n">bottoms</span><span class="o">=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos" data-linenos="235 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="236 "></span>            <span class="n">test2</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="s1">'cell_type'</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
<span class="linenos" data-linenos="237 "></span>            <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
<span class="linenos" data-linenos="238 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">test2</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">test2</span><span class="p">[</span><span class="s1">'value'</span><span class="p">],</span><span class="n">left</span><span class="o">=</span><span class="n">bottoms</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test2</span><span class="p">[</span><span class="s1">'cell_type_color'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="239 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="240 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test2</span><span class="p">[</span><span class="s1">'Week'</span><span class="p">],</span><span class="n">height</span><span class="o">=</span><span class="n">test2</span><span class="p">[</span><span class="s1">'value'</span><span class="p">],</span><span class="n">bottom</span><span class="o">=</span><span class="n">bottoms</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test2</span><span class="p">[</span><span class="s1">'cell_type_color'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="241 "></span>            <span class="n">test1</span><span class="o">=</span><span class="n">test2</span>
<span class="linenos" data-linenos="242 "></span>            <span class="n">bottoms</span><span class="o">+=</span><span class="n">test1</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos" data-linenos="243 "></span>        <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
<span class="linenos" data-linenos="244 "></span>    <span class="k">if</span> <span class="n">legend</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
<span class="linenos" data-linenos="245 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="o">**</span><span class="n">legend_awargs</span><span class="p">)</span>
<span class="linenos" data-linenos="246 "></span>
<span class="linenos" data-linenos="247 "></span>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="248 "></span>
<span class="linenos" data-linenos="249 "></span>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="250 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="251 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="252 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="253 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="254 "></span>
<span class="linenos" data-linenos="255 "></span>    <span class="c1"># 设置左边和下边的坐标刻度为透明色</span>
<span class="linenos" data-linenos="256 "></span>    <span class="c1">#ax.yaxis.tick_left()</span>
<span class="linenos" data-linenos="257 "></span>    <span class="c1">#ax.xaxis.tick_bottom()</span>
<span class="linenos" data-linenos="258 "></span>    <span class="c1">#ax.xaxis.set_tick_params(color='none')</span>
<span class="linenos" data-linenos="259 "></span>    <span class="c1">#ax.yaxis.set_tick_params(color='none')</span>
<span class="linenos" data-linenos="260 "></span>
<span class="linenos" data-linenos="261 "></span>    <span class="c1"># 设置左边和下边的坐标轴线为独立的线段</span>
<span class="linenos" data-linenos="262 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="263 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="264 "></span>
<span class="linenos" data-linenos="265 "></span>    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
<span class="linenos" data-linenos="266 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos" data-linenos="267 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="268 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">labels_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="269 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Cells per Stage'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">labels_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="270 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="271 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="linenos" data-linenos="272 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="273 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">labels_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="274 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Cells per Stage'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">labels_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="275 "></span>    <span class="c1">#fig.tight_layout()</span>
<span class="linenos" data-linenos="276 "></span>    <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="277 "></span>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div><h2 id="bulk-data-visualization">Bulk Data Visualization<a class="headerlink" href="#bulk-data-visualization" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.volcano">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">volcano</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pval_name</span><span class="o">=</span><span class="s1">'qvalue'</span><span class="p">,</span> <span class="n">fc_name</span><span class="o">=</span><span class="s1">'log2FC'</span><span class="p">,</span> <span class="n">pval_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">FC_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">titlefont</span><span class="o">=</span><span class="p">{</span><span class="s1">'weight'</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="mi">14</span><span class="p">},</span> <span class="n">up_color</span><span class="o">=</span><span class="s1">'#e25d5d'</span><span class="p">,</span> <span class="n">down_color</span><span class="o">=</span><span class="s1">'#7388c1'</span><span class="p">,</span> <span class="n">normal_color</span><span class="o">=</span><span class="s1">'#d7d7d7'</span><span class="p">,</span> <span class="n">up_fontcolor</span><span class="o">=</span><span class="s1">'#e25d5d'</span><span class="p">,</span> <span class="n">down_fontcolor</span><span class="o">=</span><span class="s1">'#7388c1'</span><span class="p">,</span> <span class="n">normal_fontcolor</span><span class="o">=</span><span class="s1">'#d7d7d7'</span><span class="p">,</span> <span class="n">legend_bbox</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">legend_ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">plot_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_genes_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">plot_genes_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ticks_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fc_max</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fc_min</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.volcano" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create a volcano plot for differential expression analysis.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>result</code></td>
<td>
</td>
<td><p>pandas.DataFrame
Dataframe containing differential expression results with 'sig' column</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>pval_name</code></td>
<td>
</td>
<td><p>str, optional (default='qvalue')
Column name for p-values/q-values</p></td>
<td>
<code>'qvalue'</code>
</td>
</tr>
<tr>
<td><code>fc_name</code></td>
<td>
</td>
<td><p>str, optional (default='log2FC')
Column name for fold change values  </p></td>
<td>
<code>'log2FC'</code>
</td>
</tr>
<tr>
<td><code>pval_max</code></td>
<td>
</td>
<td><p>float, optional (default=None)
Maximum p-value for y-axis scaling</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>FC_max</code></td>
<td>
</td>
<td><p>float, optional (default=None)
Maximum fold change for x-axis scaling</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
<code>tuple</code>
</td>
<td><p>tuple, optional (default=(4,4))
Figure size (width, height)</p></td>
<td>
<code>(4, 4)</code>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='')
Plot title</p></td>
<td>
<code>''</code>
</td>
</tr>
<tr>
<td><code>titlefont</code></td>
<td>
<code>dict</code>
</td>
<td><p>dict, optional (default={'weight':'normal','size':14})
Font settings for title and axis labels</p></td>
<td>
<code>{'weight': 'normal', 'size': 14}</code>
</td>
</tr>
<tr>
<td><code>up_color</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#e25d5d')
Color for upregulated genes</p></td>
<td>
<code>'#e25d5d'</code>
</td>
</tr>
<tr>
<td><code>down_color</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#7388c1')
Color for downregulated genes</p></td>
<td>
<code>'#7388c1'</code>
</td>
</tr>
<tr>
<td><code>normal_color</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#d7d7d7')
Color for non-significant genes</p></td>
<td>
<code>'#d7d7d7'</code>
</td>
</tr>
<tr>
<td><code>up_fontcolor</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#e25d5d')
Font color for upregulated gene labels</p></td>
<td>
<code>'#e25d5d'</code>
</td>
</tr>
<tr>
<td><code>down_fontcolor</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#7388c1')
Font color for downregulated gene labels</p></td>
<td>
<code>'#7388c1'</code>
</td>
</tr>
<tr>
<td><code>normal_fontcolor</code></td>
<td>
<code>str</code>
</td>
<td><p>str, optional (default='#d7d7d7')
Font color for normal gene labels</p></td>
<td>
<code>'#d7d7d7'</code>
</td>
</tr>
<tr>
<td><code>legend_bbox</code></td>
<td>
<code>tuple</code>
</td>
<td><p>tuple, optional (default=(0.8, -0.2))
Legend bounding box position</p></td>
<td>
<code>(0.8, -0.2)</code>
</td>
</tr>
<tr>
<td><code>legend_ncol</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=2)
Number of legend columns</p></td>
<td>
<code>2</code>
</td>
</tr>
<tr>
<td><code>legend_fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=12)
Legend font size</p></td>
<td>
<code>12</code>
</td>
</tr>
<tr>
<td><code>plot_genes</code></td>
<td>
<code>list</code>
</td>
<td><p>list, optional (default=None)
Specific genes to label on plot</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>plot_genes_num</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=10)
Number of top genes to label automatically</p></td>
<td>
<code>10</code>
</td>
</tr>
<tr>
<td><code>plot_genes_fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=10)
Font size for gene labels</p></td>
<td>
<code>10</code>
</td>
</tr>
<tr>
<td><code>ticks_fontsize</code></td>
<td>
<code>int</code>
</td>
<td><p>int, optional (default=12)
Font size for axis ticks</p></td>
<td>
<code>12</code>
</td>
</tr>
<tr>
<td><code>pval_threshold</code></td>
<td>
<code>float</code>
</td>
<td><p>float, optional (default=0.05)
P-value threshold for significance</p></td>
<td>
<code>0.05</code>
</td>
</tr>
<tr>
<td><code>fc_max</code></td>
<td>
<code>float</code>
</td>
<td><p>float, optional (default=1.5)
Upper fold change threshold</p></td>
<td>
<code>1.5</code>
</td>
</tr>
<tr>
<td><code>fc_min</code></td>
<td>
<code>float</code>
</td>
<td><p>float, optional (default=-1.5)
Lower fold change threshold</p></td>
<td>
<code>-1.5</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>matplotlib.axes, optional (default=None)
Existing axes to plot on</p></td>
<td>
<code>None</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td> <td>
</td>
<td><p>matplotlib.axes
The plot axes object</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_bulk.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  9 "></span><span class="k">def</span> <span class="nf">volcano</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">pval_name</span><span class="o">=</span><span class="s1">'qvalue'</span><span class="p">,</span><span class="n">fc_name</span><span class="o">=</span><span class="s1">'log2FC'</span><span class="p">,</span><span class="n">pval_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">FC_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos=" 10 "></span>            <span class="n">figsize</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">titlefont</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">'weight'</span><span class="p">:</span><span class="s1">'normal'</span><span class="p">,</span><span class="s1">'size'</span><span class="p">:</span><span class="mi">14</span><span class="p">,},</span>
<span class="linenos" data-linenos=" 11 "></span>                     <span class="n">up_color</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#e25d5d'</span><span class="p">,</span><span class="n">down_color</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#7388c1'</span><span class="p">,</span><span class="n">normal_color</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#d7d7d7'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 12 "></span>                     <span class="n">up_fontcolor</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#e25d5d'</span><span class="p">,</span><span class="n">down_fontcolor</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#7388c1'</span><span class="p">,</span><span class="n">normal_fontcolor</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'#d7d7d7'</span><span class="p">,</span>
<span class="linenos" data-linenos=" 13 "></span>                     <span class="n">legend_bbox</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">),</span><span class="n">legend_ncol</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">legend_fontsize</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="linenos" data-linenos=" 14 "></span>                     <span class="n">plot_genes</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_genes_num</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">plot_genes_fontsize</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos=" 15 "></span>                     <span class="n">ticks_fontsize</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">pval_threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">fc_max</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">fc_min</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span>
<span class="linenos" data-linenos=" 16 "></span>                     <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,):</span>
<span class="linenos" data-linenos=" 17 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 18 "></span><span class="sd">    Create a volcano plot for differential expression analysis.</span>
<span class="linenos" data-linenos=" 19 "></span>
<span class="linenos" data-linenos=" 20 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 21 "></span><span class="sd">        result: pandas.DataFrame</span>
<span class="linenos" data-linenos=" 22 "></span><span class="sd">            Dataframe containing differential expression results with 'sig' column</span>
<span class="linenos" data-linenos=" 23 "></span><span class="sd">        pval_name: str, optional (default='qvalue')</span>
<span class="linenos" data-linenos=" 24 "></span><span class="sd">            Column name for p-values/q-values</span>
<span class="linenos" data-linenos=" 25 "></span><span class="sd">        fc_name: str, optional (default='log2FC')</span>
<span class="linenos" data-linenos=" 26 "></span><span class="sd">            Column name for fold change values  </span>
<span class="linenos" data-linenos=" 27 "></span><span class="sd">        pval_max: float, optional (default=None)</span>
<span class="linenos" data-linenos=" 28 "></span><span class="sd">            Maximum p-value for y-axis scaling</span>
<span class="linenos" data-linenos=" 29 "></span><span class="sd">        FC_max: float, optional (default=None)</span>
<span class="linenos" data-linenos=" 30 "></span><span class="sd">            Maximum fold change for x-axis scaling</span>
<span class="linenos" data-linenos=" 31 "></span><span class="sd">        figsize: tuple, optional (default=(4,4))</span>
<span class="linenos" data-linenos=" 32 "></span><span class="sd">            Figure size (width, height)</span>
<span class="linenos" data-linenos=" 33 "></span><span class="sd">        title: str, optional (default='')</span>
<span class="linenos" data-linenos=" 34 "></span><span class="sd">            Plot title</span>
<span class="linenos" data-linenos=" 35 "></span><span class="sd">        titlefont: dict, optional (default={'weight':'normal','size':14})</span>
<span class="linenos" data-linenos=" 36 "></span><span class="sd">            Font settings for title and axis labels</span>
<span class="linenos" data-linenos=" 37 "></span><span class="sd">        up_color: str, optional (default='#e25d5d')</span>
<span class="linenos" data-linenos=" 38 "></span><span class="sd">            Color for upregulated genes</span>
<span class="linenos" data-linenos=" 39 "></span><span class="sd">        down_color: str, optional (default='#7388c1')</span>
<span class="linenos" data-linenos=" 40 "></span><span class="sd">            Color for downregulated genes</span>
<span class="linenos" data-linenos=" 41 "></span><span class="sd">        normal_color: str, optional (default='#d7d7d7')</span>
<span class="linenos" data-linenos=" 42 "></span><span class="sd">            Color for non-significant genes</span>
<span class="linenos" data-linenos=" 43 "></span><span class="sd">        up_fontcolor: str, optional (default='#e25d5d')</span>
<span class="linenos" data-linenos=" 44 "></span><span class="sd">            Font color for upregulated gene labels</span>
<span class="linenos" data-linenos=" 45 "></span><span class="sd">        down_fontcolor: str, optional (default='#7388c1')</span>
<span class="linenos" data-linenos=" 46 "></span><span class="sd">            Font color for downregulated gene labels</span>
<span class="linenos" data-linenos=" 47 "></span><span class="sd">        normal_fontcolor: str, optional (default='#d7d7d7')</span>
<span class="linenos" data-linenos=" 48 "></span><span class="sd">            Font color for normal gene labels</span>
<span class="linenos" data-linenos=" 49 "></span><span class="sd">        legend_bbox: tuple, optional (default=(0.8, -0.2))</span>
<span class="linenos" data-linenos=" 50 "></span><span class="sd">            Legend bounding box position</span>
<span class="linenos" data-linenos=" 51 "></span><span class="sd">        legend_ncol: int, optional (default=2)</span>
<span class="linenos" data-linenos=" 52 "></span><span class="sd">            Number of legend columns</span>
<span class="linenos" data-linenos=" 53 "></span><span class="sd">        legend_fontsize: int, optional (default=12)</span>
<span class="linenos" data-linenos=" 54 "></span><span class="sd">            Legend font size</span>
<span class="linenos" data-linenos=" 55 "></span><span class="sd">        plot_genes: list, optional (default=None)</span>
<span class="linenos" data-linenos=" 56 "></span><span class="sd">            Specific genes to label on plot</span>
<span class="linenos" data-linenos=" 57 "></span><span class="sd">        plot_genes_num: int, optional (default=10)</span>
<span class="linenos" data-linenos=" 58 "></span><span class="sd">            Number of top genes to label automatically</span>
<span class="linenos" data-linenos=" 59 "></span><span class="sd">        plot_genes_fontsize: int, optional (default=10)</span>
<span class="linenos" data-linenos=" 60 "></span><span class="sd">            Font size for gene labels</span>
<span class="linenos" data-linenos=" 61 "></span><span class="sd">        ticks_fontsize: int, optional (default=12)</span>
<span class="linenos" data-linenos=" 62 "></span><span class="sd">            Font size for axis ticks</span>
<span class="linenos" data-linenos=" 63 "></span><span class="sd">        pval_threshold: float, optional (default=0.05)</span>
<span class="linenos" data-linenos=" 64 "></span><span class="sd">            P-value threshold for significance</span>
<span class="linenos" data-linenos=" 65 "></span><span class="sd">        fc_max: float, optional (default=1.5)</span>
<span class="linenos" data-linenos=" 66 "></span><span class="sd">            Upper fold change threshold</span>
<span class="linenos" data-linenos=" 67 "></span><span class="sd">        fc_min: float, optional (default=-1.5)</span>
<span class="linenos" data-linenos=" 68 "></span><span class="sd">            Lower fold change threshold</span>
<span class="linenos" data-linenos=" 69 "></span><span class="sd">        ax: matplotlib.axes, optional (default=None)</span>
<span class="linenos" data-linenos=" 70 "></span><span class="sd">            Existing axes to plot on</span>
<span class="linenos" data-linenos=" 71 "></span>
<span class="linenos" data-linenos=" 72 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos=" 73 "></span><span class="sd">        ax: matplotlib.axes</span>
<span class="linenos" data-linenos=" 74 "></span><span class="sd">            The plot axes object</span>
<span class="linenos" data-linenos=" 75 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos=" 76 "></span>
<span class="linenos" data-linenos=" 77 "></span>    <span class="c1"># Color codes for terminal output</span>
<span class="linenos" data-linenos=" 78 "></span>    <span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
<span class="linenos" data-linenos=" 79 "></span>        <span class="n">HEADER</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[95m'</span>
<span class="linenos" data-linenos=" 80 "></span>        <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[94m'</span>
<span class="linenos" data-linenos=" 81 "></span>        <span class="n">CYAN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[96m'</span>
<span class="linenos" data-linenos=" 82 "></span>        <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[92m'</span>
<span class="linenos" data-linenos=" 83 "></span>        <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[93m'</span>
<span class="linenos" data-linenos=" 84 "></span>        <span class="n">FAIL</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[91m'</span>
<span class="linenos" data-linenos=" 85 "></span>        <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[0m'</span>
<span class="linenos" data-linenos=" 86 "></span>        <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[1m'</span>
<span class="linenos" data-linenos=" 87 "></span>        <span class="n">UNDERLINE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[4m'</span>
<span class="linenos" data-linenos=" 88 "></span>
<span class="linenos" data-linenos=" 89 "></span>    <span class="c1"># Analyze the input data</span>
<span class="linenos" data-linenos=" 90 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">🌋 Volcano Plot Analysis:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 91 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Total genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 92 "></span>
<span class="linenos" data-linenos=" 93 "></span>    <span class="c1"># Check required columns</span>
<span class="linenos" data-linenos=" 94 "></span>    <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">pval_name</span><span class="p">,</span> <span class="n">fc_name</span><span class="p">,</span> <span class="s1">'sig'</span><span class="p">]</span>
<span class="linenos" data-linenos=" 95 "></span>    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="linenos" data-linenos=" 96 "></span>    <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
<span class="linenos" data-linenos=" 97 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">FAIL</span><span class="si">}</span><span class="s2">❌ Missing required columns: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">missing_cols</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 98 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Missing required columns: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos=" 99 "></span>
<span class="linenos" data-linenos="100 "></span>    <span class="c1"># Calculate gene counts by significance</span>
<span class="linenos" data-linenos="101 "></span>    <span class="n">sig_counts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="linenos" data-linenos="102 "></span>    <span class="n">total_sig</span> <span class="o">=</span> <span class="n">sig_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'up'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">sig_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'down'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos" data-linenos="103 "></span>
<span class="linenos" data-linenos="104 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">↗️  Upregulated genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">sig_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'up'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="105 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">↘️  Downregulated genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">sig_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'down'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="106 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">➡️  Non-significant genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">sig_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'normal'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="107 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">🎯 Total significant genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">total_sig</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="108 "></span>
<span class="linenos" data-linenos="109 "></span>    <span class="c1"># Data range information</span>
<span class="linenos" data-linenos="110 "></span>    <span class="n">fc_range</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="linenos" data-linenos="111 "></span>    <span class="n">pval_range</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">pval_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="n">pval_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="linenos" data-linenos="112 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}{</span><span class="n">fc_name</span><span class="si">}</span><span class="s2"> range: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="113 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}{</span><span class="n">pval_name</span><span class="si">}</span><span class="s2"> range: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="n">pval_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">pval_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="114 "></span>
<span class="linenos" data-linenos="115 "></span>    <span class="c1"># Display current function parameters</span>
<span class="linenos" data-linenos="116 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">⚙️  Current Function Parameters:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="117 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Data columns: pval_name='</span><span class="si">{</span><span class="n">pval_name</span><span class="si">}</span><span class="s2">', fc_name='</span><span class="si">{</span><span class="n">fc_name</span><span class="si">}</span><span class="s2">'</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="118 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Thresholds: pval_threshold=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">pval_threshold</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, fc_max=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fc_max</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, fc_min=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fc_min</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="119 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Plot size: figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="120 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Gene labels: plot_genes_num=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">plot_genes_num</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, plot_genes_fontsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">plot_genes_fontsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="121 "></span>    <span class="k">if</span> <span class="n">plot_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="122 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Custom genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_genes</span><span class="p">)</span><span class="si">}</span><span class="s2"> specified</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="123 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="124 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Custom genes: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">None</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2"> (auto-select top genes)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="125 "></span>
<span class="linenos" data-linenos="126 "></span>    <span class="c1"># Parameter optimization suggestions</span>
<span class="linenos" data-linenos="127 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">💡 Parameter Optimization Suggestions:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="128 "></span>    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="129 "></span>
<span class="linenos" data-linenos="130 "></span>    <span class="c1"># Check if there are enough significant genes</span>
<span class="linenos" data-linenos="131 "></span>    <span class="k">if</span> <span class="n">total_sig</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="132 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Few significant genes detected (</span><span class="si">{</span><span class="n">total_sig</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="133 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: pval_threshold=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">pval_threshold</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="134 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">pval_threshold=0.1</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">pval_threshold=0.2</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="135 "></span>
<span class="linenos" data-linenos="136 "></span>    <span class="c1"># Check fold change thresholds</span>
<span class="linenos" data-linenos="137 "></span>    <span class="k">if</span> <span class="n">fc_range</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fc_max</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fc_min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos" data-linenos="138 "></span>        <span class="n">new_fc_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="linenos" data-linenos="139 "></span>        <span class="n">new_fc_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">)</span>
<span class="linenos" data-linenos="140 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Wide fold change range detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="141 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: fc_max=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fc_max</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">, fc_min=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fc_min</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="142 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">fc_max=</span><span class="si">{</span><span class="n">new_fc_max</span><span class="si">}</span><span class="s2">, fc_min=</span><span class="si">{</span><span class="n">new_fc_min</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="143 "></span>
<span class="linenos" data-linenos="144 "></span>    <span class="c1"># Check plot size based on gene label settings</span>
<span class="linenos" data-linenos="145 "></span>    <span class="k">if</span> <span class="n">plot_genes_num</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos" data-linenos="146 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Many gene labels with small plot:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="147 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: plot_genes_num=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">plot_genes_num</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">, figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="148 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(6, 6)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">plot_genes_num=15</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="149 "></span>
<span class="linenos" data-linenos="150 "></span>    <span class="c1"># Check if gene labels might be too small</span>
<span class="linenos" data-linenos="151 "></span>    <span class="k">if</span> <span class="n">plot_genes_fontsize</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">plot_genes_num</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
<span class="linenos" data-linenos="152 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Small font with many labels:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="153 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: plot_genes_fontsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">plot_genes_fontsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">, plot_genes_num=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">plot_genes_num</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="154 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">plot_genes_fontsize=10</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">plot_genes_num=10</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="155 "></span>
<span class="linenos" data-linenos="156 "></span>    <span class="c1"># Check figure aspect ratio</span>
<span class="linenos" data-linenos="157 "></span>    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos" data-linenos="158 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">▶ Unbalanced figure dimensions:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="159 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="160 "></span>        <span class="n">optimal_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="161 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(</span><span class="si">{</span><span class="n">optimal_size</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">optimal_size</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="162 "></span>
<span class="linenos" data-linenos="163 "></span>    <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="164 "></span>        <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="165 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
<span class="linenos" data-linenos="166 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📋 Copy-paste ready function call:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="167 "></span>
<span class="linenos" data-linenos="168 "></span>        <span class="c1"># Generate optimized function call</span>
<span class="linenos" data-linenos="169 "></span>        <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"result"</span><span class="p">]</span>
<span class="linenos" data-linenos="170 "></span>
<span class="linenos" data-linenos="171 "></span>        <span class="c1"># Add data column parameters if different from defaults</span>
<span class="linenos" data-linenos="172 "></span>        <span class="k">if</span> <span class="n">pval_name</span> <span class="o">!=</span> <span class="s1">'qvalue'</span><span class="p">:</span>
<span class="linenos" data-linenos="173 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pval_name='</span><span class="si">{</span><span class="n">pval_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos" data-linenos="174 "></span>        <span class="k">if</span> <span class="n">fc_name</span> <span class="o">!=</span> <span class="s1">'log2FC'</span><span class="p">:</span>
<span class="linenos" data-linenos="175 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fc_name='</span><span class="si">{</span><span class="n">fc_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos" data-linenos="176 "></span>
<span class="linenos" data-linenos="177 "></span>        <span class="c1"># Add optimized parameters based on suggestions</span>
<span class="linenos" data-linenos="178 "></span>        <span class="k">if</span> <span class="n">total_sig</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="179 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"pval_threshold=0.1"</span><span class="p">)</span>
<span class="linenos" data-linenos="180 "></span>
<span class="linenos" data-linenos="181 "></span>        <span class="k">if</span> <span class="n">fc_range</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fc_max</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fc_min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos" data-linenos="182 "></span>            <span class="n">new_fc_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="linenos" data-linenos="183 "></span>            <span class="n">new_fc_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">)</span>
<span class="linenos" data-linenos="184 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fc_max=</span><span class="si">{</span><span class="n">new_fc_max</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="185 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fc_min=</span><span class="si">{</span><span class="n">new_fc_min</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="186 "></span>
<span class="linenos" data-linenos="187 "></span>        <span class="k">if</span> <span class="n">plot_genes_num</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos" data-linenos="188 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"figsize=(6, 6)"</span><span class="p">)</span>
<span class="linenos" data-linenos="189 "></span>        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos" data-linenos="190 "></span>            <span class="n">optimal_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="191 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"figsize=(</span><span class="si">{</span><span class="n">optimal_size</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">optimal_size</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<span class="linenos" data-linenos="192 "></span>
<span class="linenos" data-linenos="193 "></span>        <span class="k">if</span> <span class="n">plot_genes_fontsize</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">plot_genes_num</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
<span class="linenos" data-linenos="194 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"plot_genes_fontsize=10"</span><span class="p">)</span>
<span class="linenos" data-linenos="195 "></span>
<span class="linenos" data-linenos="196 "></span>        <span class="k">if</span> <span class="n">plot_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="197 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"plot_genes=</span><span class="si">{</span><span class="n">plot_genes</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="198 "></span>
<span class="linenos" data-linenos="199 "></span>        <span class="n">optimized_call</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">ov.pl.volcano(</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">optimized_params</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="200 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">optimized_call</span><span class="p">)</span>
<span class="linenos" data-linenos="201 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="202 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✅ Current parameters are optimal for your data!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="203 "></span>
<span class="linenos" data-linenos="204 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}{</span><span class="s1">'─'</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="205 "></span>
<span class="linenos" data-linenos="206 "></span>    <span class="c1"># Original volcano plot code starts here</span>
<span class="linenos" data-linenos="207 "></span>    <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos" data-linenos="208 "></span>    <span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">pval_name</span><span class="p">])</span>
<span class="linenos" data-linenos="209 "></span>    <span class="n">result</span><span class="p">[</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">fc_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos" data-linenos="210 "></span>    <span class="k">if</span> <span class="n">pval_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="211 "></span>        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pval_max</span><span class="p">,</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">=</span><span class="n">pval_max</span>
<span class="linenos" data-linenos="212 "></span>    <span class="k">if</span> <span class="n">FC_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="213 "></span>        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">&gt;</span><span class="n">FC_max</span><span class="p">,</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">=</span><span class="n">FC_max</span>
<span class="linenos" data-linenos="214 "></span>        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">FC_max</span><span class="p">,</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="o">-</span><span class="n">FC_max</span>
<span class="linenos" data-linenos="215 "></span>
<span class="linenos" data-linenos="216 "></span>    <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="217 "></span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="218 "></span>
<span class="linenos" data-linenos="219 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal'</span><span class="p">][</span><span class="s1">'log2FC'</span><span class="p">],</span>
<span class="linenos" data-linenos="220 "></span>            <span class="n">y</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal'</span><span class="p">][</span><span class="s1">'-log(qvalue)'</span><span class="p">],</span>
<span class="linenos" data-linenos="221 "></span>            <span class="n">color</span><span class="o">=</span><span class="n">normal_color</span><span class="p">,</span><span class="c1">#颜色</span>
<span class="linenos" data-linenos="222 "></span>            <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span><span class="c1">#透明度</span>
<span class="linenos" data-linenos="223 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="224 "></span>    <span class="c1">#接着绘制上调基因</span>
<span class="linenos" data-linenos="225 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'up'</span><span class="p">][</span><span class="s1">'log2FC'</span><span class="p">],</span>
<span class="linenos" data-linenos="226 "></span>            <span class="n">y</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'up'</span><span class="p">][</span><span class="s1">'-log(qvalue)'</span><span class="p">],</span>
<span class="linenos" data-linenos="227 "></span>            <span class="n">color</span><span class="o">=</span><span class="n">up_color</span><span class="p">,</span><span class="c1">#选择色卡第15个颜色</span>
<span class="linenos" data-linenos="228 "></span>            <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span><span class="c1">#透明度</span>
<span class="linenos" data-linenos="229 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="230 "></span>    <span class="c1">#绘制下调基因</span>
<span class="linenos" data-linenos="231 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'down'</span><span class="p">][</span><span class="s1">'log2FC'</span><span class="p">],</span>
<span class="linenos" data-linenos="232 "></span>            <span class="n">y</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'down'</span><span class="p">][</span><span class="s1">'-log(qvalue)'</span><span class="p">],</span>
<span class="linenos" data-linenos="233 "></span>            <span class="n">color</span><span class="o">=</span><span class="n">down_color</span><span class="p">,</span><span class="c1">#颜色</span>
<span class="linenos" data-linenos="234 "></span>            <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span><span class="c1">#透明度</span>
<span class="linenos" data-linenos="235 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="236 "></span>
<span class="linenos" data-linenos="237 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">result</span><span class="p">[</span><span class="s1">'log2FC'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span><span class="c1">#辅助线的x值起点与终点</span>
<span class="linenos" data-linenos="238 "></span>            <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pval_threshold</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pval_threshold</span><span class="p">)],</span><span class="c1">#辅助线的y值起点与终点</span>
<span class="linenos" data-linenos="239 "></span>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="c1">#辅助线的宽度</span>
<span class="linenos" data-linenos="240 "></span>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span><span class="c1">#辅助线类型：虚线</span>
<span class="linenos" data-linenos="241 "></span>            <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="c1">#辅助线的颜色</span>
<span class="linenos" data-linenos="242 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="243 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">fc_max</span><span class="p">,</span><span class="n">fc_max</span><span class="p">],</span>
<span class="linenos" data-linenos="244 "></span>            <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
<span class="linenos" data-linenos="245 "></span>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
<span class="linenos" data-linenos="246 "></span>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span>
<span class="linenos" data-linenos="247 "></span>            <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
<span class="linenos" data-linenos="248 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">fc_min</span><span class="p">,</span><span class="n">fc_min</span><span class="p">],</span>
<span class="linenos" data-linenos="249 "></span>            <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">result</span><span class="p">[</span><span class="s1">'-log(qvalue)'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
<span class="linenos" data-linenos="250 "></span>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
<span class="linenos" data-linenos="251 "></span>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span>
<span class="linenos" data-linenos="252 "></span>            <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
<span class="linenos" data-linenos="253 "></span>    <span class="c1">#设置横标签与纵标签</span>
<span class="linenos" data-linenos="254 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'$-log_</span><span class="si">{10}</span><span class="s1">(qvalue)$'</span><span class="p">,</span><span class="n">titlefont</span><span class="p">)</span>                                    
<span class="linenos" data-linenos="255 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'$log_</span><span class="si">{2}</span><span class="s1">FC$'</span><span class="p">,</span><span class="n">titlefont</span><span class="p">)</span>
<span class="linenos" data-linenos="256 "></span>    <span class="c1">#设置标题</span>
<span class="linenos" data-linenos="257 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">titlefont</span><span class="p">)</span>
<span class="linenos" data-linenos="258 "></span>
<span class="linenos" data-linenos="259 "></span>    <span class="c1">#绘制图注</span>
<span class="linenos" data-linenos="260 "></span>    <span class="c1">#legend标签列表，上面的color即是颜色列表</span>
<span class="linenos" data-linenos="261 "></span>    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'up:</span><span class="si">{0}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'up'</span><span class="p">])),</span>
<span class="linenos" data-linenos="262 "></span>            <span class="s1">'down:</span><span class="si">{0}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'down'</span><span class="p">]))]</span>  
<span class="linenos" data-linenos="263 "></span>    <span class="c1">#用label和color列表生成mpatches.Patch对象，它将作为句柄来生成legend</span>
<span class="linenos" data-linenos="264 "></span>    <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">up_color</span><span class="p">,</span><span class="n">down_color</span><span class="p">]</span>
<span class="linenos" data-linenos="265 "></span>    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"</span><span class="si">{:s}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">))]</span> 
<span class="linenos" data-linenos="266 "></span>
<span class="linenos" data-linenos="267 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span>
<span class="linenos" data-linenos="268 "></span>        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span> 
<span class="linenos" data-linenos="269 "></span>        <span class="n">ncol</span><span class="o">=</span><span class="n">legend_ncol</span><span class="p">,</span>
<span class="linenos" data-linenos="270 "></span>        <span class="n">fontsize</span><span class="o">=</span><span class="n">legend_fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="271 "></span>
<span class="linenos" data-linenos="272 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="273 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="274 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="275 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="276 "></span>
<span class="linenos" data-linenos="277 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="c1">#获取x坐标轴内容</span>
<span class="linenos" data-linenos="278 "></span>        <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="c1">#更新x坐标轴内容</span>
<span class="linenos" data-linenos="279 "></span>        <span class="n">fontsize</span><span class="o">=</span><span class="n">ticks_fontsize</span><span class="p">,</span>
<span class="linenos" data-linenos="280 "></span>        <span class="n">fontweight</span><span class="o">=</span><span class="s1">'normal'</span>
<span class="linenos" data-linenos="281 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="282 "></span>
<span class="linenos" data-linenos="283 "></span>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="284 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="285 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="286 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="287 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="288 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="289 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="290 "></span>
<span class="linenos" data-linenos="291 "></span>
<span class="linenos" data-linenos="292 "></span>    <span class="kn">from</span> <span class="nn">adjustText</span> <span class="kn">import</span> <span class="n">adjust_text</span>
<span class="linenos" data-linenos="293 "></span>    <span class="kn">import</span> <span class="nn">adjustText</span>
<span class="linenos" data-linenos="294 "></span>
<span class="linenos" data-linenos="295 "></span>    <span class="k">if</span> <span class="n">plot_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="296 "></span>        <span class="n">hub_gene</span><span class="o">=</span><span class="n">plot_genes</span>
<span class="linenos" data-linenos="297 "></span>    <span class="k">elif</span> <span class="p">(</span><span class="n">plot_genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">plot_genes_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos" data-linenos="298 "></span>        <span class="k">return</span> <span class="n">ax</span>
<span class="linenos" data-linenos="299 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="300 "></span>        <span class="n">up_result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'up'</span><span class="p">]</span>
<span class="linenos" data-linenos="301 "></span>        <span class="n">down_result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">'sig'</span><span class="p">]</span><span class="o">==</span><span class="s1">'down'</span><span class="p">]</span>
<span class="linenos" data-linenos="302 "></span>        <span class="n">hub_gene</span><span class="o">=</span><span class="n">up_result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">pval_name</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">plot_genes_num</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="n">down_result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">pval_name</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">plot_genes_num</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos" data-linenos="303 "></span>
<span class="linenos" data-linenos="304 "></span>    <span class="n">color_dict</span><span class="o">=</span><span class="p">{</span>
<span class="linenos" data-linenos="305 "></span>    <span class="s1">'up'</span><span class="p">:</span><span class="n">up_fontcolor</span><span class="p">,</span>
<span class="linenos" data-linenos="306 "></span>        <span class="s1">'down'</span><span class="p">:</span><span class="n">down_fontcolor</span><span class="p">,</span>
<span class="linenos" data-linenos="307 "></span>        <span class="s1">'normal'</span><span class="p">:</span><span class="n">normal_fontcolor</span>
<span class="linenos" data-linenos="308 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="309 "></span>
<span class="linenos" data-linenos="310 "></span>    <span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">'log2FC'</span><span class="p">],</span> 
<span class="linenos" data-linenos="311 "></span>        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">'-log(qvalue)'</span><span class="p">],</span>
<span class="linenos" data-linenos="312 "></span>        <span class="n">i</span><span class="p">,</span>
<span class="linenos" data-linenos="313 "></span>        <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">'size'</span><span class="p">:</span><span class="n">plot_genes_fontsize</span><span class="p">,</span><span class="s1">'weight'</span><span class="p">:</span><span class="s1">'bold'</span><span class="p">,</span><span class="s1">'color'</span><span class="p">:</span><span class="n">color_dict</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">'sig'</span><span class="p">]]}</span>
<span class="linenos" data-linenos="314 "></span>        <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hub_gene</span><span class="p">]</span>
<span class="linenos" data-linenos="315 "></span>
<span class="linenos" data-linenos="316 "></span>    <span class="k">if</span> <span class="n">adjustText</span><span class="o">.</span><span class="n">__version__</span><span class="o">&lt;=</span><span class="s1">'0.8'</span><span class="p">:</span>
<span class="linenos" data-linenos="317 "></span>        <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span><span class="n">only_move</span><span class="o">=</span><span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="s1">'xy'</span><span class="p">},</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">'-&gt;'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">),)</span>
<span class="linenos" data-linenos="318 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="319 "></span>        <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span><span class="n">only_move</span><span class="o">=</span><span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="s2">"xy"</span><span class="p">,</span> <span class="s2">"static"</span><span class="p">:</span> <span class="s2">"xy"</span><span class="p">,</span> <span class="s2">"explode"</span><span class="p">:</span> <span class="s2">"xy"</span><span class="p">,</span> <span class="s2">"pull"</span><span class="p">:</span> <span class="s2">"xy"</span><span class="p">},</span>
<span class="linenos" data-linenos="320 "></span>                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">'-&gt;'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">))</span>
<span class="linenos" data-linenos="321 "></span>
<span class="linenos" data-linenos="322 "></span>
<span class="linenos" data-linenos="323 "></span>    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.venn">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">venn</span><span class="p">(</span><span class="n">sets</span><span class="o">=</span><span class="p">{},</span> <span class="n">out</span><span class="o">=</span><span class="s1">'./'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">'bgrc'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">'png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span> <span class="n">nc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.venn" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create a Venn diagram to visualize set overlaps.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sets</code></td>
<td>
</td>
<td><p>Dictionary with set names as keys and sets as values ({})</p></td>
<td>
<code>{}</code>
</td>
</tr>
<tr>
<td><code>out</code></td>
<td>
</td>
<td><p>Output directory path ('./')</p></td>
<td>
<code>'./'</code>
</td>
</tr>
<tr>
<td><code>palette</code></td>
<td>
</td>
<td><p>Color palette for sets ('bgrc')</p></td>
<td>
<code>'bgrc'</code>
</td>
</tr>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>Matplotlib axes object or False to create new (False)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>ext</code></td>
<td>
</td>
<td><p>File extension for output ('png')</p></td>
<td>
<code>'png'</code>
</td>
</tr>
<tr>
<td><code>dpi</code></td>
<td>
</td>
<td><p>Resolution for output image (300)</p></td>
<td>
<code>300</code>
</td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>
</td>
<td><p>Font size for text (3.5)</p></td>
<td>
<code>3.5</code>
</td>
</tr>
<tr>
<td><code>bbox_to_anchor</code></td>
<td>
</td>
<td><p>Legend position ((.5, .99))</p></td>
<td>
<code>(0.5, 0.99)</code>
</td>
</tr>
<tr>
<td><code>nc</code></td>
<td>
</td>
<td><p>Number of legend columns (2)</p></td>
<td>
<code>2</code>
</td>
</tr>
<tr>
<td><code>cs</code></td>
<td>
</td>
<td><p>Font size for legend (4)</p></td>
<td>
<code>4</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td> <td>
</td>
<td><p>matplotlib.axes.Axes object</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_bulk.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="325 "></span><span class="k">def</span> <span class="nf">venn</span><span class="p">(</span><span class="n">sets</span><span class="o">=</span><span class="p">{},</span> <span class="n">out</span><span class="o">=</span><span class="s1">'./'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">'bgrc'</span><span class="p">,</span>
<span class="linenos" data-linenos="326 "></span>             <span class="n">ax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">'png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
<span class="linenos" data-linenos="327 "></span>             <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.99</span><span class="p">),</span><span class="n">nc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">cs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos" data-linenos="328 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos="329 "></span><span class="sd">    Create a Venn diagram to visualize set overlaps.</span>
<span class="linenos" data-linenos="330 "></span>
<span class="linenos" data-linenos="331 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="332 "></span><span class="sd">        sets: Dictionary with set names as keys and sets as values ({})</span>
<span class="linenos" data-linenos="333 "></span><span class="sd">        out: Output directory path ('./')</span>
<span class="linenos" data-linenos="334 "></span><span class="sd">        palette: Color palette for sets ('bgrc')</span>
<span class="linenos" data-linenos="335 "></span><span class="sd">        ax: Matplotlib axes object or False to create new (False)</span>
<span class="linenos" data-linenos="336 "></span><span class="sd">        ext: File extension for output ('png')</span>
<span class="linenos" data-linenos="337 "></span><span class="sd">        dpi: Resolution for output image (300)</span>
<span class="linenos" data-linenos="338 "></span><span class="sd">        fontsize: Font size for text (3.5)</span>
<span class="linenos" data-linenos="339 "></span><span class="sd">        bbox_to_anchor: Legend position ((.5, .99))</span>
<span class="linenos" data-linenos="340 "></span><span class="sd">        nc: Number of legend columns (2)</span>
<span class="linenos" data-linenos="341 "></span><span class="sd">        cs: Font size for legend (4)</span>
<span class="linenos" data-linenos="342 "></span>
<span class="linenos" data-linenos="343 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="344 "></span><span class="sd">        ax: matplotlib.axes.Axes object</span>
<span class="linenos" data-linenos="345 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="346 "></span>
<span class="linenos" data-linenos="347 "></span>    <span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">venny4py</span>
<span class="linenos" data-linenos="348 "></span>    <span class="n">venny4py</span><span class="p">(</span><span class="n">sets</span><span class="o">=</span><span class="n">sets</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span><span class="n">ce</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span><span class="n">asax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
<span class="linenos" data-linenos="349 "></span>             <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bbox_to_anchor</span><span class="p">,</span>
<span class="linenos" data-linenos="350 "></span>             <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span><span class="n">cs</span><span class="o">=</span><span class="n">cs</span><span class="p">,</span>
<span class="linenos" data-linenos="351 "></span>             <span class="p">)</span>
<span class="linenos" data-linenos="352 "></span>    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.boxplot">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span> <span class="n">x_value</span><span class="p">,</span> <span class="n">y_value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">legend_bbox</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">),</span> <span class="n">legend_ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.boxplot" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Create a boxplot with jittered points to visualize data distribution across categories.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>data</code></td>
<td>
</td>
<td><p>DataFrame containing the data to plot</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>hue</code></td>
<td>
</td>
<td><p>Column name for grouping variable (color coding)</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>x_value</code></td>
<td>
</td>
<td><p>Column name for x-axis categories</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>y_value</code></td>
<td>
</td>
<td><p>Column name for y-axis values</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>width</code></td>
<td>
</td>
<td><p>Width of each boxplot (0.3)</p></td>
<td>
<code>0.3</code>
</td>
</tr>
<tr>
<td><code>title</code></td>
<td>
</td>
<td><p>Plot title ('')</p></td>
<td>
<code>''</code>
</td>
</tr>
<tr>
<td><code>figsize</code></td>
<td>
</td>
<td><p>Figure dimensions as (width, height) ((6,3))</p></td>
<td>
<code>(6, 3)</code>
</td>
</tr>
<tr>
<td><code>palette</code></td>
<td>
</td>
<td><p>Color palette for groups (None, uses default)</p></td>
<td>
<code>None</code>
</td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>
</td>
<td><p>Font size for labels and ticks (10)</p></td>
<td>
<code>10</code>
</td>
</tr>
<tr>
<td><code>legend_bbox</code></td>
<td>
</td>
<td><p>Legend position as (x, y) ((1, 0.55))</p></td>
<td>
<code>(1, 0.55)</code>
</td>
</tr>
<tr>
<td><code>legend_ncol</code></td>
<td>
</td>
<td><p>Number of legend columns (1)</p></td>
<td>
<code>1</code>
</td>
</tr>
<tr>
<td><code>hue_order</code></td>
<td>
</td>
<td><p>Custom order for hue categories (None, uses alphabetical)</p></td>
<td>
<code>None</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fig</code></td> <td>
</td>
<td><p>matplotlib.figure.Figure object</p></td>
</tr>
<tr>
<td><code>ax</code></td> <td>
</td>
<td><p>matplotlib.axes.Axes object</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_bulk.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="354 "></span><span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">hue</span><span class="p">,</span><span class="n">x_value</span><span class="p">,</span><span class="n">y_value</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
<span class="linenos" data-linenos="355 "></span>                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos="356 "></span>                 <span class="n">legend_bbox</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">),</span><span class="n">legend_ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hue_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos" data-linenos="357 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos="358 "></span><span class="sd">    Create a boxplot with jittered points to visualize data distribution across categories.</span>
<span class="linenos" data-linenos="359 "></span>
<span class="linenos" data-linenos="360 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="361 "></span><span class="sd">        data: DataFrame containing the data to plot</span>
<span class="linenos" data-linenos="362 "></span><span class="sd">        hue: Column name for grouping variable (color coding)</span>
<span class="linenos" data-linenos="363 "></span><span class="sd">        x_value: Column name for x-axis categories</span>
<span class="linenos" data-linenos="364 "></span><span class="sd">        y_value: Column name for y-axis values</span>
<span class="linenos" data-linenos="365 "></span><span class="sd">        width: Width of each boxplot (0.3)</span>
<span class="linenos" data-linenos="366 "></span><span class="sd">        title: Plot title ('')</span>
<span class="linenos" data-linenos="367 "></span><span class="sd">        figsize: Figure dimensions as (width, height) ((6,3))</span>
<span class="linenos" data-linenos="368 "></span><span class="sd">        palette: Color palette for groups (None, uses default)</span>
<span class="linenos" data-linenos="369 "></span><span class="sd">        fontsize: Font size for labels and ticks (10)</span>
<span class="linenos" data-linenos="370 "></span><span class="sd">        legend_bbox: Legend position as (x, y) ((1, 0.55))</span>
<span class="linenos" data-linenos="371 "></span><span class="sd">        legend_ncol: Number of legend columns (1)</span>
<span class="linenos" data-linenos="372 "></span><span class="sd">        hue_order: Custom order for hue categories (None, uses alphabetical)</span>
<span class="linenos" data-linenos="373 "></span>
<span class="linenos" data-linenos="374 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="375 "></span><span class="sd">        fig: matplotlib.figure.Figure object</span>
<span class="linenos" data-linenos="376 "></span><span class="sd">        ax: matplotlib.axes.Axes object</span>
<span class="linenos" data-linenos="377 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="378 "></span>
<span class="linenos" data-linenos="379 "></span>    <span class="c1"># Color codes for terminal output</span>
<span class="linenos" data-linenos="380 "></span>    <span class="k">class</span> <span class="nc">Colors</span><span class="p">:</span>
<span class="linenos" data-linenos="381 "></span>        <span class="n">HEADER</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[95m'</span>
<span class="linenos" data-linenos="382 "></span>        <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[94m'</span>
<span class="linenos" data-linenos="383 "></span>        <span class="n">CYAN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[96m'</span>
<span class="linenos" data-linenos="384 "></span>        <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[92m'</span>
<span class="linenos" data-linenos="385 "></span>        <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[93m'</span>
<span class="linenos" data-linenos="386 "></span>        <span class="n">FAIL</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[91m'</span>
<span class="linenos" data-linenos="387 "></span>        <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[0m'</span>
<span class="linenos" data-linenos="388 "></span>        <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[1m'</span>
<span class="linenos" data-linenos="389 "></span>        <span class="n">UNDERLINE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[4m'</span>
<span class="linenos" data-linenos="390 "></span>
<span class="linenos" data-linenos="391 "></span>    <span class="c1"># Print data information for user guidance</span>
<span class="linenos" data-linenos="392 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📊 Boxplot Data Analysis:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="393 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Total samples: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="394 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">X-axis variable ('</span><span class="si">{</span><span class="n">x_value</span><span class="si">}</span><span class="s2">'): </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x_value</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="395 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Hue variable ('</span><span class="si">{</span><span class="n">hue</span><span class="si">}</span><span class="s2">'): </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="396 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Y-axis variable: '</span><span class="si">{</span><span class="n">y_value</span><span class="si">}</span><span class="s2">' (range: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">data</span><span class="p">[</span><span class="n">y_value</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">y_value</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<span class="linenos" data-linenos="397 "></span>
<span class="linenos" data-linenos="398 "></span>    <span class="c1"># Check for missing data</span>
<span class="linenos" data-linenos="399 "></span>    <span class="n">missing_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">hue</span><span class="p">,</span> <span class="n">x_value</span><span class="p">,</span> <span class="n">y_value</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos" data-linenos="400 "></span>    <span class="k">if</span> <span class="n">missing_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="401 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">⚠️  Warning: Found </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">missing_data</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2"> missing values in key columns</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="402 "></span>
<span class="linenos" data-linenos="403 "></span>    <span class="c1"># Display current function parameters</span>
<span class="linenos" data-linenos="404 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">⚙️  Current Function Parameters:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="405 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">hue='</span><span class="si">{</span><span class="n">hue</span><span class="si">}</span><span class="s2">', x_value='</span><span class="si">{</span><span class="n">x_value</span><span class="si">}</span><span class="s2">', y_value='</span><span class="si">{</span><span class="n">y_value</span><span class="si">}</span><span class="s2">'</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="406 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, figsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">, fontsize=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">fontsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="407 "></span>    <span class="k">if</span> <span class="n">hue_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="408 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">hue_order=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">hue_order</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="409 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="410 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">hue_order=</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">None</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2"> (using alphabetical order)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="411 "></span>
<span class="linenos" data-linenos="412 "></span>    <span class="k">def</span> <span class="nf">calculate_box_positions</span><span class="p">(</span><span class="n">n_hues</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="linenos" data-linenos="413 "></span><span class="w">        </span><span class="sd">"""</span>
<span class="linenos" data-linenos="414 "></span><span class="sd">        Calculate evenly distributed positions for boxes within the range [-0.5, 0.5].</span>
<span class="linenos" data-linenos="415 "></span>
<span class="linenos" data-linenos="416 "></span><span class="sd">        Parameters</span>
<span class="linenos" data-linenos="417 "></span><span class="sd">        ----------</span>
<span class="linenos" data-linenos="418 "></span><span class="sd">        n_hues : int</span>
<span class="linenos" data-linenos="419 "></span><span class="sd">            Number of hue categories</span>
<span class="linenos" data-linenos="420 "></span><span class="sd">        spacing : float</span>
<span class="linenos" data-linenos="421 "></span><span class="sd">            Fraction of the total range to use for spacing boxes (0.8 means use 80% of [-0.5, 0.5])</span>
<span class="linenos" data-linenos="422 "></span>
<span class="linenos" data-linenos="423 "></span><span class="sd">        Returns</span>
<span class="linenos" data-linenos="424 "></span><span class="sd">        -------</span>
<span class="linenos" data-linenos="425 "></span><span class="sd">        positions : list</span>
<span class="linenos" data-linenos="426 "></span><span class="sd">            List of positions for each hue</span>
<span class="linenos" data-linenos="427 "></span><span class="sd">        """</span>
<span class="linenos" data-linenos="428 "></span>        <span class="k">if</span> <span class="n">n_hues</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="429 "></span>            <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
<span class="linenos" data-linenos="430 "></span>
<span class="linenos" data-linenos="431 "></span>        <span class="c1"># Calculate the range to use for positioning</span>
<span class="linenos" data-linenos="432 "></span>        <span class="n">total_range</span> <span class="o">=</span> <span class="n">spacing</span>  <span class="c1"># Use 80% of the [-0.5, 0.5] range by default</span>
<span class="linenos" data-linenos="433 "></span>        <span class="n">half_range</span> <span class="o">=</span> <span class="n">total_range</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos" data-linenos="434 "></span>
<span class="linenos" data-linenos="435 "></span>        <span class="c1"># Calculate positions evenly distributed within the range</span>
<span class="linenos" data-linenos="436 "></span>        <span class="k">if</span> <span class="n">n_hues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos" data-linenos="437 "></span>            <span class="n">step</span> <span class="o">=</span> <span class="n">total_range</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_hues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="438 "></span>            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">half_range</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_hues</span><span class="p">)]</span>
<span class="linenos" data-linenos="439 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="440 "></span>            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
<span class="linenos" data-linenos="441 "></span>
<span class="linenos" data-linenos="442 "></span>        <span class="k">return</span> <span class="n">positions</span>
<span class="linenos" data-linenos="443 "></span>
<span class="linenos" data-linenos="444 "></span>    <span class="c1">#获取需要分割的数据</span>
<span class="linenos" data-linenos="445 "></span>    <span class="k">if</span> <span class="n">hue_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="446 "></span>        <span class="n">hue_datas</span> <span class="o">=</span> <span class="n">hue_order</span>
<span class="linenos" data-linenos="447 "></span>        <span class="c1"># Check if all hue values in data are in hue_order</span>
<span class="linenos" data-linenos="448 "></span>        <span class="n">data_hue_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos" data-linenos="449 "></span>        <span class="n">hue_order_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">hue_order</span><span class="p">)</span>
<span class="linenos" data-linenos="450 "></span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_hue_values</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">hue_order_set</span><span class="p">):</span>
<span class="linenos" data-linenos="451 "></span>            <span class="n">missing_values</span> <span class="o">=</span> <span class="n">data_hue_values</span> <span class="o">-</span> <span class="n">hue_order_set</span>
<span class="linenos" data-linenos="452 "></span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The following hue values are in data but not in hue_order: </span><span class="si">{</span><span class="n">missing_values</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="453 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">📋 Using custom hue order: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">hue_order</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="454 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="455 "></span>        <span class="n">hue_datas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">])))</span>
<span class="linenos" data-linenos="456 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">📋 Using alphabetical hue order: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">hue_datas</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="457 "></span>
<span class="linenos" data-linenos="458 "></span>    <span class="c1">#获取箱线图的横坐标</span>
<span class="linenos" data-linenos="459 "></span>    <span class="n">x</span><span class="o">=</span><span class="n">x_value</span>
<span class="linenos" data-linenos="460 "></span>    <span class="n">ticks</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">])))</span>
<span class="linenos" data-linenos="461 "></span>
<span class="linenos" data-linenos="462 "></span>    <span class="c1"># Calculate box positions</span>
<span class="linenos" data-linenos="463 "></span>    <span class="n">box_positions</span> <span class="o">=</span> <span class="n">calculate_box_positions</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">))</span>
<span class="linenos" data-linenos="464 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">🎯 Box Positioning:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="465 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Number of hue groups: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="466 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Box positions: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">box_positions</span><span class="p">]</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="467 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Box width: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="468 "></span>
<span class="linenos" data-linenos="469 "></span>    <span class="c1"># Calculate sample sizes for each combination</span>
<span class="linenos" data-linenos="470 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📈 Sample sizes per group:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="471 "></span>    <span class="k">for</span> <span class="n">hue_cat</span> <span class="ow">in</span> <span class="n">hue_datas</span><span class="p">:</span>
<span class="linenos" data-linenos="472 "></span>        <span class="k">for</span> <span class="n">x_cat</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">:</span>
<span class="linenos" data-linenos="473 "></span>            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span> <span class="o">==</span> <span class="n">hue_cat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_cat</span><span class="p">)])</span>
<span class="linenos" data-linenos="474 "></span>            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="475 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span>
<span class="linenos" data-linenos="476 "></span>            <span class="k">elif</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="477 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span>
<span class="linenos" data-linenos="478 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="479 "></span>                <span class="n">color</span> <span class="o">=</span> <span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span>
<span class="linenos" data-linenos="480 "></span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">color</span><span class="si">}{</span><span class="n">hue_cat</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="n">x_cat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">count</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">color</span><span class="si">}</span><span class="s2"> samples</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="481 "></span>
<span class="linenos" data-linenos="482 "></span>    <span class="c1"># Provide parameter suggestions with current vs suggested comparison</span>
<span class="linenos" data-linenos="483 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">💡 Parameter Optimization Suggestions:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="484 "></span>    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="485 "></span>
<span class="linenos" data-linenos="486 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos" data-linenos="487 "></span>        <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="488 "></span>        <span class="n">suggested_figsize_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos" data-linenos="489 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Many hue groups detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="490 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">, figsize=</span><span class="si">{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="491 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}</span><span class="s2">, figsize=(</span><span class="si">{</span><span class="n">suggested_figsize_width</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="492 "></span>
<span class="linenos" data-linenos="493 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="494 "></span>        <span class="n">suggested_figsize_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="linenos" data-linenos="495 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Many x-categories detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="496 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=</span><span class="si">{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="497 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(</span><span class="si">{</span><span class="n">suggested_figsize_width</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="498 "></span>
<span class="linenos" data-linenos="499 "></span>    <span class="n">max_samples</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_cat</span><span class="p">)])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hue_datas</span> <span class="k">for</span> <span class="n">x_cat</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
<span class="linenos" data-linenos="500 "></span>    <span class="k">if</span> <span class="n">max_samples</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="501 "></span>        <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="502 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">▶ Small sample sizes detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="503 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="504 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="505 "></span>
<span class="linenos" data-linenos="506 "></span>    <span class="c1"># Check if current width might cause overlap</span>
<span class="linenos" data-linenos="507 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">:</span>
<span class="linenos" data-linenos="508 "></span>        <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="509 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">FAIL</span><span class="si">}</span><span class="s2">▶ Box overlap risk detected:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="510 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2"> (too wide for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="511 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">width=</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="512 "></span>
<span class="linenos" data-linenos="513 "></span>    <span class="c1"># Figure size optimization based on both dimensions</span>
<span class="linenos" data-linenos="514 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos" data-linenos="515 "></span>        <span class="n">suggested_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="linenos" data-linenos="516 "></span>        <span class="n">suggested_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos" data-linenos="517 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">▶ Complex plot optimization:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="518 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">Current: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=</span><span class="si">{</span><span class="n">figsize</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="519 "></span>        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Suggested: </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">figsize=(</span><span class="si">{</span><span class="n">suggested_width</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">suggested_height</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="520 "></span>
<span class="linenos" data-linenos="521 "></span>    <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="522 "></span>        <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
<span class="linenos" data-linenos="523 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
<span class="linenos" data-linenos="524 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}</span><span class="s2">📋 Copy-paste ready function call:</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="525 "></span>        <span class="c1"># Generate optimized function call</span>
<span class="linenos" data-linenos="526 "></span>        <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="527 "></span>        <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"data, hue='</span><span class="si">{</span><span class="n">hue</span><span class="si">}</span><span class="s2">', x_value='</span><span class="si">{</span><span class="n">x_value</span><span class="si">}</span><span class="s2">', y_value='</span><span class="si">{</span><span class="n">y_value</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos" data-linenos="528 "></span>
<span class="linenos" data-linenos="529 "></span>        <span class="c1"># Add optimized parameters</span>
<span class="linenos" data-linenos="530 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_samples</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="531 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos" data-linenos="532 "></span>                <span class="n">opt_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="533 "></span>            <span class="k">elif</span> <span class="n">max_samples</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="534 "></span>                <span class="n">opt_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="535 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="536 "></span>                <span class="n">opt_width</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="537 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"width=</span><span class="si">{</span><span class="n">opt_width</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="538 "></span>
<span class="linenos" data-linenos="539 "></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
<span class="linenos" data-linenos="540 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos" data-linenos="541 "></span>                <span class="n">opt_fig_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos" data-linenos="542 "></span>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="543 "></span>                <span class="n">opt_fig_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="linenos" data-linenos="544 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="545 "></span>                <span class="n">opt_fig_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="linenos" data-linenos="546 "></span>            <span class="n">opt_fig_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos" data-linenos="547 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"figsize=(</span><span class="si">{</span><span class="n">opt_fig_w</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">opt_fig_h</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<span class="linenos" data-linenos="548 "></span>
<span class="linenos" data-linenos="549 "></span>        <span class="k">if</span> <span class="n">hue_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="550 "></span>            <span class="n">optimized_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"hue_order=</span><span class="si">{</span><span class="n">hue_order</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="551 "></span>
<span class="linenos" data-linenos="552 "></span>        <span class="n">optimized_call</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">ov.pl.boxplot(</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">optimized_params</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="553 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">optimized_call</span><span class="p">)</span>
<span class="linenos" data-linenos="554 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="555 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   </span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✅ Current parameters are optimal for your data!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="556 "></span>
<span class="linenos" data-linenos="557 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}{</span><span class="s1">'─'</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="linenos" data-linenos="558 "></span>
<span class="linenos" data-linenos="559 "></span>    <span class="c1">#在这个数据中，我们有6个不同的癌症，每个癌症都有2个基因（2个箱子）</span>
<span class="linenos" data-linenos="560 "></span>    <span class="c1">#所以我们需要得到每一个基因的6个箱线图位置，6个散点图的抖动</span>
<span class="linenos" data-linenos="561 "></span>    <span class="n">plot_data1</span><span class="o">=</span><span class="p">{}</span><span class="c1">#字典里的每一个元素就是每一个基因的所有值</span>
<span class="linenos" data-linenos="562 "></span>    <span class="n">plot_data_random1</span><span class="o">=</span><span class="p">{}</span><span class="c1">#字典里的每一个元素就是每一个基因的随机20个值</span>
<span class="linenos" data-linenos="563 "></span>    <span class="n">plot_data_xs1</span><span class="o">=</span><span class="p">{}</span><span class="c1">#字典里的每一个元素就是每一个基因的20个抖动值</span>
<span class="linenos" data-linenos="564 "></span>
<span class="linenos" data-linenos="565 "></span>
<span class="linenos" data-linenos="566 "></span>    <span class="c1">#箱子的参数</span>
<span class="linenos" data-linenos="567 "></span>    <span class="c1">#width=0.6</span>
<span class="linenos" data-linenos="568 "></span>    <span class="n">y</span><span class="o">=</span><span class="n">y_value</span>
<span class="linenos" data-linenos="569 "></span>    <span class="kn">import</span> <span class="nn">random</span>
<span class="linenos" data-linenos="570 "></span>    <span class="k">for</span> <span class="n">hue_data</span><span class="p">,</span><span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">,</span><span class="n">box_positions</span><span class="p">):</span>
<span class="linenos" data-linenos="571 "></span>        <span class="n">data_a</span><span class="o">=</span><span class="p">[]</span>
<span class="linenos" data-linenos="572 "></span>        <span class="n">data_a_random</span><span class="o">=</span><span class="p">[]</span>
<span class="linenos" data-linenos="573 "></span>        <span class="n">data_a_xs</span><span class="o">=</span><span class="p">[]</span>
<span class="linenos" data-linenos="574 "></span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">))):</span>
<span class="linenos" data-linenos="575 "></span>            <span class="n">test_data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span><span class="o">==</span><span class="n">hue_data</span><span class="p">)),</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos" data-linenos="576 "></span>            <span class="n">data_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="linenos" data-linenos="577 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">:</span>
<span class="linenos" data-linenos="578 "></span>                <span class="n">data_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="linenos" data-linenos="579 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="580 "></span>                <span class="n">data_size</span><span class="o">=</span><span class="mi">20</span>
<span class="linenos" data-linenos="581 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="582 "></span>                <span class="n">random_data</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span><span class="n">data_size</span><span class="p">)</span>
<span class="linenos" data-linenos="583 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="584 "></span>                <span class="n">random_data</span><span class="o">=</span><span class="p">[]</span>
<span class="linenos" data-linenos="585 "></span>            <span class="n">data_a_random</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_data</span><span class="p">)</span>
<span class="linenos" data-linenos="586 "></span>            <span class="n">data_a_xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="n">num</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_data</span><span class="p">)))</span>
<span class="linenos" data-linenos="587 "></span>        <span class="c1">#data_a=np.array(data_a)</span>
<span class="linenos" data-linenos="588 "></span>        <span class="n">data_a_random</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_a_random</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
<span class="linenos" data-linenos="589 "></span>        <span class="n">plot_data1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">]</span><span class="o">=</span><span class="n">data_a</span> 
<span class="linenos" data-linenos="590 "></span>        <span class="n">plot_data_random1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">]</span><span class="o">=</span><span class="n">data_a_random</span>
<span class="linenos" data-linenos="591 "></span>        <span class="n">plot_data_xs1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">]</span><span class="o">=</span><span class="n">data_a_xs</span>
<span class="linenos" data-linenos="592 "></span>
<span class="linenos" data-linenos="593 "></span>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="linenos" data-linenos="594 "></span>    <span class="c1">#色卡</span>
<span class="linenos" data-linenos="595 "></span>    <span class="k">if</span> <span class="n">palette</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="596 "></span>        <span class="kn">from</span> <span class="nn">._palette</span> <span class="kn">import</span> <span class="n">sc_color</span>
<span class="linenos" data-linenos="597 "></span>        <span class="n">palette</span><span class="o">=</span><span class="n">sc_color</span>
<span class="linenos" data-linenos="598 "></span>    <span class="c1">#palette=["#a64d79","#674ea7"]</span>
<span class="linenos" data-linenos="599 "></span>    <span class="c1">#绘制箱线图</span>
<span class="linenos" data-linenos="600 "></span>    <span class="k">for</span> <span class="n">hue_data</span><span class="p">,</span><span class="n">hue_color</span><span class="p">,</span><span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">,</span><span class="n">palette</span><span class="p">,</span><span class="n">box_positions</span><span class="p">):</span>
<span class="linenos" data-linenos="601 "></span>        <span class="n">b1</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">plot_data1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">],</span> 
<span class="linenos" data-linenos="602 "></span>                    <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)))</span><span class="o">+</span><span class="n">num</span><span class="p">,</span> 
<span class="linenos" data-linenos="603 "></span>                    <span class="n">sym</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> 
<span class="linenos" data-linenos="604 "></span>                    <span class="n">widths</span><span class="o">=</span><span class="n">width</span><span class="p">,)</span>
<span class="linenos" data-linenos="605 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="s1">'boxes'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">hue_color</span><span class="p">)</span>
<span class="linenos" data-linenos="606 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="s1">'whiskers'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">hue_color</span><span class="p">)</span>
<span class="linenos" data-linenos="607 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="s1">'caps'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">hue_color</span><span class="p">)</span>
<span class="linenos" data-linenos="608 "></span>        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="s1">'medians'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">hue_color</span><span class="p">)</span>
<span class="linenos" data-linenos="609 "></span>
<span class="linenos" data-linenos="610 "></span>        <span class="n">clevels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data_random1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">]))</span>
<span class="linenos" data-linenos="611 "></span>        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">clevel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_data_xs1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">],</span> <span class="n">plot_data_random1</span><span class="p">[</span><span class="n">hue_data</span><span class="p">],</span> <span class="n">clevels</span><span class="p">):</span>
<span class="linenos" data-linenos="612 "></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only plot if there's data</span>
<span class="linenos" data-linenos="613 "></span>                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">hue_color</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="linenos" data-linenos="614 "></span>
<span class="linenos" data-linenos="615 "></span>    <span class="c1">#坐标轴字体</span>
<span class="linenos" data-linenos="616 "></span>    <span class="c1">#fontsize=10</span>
<span class="linenos" data-linenos="617 "></span>    <span class="c1">#修改横坐标</span>
<span class="linenos" data-linenos="618 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)),</span> <span class="n">ticks</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="619 "></span>    <span class="c1">#修改纵坐标</span>
<span class="linenos" data-linenos="620 "></span>    <span class="n">yticks</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
<span class="linenos" data-linenos="621 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="n">yticks</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span><span class="n">yticks</span><span class="p">[</span><span class="n">yticks</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="622 "></span>
<span class="linenos" data-linenos="623 "></span>    <span class="n">labels</span> <span class="o">=</span> <span class="n">hue_datas</span>  <span class="c1">#legend标签列表，上面的color即是颜色列表</span>
<span class="linenos" data-linenos="624 "></span>    <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span>
<span class="linenos" data-linenos="625 "></span>    <span class="c1">#用label和color列表生成mpatches.Patch对象，它将作为句柄来生成legend</span>
<span class="linenos" data-linenos="626 "></span>    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"</span><span class="si">{:s}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hue_datas</span><span class="p">))</span> <span class="p">]</span> 
<span class="linenos" data-linenos="627 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">legend_ncol</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="linenos" data-linenos="628 "></span>
<span class="linenos" data-linenos="629 "></span>    <span class="c1">#设置标题</span>
<span class="linenos" data-linenos="630 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="631 "></span>    <span class="c1">#设置spines可视化情况</span>
<span class="linenos" data-linenos="632 "></span>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="633 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="634 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="635 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="636 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="637 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="638 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">'outward'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos" data-linenos="639 "></span>
<span class="linenos" data-linenos="640 "></span>    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div><h2 id="density-and-contour">Density and Contour<a class="headerlink" href="#density-and-contour" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.calculate_gene_density">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">calculate_gene_density</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">'X_umap'</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">adjust</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_expr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.calculate_gene_density" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Calculate weighted kernel density estimates for gene expression on 2D embeddings.</p>
<p>Computes KDE for each feature using expression values as weights and stores
density values in adata.obs as 'density_{feature}' columns.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td>
</td>
<td><p>Annotated data object with embedding coordinates</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>features</code></td>
<td>
</td>
<td><p>List of gene names or feature names to process</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>basis</code></td>
<td>
</td>
<td><p>Key in adata.obsm containing 2D embedding coordinates ('X_umap')</p></td>
<td>
<code>'X_umap'</code>
</td>
</tr>
<tr>
<td><code>dims</code></td>
<td>
</td>
<td><p>Embedding dimensions to use as (x_dim, y_dim) ((0, 1))</p></td>
<td>
<code>(0, 1)</code>
</td>
</tr>
<tr>
<td><code>adjust</code></td>
<td>
</td>
<td><p>Bandwidth scaling factor for KDE (1)</p></td>
<td>
<code>1</code>
</td>
</tr>
<tr>
<td><code>min_expr</code></td>
<td>
</td>
<td><p>Minimum expression threshold for including cells (0.1)</p></td>
<td>
<code>0.1</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>None</code></td> <td>
</td>
<td><p>Updates adata.obs with density_{feature} columns</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_density.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 8 "></span><span class="k">def</span> <span class="nf">calculate_gene_density</span><span class="p">(</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">features</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">basis</span><span class="o">=</span><span class="s2">"X_umap"</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">adjust</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">min_expr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>          <span class="c1"># NEW: minimal raw expression to keep as weight &gt; 0</span>
<span class="linenos" data-linenos="15 "></span><span class="p">):</span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos="17 "></span><span class="sd">    Calculate weighted kernel density estimates for gene expression on 2D embeddings.</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="sd">    Computes KDE for each feature using expression values as weights and stores</span>
<span class="linenos" data-linenos="20 "></span><span class="sd">    density values in adata.obs as 'density_{feature}' columns.</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos="23 "></span><span class="sd">        adata: Annotated data object with embedding coordinates</span>
<span class="linenos" data-linenos="24 "></span><span class="sd">        features: List of gene names or feature names to process</span>
<span class="linenos" data-linenos="25 "></span><span class="sd">        basis: Key in adata.obsm containing 2D embedding coordinates ('X_umap')</span>
<span class="linenos" data-linenos="26 "></span><span class="sd">        dims: Embedding dimensions to use as (x_dim, y_dim) ((0, 1))</span>
<span class="linenos" data-linenos="27 "></span><span class="sd">        adjust: Bandwidth scaling factor for KDE (1)</span>
<span class="linenos" data-linenos="28 "></span><span class="sd">        min_expr: Minimum expression threshold for including cells (0.1)</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="31 "></span><span class="sd">        None: Updates adata.obs with density_{feature} columns</span>
<span class="linenos" data-linenos="32 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="33 "></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos" data-linenos="34 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"`dims` must have length 2"</span><span class="p">)</span>
<span class="linenos" data-linenos="35 "></span>    <span class="k">if</span> <span class="n">basis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
<span class="linenos" data-linenos="36 "></span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Embedding '</span><span class="si">{</span><span class="n">basis</span><span class="si">}</span><span class="s2">' not found."</span><span class="p">)</span>
<span class="linenos" data-linenos="37 "></span>
<span class="linenos" data-linenos="38 "></span>    <span class="n">emb_all</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">basis</span><span class="p">][:,</span> <span class="n">dims</span><span class="p">]</span>          <span class="c1"># (n_cells, 2)</span>
<span class="linenos" data-linenos="39 "></span>
<span class="linenos" data-linenos="40 "></span>    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
<span class="linenos" data-linenos="41 "></span>        <span class="c1"># ----- fetch raw weights -------------------------------------------</span>
<span class="linenos" data-linenos="42 "></span>        <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
<span class="linenos" data-linenos="43 "></span>            <span class="n">w_raw</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="linenos" data-linenos="44 "></span>        <span class="k">elif</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">:</span>
<span class="linenos" data-linenos="45 "></span>            <span class="n">w_raw</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="linenos" data-linenos="46 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="47 "></span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Feature '</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">' not found in obs or var."</span><span class="p">)</span>
<span class="linenos" data-linenos="48 "></span>
<span class="linenos" data-linenos="49 "></span>        <span class="c1"># ----- validity mask: finite coords &amp; finite expr -------------------</span>
<span class="linenos" data-linenos="50 "></span>        <span class="n">mask_finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">w_raw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">emb_all</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="51 "></span>
<span class="linenos" data-linenos="52 "></span>        <span class="c1"># ----- NEW: expression threshold -----------------------------------</span>
<span class="linenos" data-linenos="53 "></span>        <span class="n">mask_expr</span>   <span class="o">=</span> <span class="n">w_raw</span> <span class="o">&gt;</span> <span class="n">min_expr</span>
<span class="linenos" data-linenos="54 "></span>        <span class="n">mask_train</span>  <span class="o">=</span> <span class="n">mask_finite</span> <span class="o">&amp;</span> <span class="n">mask_expr</span>
<span class="linenos" data-linenos="55 "></span>
<span class="linenos" data-linenos="56 "></span>        <span class="n">emb_train</span>   <span class="o">=</span> <span class="n">emb_all</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>
<span class="linenos" data-linenos="57 "></span>        <span class="n">w_train_raw</span> <span class="o">=</span> <span class="n">w_raw</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>
<span class="linenos" data-linenos="58 "></span>
<span class="linenos" data-linenos="59 "></span>        <span class="k">if</span> <span class="n">emb_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
<span class="linenos" data-linenos="60 "></span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">] too few cells above threshold; skipping KDE."</span><span class="p">)</span>
<span class="linenos" data-linenos="61 "></span>            <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">"density_</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos" data-linenos="62 "></span>            <span class="k">continue</span>
<span class="linenos" data-linenos="63 "></span>
<span class="linenos" data-linenos="64 "></span>        <span class="c1"># ----- min–max scale to 0-1 ----------------------------------------</span>
<span class="linenos" data-linenos="65 "></span>        <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span> <span class="o">=</span> <span class="n">w_train_raw</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">w_train_raw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos" data-linenos="66 "></span>        <span class="n">w_train</span>      <span class="o">=</span> <span class="p">(</span><span class="n">w_train_raw</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_max</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span>
<span class="linenos" data-linenos="67 "></span>
<span class="linenos" data-linenos="68 "></span>        <span class="c1"># ----- KDE fit ------------------------------------------------------</span>
<span class="linenos" data-linenos="69 "></span>        <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">emb_train</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_train</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">adjust</span><span class="p">)</span>
<span class="linenos" data-linenos="70 "></span>
<span class="linenos" data-linenos="71 "></span>        <span class="c1"># ----- evaluate on ALL cells ---------------------------------------</span>
<span class="linenos" data-linenos="72 "></span>        <span class="n">density</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">emb_all</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="linenos" data-linenos="73 "></span>        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">"density_</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">density</span>
<span class="linenos" data-linenos="74 "></span>
<span class="linenos" data-linenos="75 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"✅ density_</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> written (train cells = </span><span class="si">{</span><span class="n">emb_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.add_density_contour">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">add_density_contour</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="s1">'quantile'</span><span class="p">,</span> <span class="n">n_quantiles</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap_contour</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.add_density_contour" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Add KDE-based density contours to an existing matplotlib plot.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ax</code></td>
<td>
</td>
<td><p>matplotlib.axes.Axes object to draw contours on</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>embeddings</code></td>
<td>
</td>
<td><p>2D coordinate array with shape (n_cells, 2)</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>weights</code></td>
<td>
</td>
<td><p>1D weight array for KDE, will be min-max normalized</p></td>
<td>
<em>required</em>
</td>
</tr>
<tr>
<td><code>levels</code></td>
<td>
</td>
<td><p>Contour level specification - 'quantile' or list of values ('quantile')</p></td>
<td>
<code>'quantile'</code>
</td>
</tr>
<tr>
<td><code>n_quantiles</code></td>
<td>
</td>
<td><p>Number of quantile levels when levels='quantile' (5)</p></td>
<td>
<code>5</code>
</td>
</tr>
<tr>
<td><code>bw_adjust</code></td>
<td>
</td>
<td><p>Bandwidth adjustment factor for KDE (0.3)</p></td>
<td>
<code>0.3</code>
</td>
</tr>
<tr>
<td><code>cmap_contour</code></td>
<td>
</td>
<td><p>Colormap for contour lines ('Greys')</p></td>
<td>
<code>'Greys'</code>
</td>
</tr>
<tr>
<td><code>linewidth</code></td>
<td>
</td>
<td><p>Width of contour lines (1.0)</p></td>
<td>
<code>1.0</code>
</td>
</tr>
<tr>
<td><code>zorder</code></td>
<td>
</td>
<td><p>Drawing order for contours (10)</p></td>
<td>
<code>10</code>
</td>
</tr>
<tr>
<td><code>fill</code></td>
<td>
</td>
<td><p>Whether to fill contours (False for lines, True for filled)</p></td>
<td>
<code>False</code>
</td>
</tr>
<tr>
<td><code>alpha</code></td>
<td>
</td>
<td><p>Transparency for filled contours (0.4)</p></td>
<td>
<code>0.4</code>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Name</th> <th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cs</code></td> <td>
</td>
<td><p>matplotlib contour object for potential colorbar addition</p></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_density.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 82 "></span><span class="k">def</span> <span class="nf">add_density_contour</span><span class="p">(</span>
<span class="linenos" data-linenos=" 83 "></span>    <span class="n">ax</span><span class="p">,</span>
<span class="linenos" data-linenos=" 84 "></span>    <span class="n">embeddings</span><span class="p">,</span>              <span class="c1"># (n_cells, 2) array</span>
<span class="linenos" data-linenos=" 85 "></span>    <span class="n">weights</span><span class="p">,</span>                 <span class="c1"># 1-D array, will be min-max scaled</span>
<span class="linenos" data-linenos=" 86 "></span>    <span class="n">levels</span><span class="o">=</span><span class="s2">"quantile"</span><span class="p">,</span>       <span class="c1"># "quantile" or a numeric list, see below</span>
<span class="linenos" data-linenos=" 87 "></span>    <span class="n">n_quantiles</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="linenos" data-linenos=" 88 "></span>    <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="linenos" data-linenos=" 89 "></span>    <span class="n">cmap_contour</span><span class="o">=</span><span class="s2">"Greys"</span><span class="p">,</span>
<span class="linenos" data-linenos=" 90 "></span>    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 91 "></span>    <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos=" 92 "></span>    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 93 "></span>    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
<span class="linenos" data-linenos=" 94 "></span><span class="p">):</span>
<span class="linenos" data-linenos=" 95 "></span><span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="linenos" data-linenos=" 96 "></span><span class="sd">    Add KDE-based density contours to an existing matplotlib plot.</span>
<span class="linenos" data-linenos=" 97 "></span>
<span class="linenos" data-linenos=" 98 "></span><span class="sd">    Arguments:</span>
<span class="linenos" data-linenos=" 99 "></span><span class="sd">        ax: matplotlib.axes.Axes object to draw contours on</span>
<span class="linenos" data-linenos="100 "></span><span class="sd">        embeddings: 2D coordinate array with shape (n_cells, 2)</span>
<span class="linenos" data-linenos="101 "></span><span class="sd">        weights: 1D weight array for KDE, will be min-max normalized</span>
<span class="linenos" data-linenos="102 "></span><span class="sd">        levels: Contour level specification - 'quantile' or list of values ('quantile')</span>
<span class="linenos" data-linenos="103 "></span><span class="sd">        n_quantiles: Number of quantile levels when levels='quantile' (5)</span>
<span class="linenos" data-linenos="104 "></span><span class="sd">        bw_adjust: Bandwidth adjustment factor for KDE (0.3)</span>
<span class="linenos" data-linenos="105 "></span><span class="sd">        cmap_contour: Colormap for contour lines ('Greys')</span>
<span class="linenos" data-linenos="106 "></span><span class="sd">        linewidth: Width of contour lines (1.0)</span>
<span class="linenos" data-linenos="107 "></span><span class="sd">        zorder: Drawing order for contours (10)</span>
<span class="linenos" data-linenos="108 "></span><span class="sd">        fill: Whether to fill contours (False for lines, True for filled)</span>
<span class="linenos" data-linenos="109 "></span><span class="sd">        alpha: Transparency for filled contours (0.4)</span>
<span class="linenos" data-linenos="110 "></span>
<span class="linenos" data-linenos="111 "></span><span class="sd">    Returns:</span>
<span class="linenos" data-linenos="112 "></span><span class="sd">        cs: matplotlib contour object for potential colorbar addition</span>
<span class="linenos" data-linenos="113 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="114 "></span>    <span class="c1"># ---------- fit KDE ----------------------------------------------------</span>
<span class="linenos" data-linenos="115 "></span>    <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos" data-linenos="116 "></span>    <span class="n">w_norm</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">w_max</span> <span class="o">==</span> <span class="n">w_min</span> <span class="k">else</span> <span class="p">(</span><span class="n">weights</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_max</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span>
<span class="linenos" data-linenos="117 "></span>    <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_norm</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">bw_adjust</span><span class="p">)</span>
<span class="linenos" data-linenos="118 "></span>
<span class="linenos" data-linenos="119 "></span>    <span class="c1"># ---------- prepare evaluation grid -----------------------------------</span>
<span class="linenos" data-linenos="120 "></span>    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos" data-linenos="121 "></span>    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos" data-linenos="122 "></span>    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="mi">300</span><span class="n">j</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="mi">300</span><span class="n">j</span><span class="p">]</span>   <span class="c1"># 300×300 grid</span>
<span class="linenos" data-linenos="123 "></span>    <span class="n">grid</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos" data-linenos="124 "></span>
<span class="linenos" data-linenos="125 "></span>    <span class="c1"># ---------- determine contour levels ----------------------------------</span>
<span class="linenos" data-linenos="126 "></span>    <span class="k">if</span> <span class="n">levels</span> <span class="o">==</span> <span class="s2">"quantile"</span><span class="p">:</span>
<span class="linenos" data-linenos="127 "></span>        <span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_quantiles</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># drop 0 &amp; 1</span>
<span class="linenos" data-linenos="128 "></span>        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="linenos" data-linenos="129 "></span>
<span class="linenos" data-linenos="130 "></span>    <span class="c1"># ---------- draw -------------------------------------------------------</span>
<span class="linenos" data-linenos="131 "></span>    <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
<span class="linenos" data-linenos="132 "></span>        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
<span class="linenos" data-linenos="133 "></span>            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span>
<span class="linenos" data-linenos="134 "></span>            <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
<span class="linenos" data-linenos="135 "></span>            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_contour</span><span class="p">,</span>
<span class="linenos" data-linenos="136 "></span>            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
<span class="linenos" data-linenos="137 "></span>            <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
<span class="linenos" data-linenos="138 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="139 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="140 "></span>        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
<span class="linenos" data-linenos="141 "></span>            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span>
<span class="linenos" data-linenos="142 "></span>            <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
<span class="linenos" data-linenos="143 "></span>            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_contour</span><span class="p">,</span>
<span class="linenos" data-linenos="144 "></span>            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>
<span class="linenos" data-linenos="145 "></span>            <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
<span class="linenos" data-linenos="146 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="147 "></span>    <span class="k">return</span> <span class="n">cs</span>   <span class="c1"># so you can add a colorbar if desired</span>
</code></pre></div>
</details>
</div>
</div><h2 id="spatial-plotting">Spatial Plotting<a class="headerlink" href="#spatial-plotting" title="Permanent link">¶</a></h2>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.spatial_segment">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_segment</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">seg_cell_id</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seg_key</span><span class="o">=</span><span class="s1">'segmentation'</span><span class="p">,</span> <span class="n">seg_contourpx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seg_outline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.spatial_segment" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Plot spatial omics data with segmentation masks on top.</p>
<p>Argument <code>seg_cell_id</code> in :attr:<code>anndata.AnnData.obs</code> controls unique segmentation mask's ids to be plotted.
By default, <code>'segmentation'</code>, <code>seg_key</code> for the segmentation and <code>'hires'</code> for the image is attempted.</p>
<div class="highlight"><pre><span></span><code>- Use ``seg_key`` to display the image in the background.
- Use ``seg_contourpx`` or ``seg_outline`` to control how the segmentation mask is displayed.
</code></pre></div>
<p>%(spatial_plot.summary_ext)s</p>
<p>.. seealso::
    - :func:<code>squidpy.pl.spatial_scatter</code> on how to plot spatial data with overlayed data on top.</p>
<h4 id="omicverse.pl.spatial_segment--parameters">Parameters<a class="headerlink" href="#omicverse.pl.spatial_segment--parameters" title="Permanent link">¶</a></h4>
<p>%(adata)s
%(plotting_segment)s
%(color)s
%(groups)s
%(library_id)s
%(library_key)s
%(spatial_key)s
%(plotting_image)s
%(plotting_features)s</p>
<h4 id="omicverse.pl.spatial_segment--returns">Returns<a class="headerlink" href="#omicverse.pl.spatial_segment--returns" title="Permanent link">¶</a></h4>
<p>%(spatial_plot.returns)s</p>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_spatial.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1755 "></span><span class="k">def</span> <span class="nf">spatial_segment</span><span class="p">(</span>
<span class="linenos" data-linenos="1756 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos="1757 "></span>    <span class="n">seg_cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos" data-linenos="1758 "></span>    <span class="n">seg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="1759 "></span>    <span class="n">seg_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"segmentation"</span><span class="p">,</span>
<span class="linenos" data-linenos="1760 "></span>    <span class="n">seg_contourpx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1761 "></span>    <span class="n">seg_outline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="1762 "></span>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos" data-linenos="1763 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1764 "></span><span class="w">    </span><span class="sd">"""</span>
<span class="linenos" data-linenos="1765 "></span><span class="sd">    Plot spatial omics data with segmentation masks on top.</span>
<span class="linenos" data-linenos="1766 "></span>
<span class="linenos" data-linenos="1767 "></span><span class="sd">    Argument ``seg_cell_id`` in :attr:`anndata.AnnData.obs` controls unique segmentation mask's ids to be plotted.</span>
<span class="linenos" data-linenos="1768 "></span><span class="sd">    By default, ``'segmentation'``, ``seg_key`` for the segmentation and ``'hires'`` for the image is attempted.</span>
<span class="linenos" data-linenos="1769 "></span>
<span class="linenos" data-linenos="1770 "></span><span class="sd">        - Use ``seg_key`` to display the image in the background.</span>
<span class="linenos" data-linenos="1771 "></span><span class="sd">        - Use ``seg_contourpx`` or ``seg_outline`` to control how the segmentation mask is displayed.</span>
<span class="linenos" data-linenos="1772 "></span>
<span class="linenos" data-linenos="1773 "></span><span class="sd">    %(spatial_plot.summary_ext)s</span>
<span class="linenos" data-linenos="1774 "></span>
<span class="linenos" data-linenos="1775 "></span><span class="sd">    .. seealso::</span>
<span class="linenos" data-linenos="1776 "></span><span class="sd">        - :func:`squidpy.pl.spatial_scatter` on how to plot spatial data with overlayed data on top.</span>
<span class="linenos" data-linenos="1777 "></span>
<span class="linenos" data-linenos="1778 "></span><span class="sd">    Parameters</span>
<span class="linenos" data-linenos="1779 "></span><span class="sd">    ----------</span>
<span class="linenos" data-linenos="1780 "></span><span class="sd">    %(adata)s</span>
<span class="linenos" data-linenos="1781 "></span><span class="sd">    %(plotting_segment)s</span>
<span class="linenos" data-linenos="1782 "></span><span class="sd">    %(color)s</span>
<span class="linenos" data-linenos="1783 "></span><span class="sd">    %(groups)s</span>
<span class="linenos" data-linenos="1784 "></span><span class="sd">    %(library_id)s</span>
<span class="linenos" data-linenos="1785 "></span><span class="sd">    %(library_key)s</span>
<span class="linenos" data-linenos="1786 "></span><span class="sd">    %(spatial_key)s</span>
<span class="linenos" data-linenos="1787 "></span><span class="sd">    %(plotting_image)s</span>
<span class="linenos" data-linenos="1788 "></span><span class="sd">    %(plotting_features)s</span>
<span class="linenos" data-linenos="1789 "></span>
<span class="linenos" data-linenos="1790 "></span><span class="sd">    Returns</span>
<span class="linenos" data-linenos="1791 "></span><span class="sd">    -------</span>
<span class="linenos" data-linenos="1792 "></span><span class="sd">    %(spatial_plot.returns)s</span>
<span class="linenos" data-linenos="1793 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="1794 "></span>    <span class="kn">from</span> <span class="nn">squidpy._docs</span> <span class="kn">import</span> <span class="n">d</span>
<span class="linenos" data-linenos="1795 "></span>
<span class="linenos" data-linenos="1796 "></span>    <span class="k">return</span> <span class="n">_spatial_plot</span><span class="p">(</span>
<span class="linenos" data-linenos="1797 "></span>        <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="1798 "></span>        <span class="n">seg</span><span class="o">=</span><span class="n">seg</span><span class="p">,</span>
<span class="linenos" data-linenos="1799 "></span>        <span class="n">seg_key</span><span class="o">=</span><span class="n">seg_key</span><span class="p">,</span>
<span class="linenos" data-linenos="1800 "></span>        <span class="n">seg_cell_id</span><span class="o">=</span><span class="n">seg_cell_id</span><span class="p">,</span>
<span class="linenos" data-linenos="1801 "></span>        <span class="n">seg_contourpx</span><span class="o">=</span><span class="n">seg_contourpx</span><span class="p">,</span>
<span class="linenos" data-linenos="1802 "></span>        <span class="n">seg_outline</span><span class="o">=</span><span class="n">seg_outline</span><span class="p">,</span>
<span class="linenos" data-linenos="1803 "></span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos" data-linenos="1804 "></span>    <span class="p">)</span>
</code></pre></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="omicverse.pl.spatial_segment_overlay">
<code class="highlight language-python"><span class="n">omicverse</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_segment_overlay</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">seg_cell_id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seg_key</span><span class="o">=</span><span class="s1">'segmentation'</span><span class="p">,</span> <span class="n">seg_contourpx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seg_outline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cmaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">library_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">library_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_key</span><span class="o">=</span><span class="s1">'spatial'</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">img_res_key</span><span class="o">=</span><span class="s1">'hires'</span><span class="p">,</span> <span class="n">img_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">na_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size_key</span><span class="o">=</span><span class="s1">'spot_diameter_fullres'</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crop_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connectivity_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edges_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edges_color</span><span class="o">=</span><span class="s1">'grey'</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">'right margin'</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">,</span> <span class="n">legend_fontoutline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_na</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar_position</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">colorbar_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar_tick_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">colorbar_title_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">colorbar_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar_spacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scalebar_dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scalebar_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_ax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scalebar_kwargs</span><span class="o">=</span><span class="n">MappingProxyType</span><span class="p">({}),</span> <span class="n">edges_kwargs</span><span class="o">=</span><span class="n">MappingProxyType</span><span class="p">({}),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
<a class="headerlink" href="#omicverse.pl.spatial_segment_overlay" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Plot multiple genes overlaid on the same spatial segmentation plot.</p>
<p>This function allows visualization of multiple genes in the same spatial context,
using different colors and transparency to show expression overlap and co-localization.</p>
<h4 id="omicverse.pl.spatial_segment_overlay--parameters">Parameters<a class="headerlink" href="#omicverse.pl.spatial_segment_overlay--parameters" title="Permanent link">¶</a></h4>
<p>%(adata)s
seg_cell_id
    Key in :attr:<code>anndata.AnnData.obs</code> that contains unique cell IDs for segmentation.
color
    Gene names or features to plot. Can be a single gene or list of genes.
seg
    Segmentation mask. If <code>True</code>, uses segmentation from <code>adata.uns['spatial']</code>.
seg_key
    Key for segmentation mask in <code>adata.uns['spatial'][library_id]['images']</code>.
seg_contourpx
    Contour width in pixels. If specified, segmentation boundaries will be eroded.
seg_outline
    If <code>True</code>, show segmentation boundaries.
alpha
    Transparency level for gene expression overlay (0-1).
cmaps
    Colormap(s) for each gene. If single string, uses same colormap for all genes.
    If list, should match length of <code>color</code> parameter.
%(library_id)s
%(library_key)s<br/>
%(spatial_key)s
%(plotting_image)s
%(plotting_features)s
groups
    Categories to plot for categorical features.
palette
    Color palette for categorical features.
norm
    Colormap normalization.
na_color
    Color for NA/missing values.
colorbar
    Whether to show colorbars for each gene.
colorbar_position
    Position of colorbars: 'bottom', 'right', or 'none'.
colorbar_grid
    Grid layout for colorbars as (rows, cols). If None, auto-determined.
colorbar_tick_size
    Font size for colorbar tick labels.
colorbar_title_size
    Font size for colorbar titles.
colorbar_width
    Width of individual colorbars. If None, uses default values.
colorbar_height
    Height of individual colorbars. If None, uses default values.
colorbar_spacing
    Dictionary with spacing parameters: 'hspace' (vertical gaps), 'wspace' (horizontal gaps).
    If None, uses default spacing.
title
    Plot title.
ax
    Matplotlib axes object to plot on.
return_ax
    Whether to return the axes object.
figsize
    Figure size (width, height).
save
    Path to save the figure.</p>
<h4 id="omicverse.pl.spatial_segment_overlay--returns">Returns<a class="headerlink" href="#omicverse.pl.spatial_segment_overlay--returns" title="Permanent link">¶</a></h4>
<p>If <code>return_ax</code> is <code>True</code>, returns matplotlib axes object, otherwise <code>None</code>.</p>
<h4 id="omicverse.pl.spatial_segment_overlay--examples">Examples<a class="headerlink" href="#omicverse.pl.spatial_segment_overlay--examples" title="Permanent link">¶</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>import squidpy as sq</p>
<h3 id="omicverse.pl.spatial_segment_overlay--overlay-two-genes-with-different-colors">Overlay two genes with different colors<a class="headerlink" href="#omicverse.pl.spatial_segment_overlay--overlay-two-genes-with-different-colors" title="Permanent link">¶</a></h3>
<p>sq.pl.spatial_segment_overlay(
...     adata, 
...     seg_cell_id='cell_id',
...     color=['gene1', 'gene2'],
...     cmaps=['Reds', 'Blues'],
...     alpha=0.7
... )</p>
</blockquote>
</blockquote>
</blockquote>
<details class="quote">
<summary>Source code in <code>/Users/fernandozeng/miniforge3/envs/space/lib/python3.10/site-packages/omicverse/pl/_spatial.py</code></summary>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1807 "></span><span class="k">def</span> <span class="nf">spatial_segment_overlay</span><span class="p">(</span>
<span class="linenos" data-linenos="1808 "></span>    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
<span class="linenos" data-linenos="1809 "></span>    <span class="n">seg_cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos" data-linenos="1810 "></span>    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="linenos" data-linenos="1811 "></span>    <span class="n">seg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="1812 "></span>    <span class="n">seg_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"segmentation"</span><span class="p">,</span>
<span class="linenos" data-linenos="1813 "></span>    <span class="n">seg_contourpx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1814 "></span>    <span class="n">seg_outline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="1815 "></span>    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="linenos" data-linenos="1816 "></span>    <span class="n">cmaps</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1817 "></span>    <span class="n">library_id</span><span class="p">:</span> <span class="n">_SeqStr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1818 "></span>    <span class="n">library_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1819 "></span>    <span class="n">spatial_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"spatial"</span><span class="p">,</span>  
<span class="linenos" data-linenos="1820 "></span>    <span class="n">img</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="1821 "></span>    <span class="n">img_res_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">"hires"</span><span class="p">,</span>
<span class="linenos" data-linenos="1822 "></span>    <span class="n">img_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1823 "></span>    <span class="n">img_cmap</span><span class="p">:</span> <span class="n">Colormap</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1824 "></span>    <span class="n">img_channel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1825 "></span>    <span class="n">use_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1826 "></span>    <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1827 "></span>    <span class="n">alt_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1828 "></span>    <span class="n">groups</span><span class="p">:</span> <span class="n">_SeqStr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1829 "></span>    <span class="n">palette</span><span class="p">:</span> <span class="n">Palette_t</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1830 "></span>    <span class="n">norm</span><span class="p">:</span> <span class="n">_Normalize</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1831 "></span>    <span class="n">na_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="linenos" data-linenos="1832 "></span>    <span class="n">size</span><span class="p">:</span> <span class="n">_SeqFloat</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1833 "></span>    <span class="n">size_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">"spot_diameter_fullres"</span><span class="p">,</span>
<span class="linenos" data-linenos="1834 "></span>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">_SeqFloat</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1835 "></span>    <span class="n">crop_coord</span><span class="p">:</span> <span class="n">_CoordTuple</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_CoordTuple</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1836 "></span>    <span class="n">connectivity_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1837 "></span>    <span class="n">edges_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos" data-linenos="1838 "></span>    <span class="n">edges_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"grey"</span><span class="p">,</span>
<span class="linenos" data-linenos="1839 "></span>    <span class="n">frameon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1840 "></span>    <span class="n">legend_loc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">"right margin"</span><span class="p">,</span>
<span class="linenos" data-linenos="1841 "></span>    <span class="n">legend_fontsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">_FontSize</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1842 "></span>    <span class="n">legend_fontweight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">_FontWeight</span> <span class="o">=</span> <span class="s2">"bold"</span><span class="p">,</span>
<span class="linenos" data-linenos="1843 "></span>    <span class="n">legend_fontoutline</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1844 "></span>    <span class="n">legend_na</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="1845 "></span>    <span class="n">colorbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="1846 "></span>    <span class="n">colorbar_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"bottom"</span><span class="p">,</span>
<span class="linenos" data-linenos="1847 "></span>    <span class="n">colorbar_grid</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1848 "></span>    <span class="n">colorbar_tick_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos="1849 "></span>    <span class="n">colorbar_title_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="linenos" data-linenos="1850 "></span>    <span class="n">colorbar_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1851 "></span>    <span class="n">colorbar_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1852 "></span>    <span class="n">colorbar_spacing</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1853 "></span>    <span class="n">scalebar_dx</span><span class="p">:</span> <span class="n">_SeqFloat</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1854 "></span>    <span class="n">scalebar_units</span><span class="p">:</span> <span class="n">_SeqStr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1855 "></span>    <span class="n">title</span><span class="p">:</span> <span class="n">_SeqStr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1856 "></span>    <span class="n">axis_label</span><span class="p">:</span> <span class="n">_SeqStr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1857 "></span>    <span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1858 "></span>    <span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1859 "></span>    <span class="n">return_ax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos="1860 "></span>    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1861 "></span>    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1862 "></span>    <span class="n">save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos" data-linenos="1863 "></span>    <span class="n">scalebar_kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">MappingProxyType</span><span class="p">({}),</span>
<span class="linenos" data-linenos="1864 "></span>    <span class="n">edges_kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">MappingProxyType</span><span class="p">({}),</span>
<span class="linenos" data-linenos="1865 "></span>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos" data-linenos="1866 "></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1867 "></span><span class="w">    </span><span class="sd">"""</span>
<span class="linenos" data-linenos="1868 "></span><span class="sd">    Plot multiple genes overlaid on the same spatial segmentation plot.</span>
<span class="linenos" data-linenos="1869 "></span>
<span class="linenos" data-linenos="1870 "></span><span class="sd">    This function allows visualization of multiple genes in the same spatial context,</span>
<span class="linenos" data-linenos="1871 "></span><span class="sd">    using different colors and transparency to show expression overlap and co-localization.</span>
<span class="linenos" data-linenos="1872 "></span>
<span class="linenos" data-linenos="1873 "></span><span class="sd">    Parameters</span>
<span class="linenos" data-linenos="1874 "></span><span class="sd">    ----------</span>
<span class="linenos" data-linenos="1875 "></span><span class="sd">    %(adata)s</span>
<span class="linenos" data-linenos="1876 "></span><span class="sd">    seg_cell_id</span>
<span class="linenos" data-linenos="1877 "></span><span class="sd">        Key in :attr:`anndata.AnnData.obs` that contains unique cell IDs for segmentation.</span>
<span class="linenos" data-linenos="1878 "></span><span class="sd">    color</span>
<span class="linenos" data-linenos="1879 "></span><span class="sd">        Gene names or features to plot. Can be a single gene or list of genes.</span>
<span class="linenos" data-linenos="1880 "></span><span class="sd">    seg</span>
<span class="linenos" data-linenos="1881 "></span><span class="sd">        Segmentation mask. If `True`, uses segmentation from `adata.uns['spatial']`.</span>
<span class="linenos" data-linenos="1882 "></span><span class="sd">    seg_key</span>
<span class="linenos" data-linenos="1883 "></span><span class="sd">        Key for segmentation mask in `adata.uns['spatial'][library_id]['images']`.</span>
<span class="linenos" data-linenos="1884 "></span><span class="sd">    seg_contourpx</span>
<span class="linenos" data-linenos="1885 "></span><span class="sd">        Contour width in pixels. If specified, segmentation boundaries will be eroded.</span>
<span class="linenos" data-linenos="1886 "></span><span class="sd">    seg_outline</span>
<span class="linenos" data-linenos="1887 "></span><span class="sd">        If `True`, show segmentation boundaries.</span>
<span class="linenos" data-linenos="1888 "></span><span class="sd">    alpha</span>
<span class="linenos" data-linenos="1889 "></span><span class="sd">        Transparency level for gene expression overlay (0-1).</span>
<span class="linenos" data-linenos="1890 "></span><span class="sd">    cmaps</span>
<span class="linenos" data-linenos="1891 "></span><span class="sd">        Colormap(s) for each gene. If single string, uses same colormap for all genes.</span>
<span class="linenos" data-linenos="1892 "></span><span class="sd">        If list, should match length of `color` parameter.</span>
<span class="linenos" data-linenos="1893 "></span><span class="sd">    %(library_id)s</span>
<span class="linenos" data-linenos="1894 "></span><span class="sd">    %(library_key)s  </span>
<span class="linenos" data-linenos="1895 "></span><span class="sd">    %(spatial_key)s</span>
<span class="linenos" data-linenos="1896 "></span><span class="sd">    %(plotting_image)s</span>
<span class="linenos" data-linenos="1897 "></span><span class="sd">    %(plotting_features)s</span>
<span class="linenos" data-linenos="1898 "></span><span class="sd">    groups</span>
<span class="linenos" data-linenos="1899 "></span><span class="sd">        Categories to plot for categorical features.</span>
<span class="linenos" data-linenos="1900 "></span><span class="sd">    palette</span>
<span class="linenos" data-linenos="1901 "></span><span class="sd">        Color palette for categorical features.</span>
<span class="linenos" data-linenos="1902 "></span><span class="sd">    norm</span>
<span class="linenos" data-linenos="1903 "></span><span class="sd">        Colormap normalization.</span>
<span class="linenos" data-linenos="1904 "></span><span class="sd">    na_color</span>
<span class="linenos" data-linenos="1905 "></span><span class="sd">        Color for NA/missing values.</span>
<span class="linenos" data-linenos="1906 "></span><span class="sd">    colorbar</span>
<span class="linenos" data-linenos="1907 "></span><span class="sd">        Whether to show colorbars for each gene.</span>
<span class="linenos" data-linenos="1908 "></span><span class="sd">    colorbar_position</span>
<span class="linenos" data-linenos="1909 "></span><span class="sd">        Position of colorbars: 'bottom', 'right', or 'none'.</span>
<span class="linenos" data-linenos="1910 "></span><span class="sd">    colorbar_grid</span>
<span class="linenos" data-linenos="1911 "></span><span class="sd">        Grid layout for colorbars as (rows, cols). If None, auto-determined.</span>
<span class="linenos" data-linenos="1912 "></span><span class="sd">    colorbar_tick_size</span>
<span class="linenos" data-linenos="1913 "></span><span class="sd">        Font size for colorbar tick labels.</span>
<span class="linenos" data-linenos="1914 "></span><span class="sd">    colorbar_title_size</span>
<span class="linenos" data-linenos="1915 "></span><span class="sd">        Font size for colorbar titles.</span>
<span class="linenos" data-linenos="1916 "></span><span class="sd">    colorbar_width</span>
<span class="linenos" data-linenos="1917 "></span><span class="sd">        Width of individual colorbars. If None, uses default values.</span>
<span class="linenos" data-linenos="1918 "></span><span class="sd">    colorbar_height</span>
<span class="linenos" data-linenos="1919 "></span><span class="sd">        Height of individual colorbars. If None, uses default values.</span>
<span class="linenos" data-linenos="1920 "></span><span class="sd">    colorbar_spacing</span>
<span class="linenos" data-linenos="1921 "></span><span class="sd">        Dictionary with spacing parameters: 'hspace' (vertical gaps), 'wspace' (horizontal gaps).</span>
<span class="linenos" data-linenos="1922 "></span><span class="sd">        If None, uses default spacing.</span>
<span class="linenos" data-linenos="1923 "></span><span class="sd">    title</span>
<span class="linenos" data-linenos="1924 "></span><span class="sd">        Plot title.</span>
<span class="linenos" data-linenos="1925 "></span><span class="sd">    ax</span>
<span class="linenos" data-linenos="1926 "></span><span class="sd">        Matplotlib axes object to plot on.</span>
<span class="linenos" data-linenos="1927 "></span><span class="sd">    return_ax</span>
<span class="linenos" data-linenos="1928 "></span><span class="sd">        Whether to return the axes object.</span>
<span class="linenos" data-linenos="1929 "></span><span class="sd">    figsize</span>
<span class="linenos" data-linenos="1930 "></span><span class="sd">        Figure size (width, height).</span>
<span class="linenos" data-linenos="1931 "></span><span class="sd">    save</span>
<span class="linenos" data-linenos="1932 "></span><span class="sd">        Path to save the figure.</span>
<span class="linenos" data-linenos="1933 "></span>
<span class="linenos" data-linenos="1934 "></span><span class="sd">    Returns</span>
<span class="linenos" data-linenos="1935 "></span><span class="sd">    -------</span>
<span class="linenos" data-linenos="1936 "></span><span class="sd">    If `return_ax` is `True`, returns matplotlib axes object, otherwise `None`.</span>
<span class="linenos" data-linenos="1937 "></span>
<span class="linenos" data-linenos="1938 "></span><span class="sd">    Examples</span>
<span class="linenos" data-linenos="1939 "></span><span class="sd">    --------</span>
<span class="linenos" data-linenos="1940 "></span><span class="sd">    &gt;&gt;&gt; import squidpy as sq</span>
<span class="linenos" data-linenos="1941 "></span><span class="sd">    &gt;&gt;&gt; # Overlay two genes with different colors</span>
<span class="linenos" data-linenos="1942 "></span><span class="sd">    &gt;&gt;&gt; sq.pl.spatial_segment_overlay(</span>
<span class="linenos" data-linenos="1943 "></span><span class="sd">    ...     adata, </span>
<span class="linenos" data-linenos="1944 "></span><span class="sd">    ...     seg_cell_id='cell_id',</span>
<span class="linenos" data-linenos="1945 "></span><span class="sd">    ...     color=['gene1', 'gene2'],</span>
<span class="linenos" data-linenos="1946 "></span><span class="sd">    ...     cmaps=['Reds', 'Blues'],</span>
<span class="linenos" data-linenos="1947 "></span><span class="sd">    ...     alpha=0.7</span>
<span class="linenos" data-linenos="1948 "></span><span class="sd">    ... )</span>
<span class="linenos" data-linenos="1949 "></span><span class="sd">    """</span>
<span class="linenos" data-linenos="1950 "></span>    <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span><span class="p">,</span> <span class="n">to_rgb</span>
<span class="linenos" data-linenos="1951 "></span>    <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="linenos" data-linenos="1952 "></span>    <span class="kn">from</span> <span class="nn">squidpy.pl._utils</span> <span class="kn">import</span> <span class="n">sanitize_anndata</span><span class="p">,</span> <span class="n">save_fig</span>
<span class="linenos" data-linenos="1953 "></span>    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="linenos" data-linenos="1954 "></span>    <span class="kn">from</span> <span class="nn">squidpy.gr._utils</span> <span class="kn">import</span> <span class="n">_assert_spatial_basis</span>
<span class="linenos" data-linenos="1955 "></span>
<span class="linenos" data-linenos="1956 "></span>    <span class="n">sanitize_anndata</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="linenos" data-linenos="1957 "></span>    <span class="n">_assert_spatial_basis</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">spatial_key</span><span class="p">)</span>
<span class="linenos" data-linenos="1958 "></span>
<span class="linenos" data-linenos="1959 "></span>    <span class="c1"># Ensure color is a list</span>
<span class="linenos" data-linenos="1960 "></span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="1961 "></span>        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="p">]</span>
<span class="linenos" data-linenos="1962 "></span>
<span class="linenos" data-linenos="1963 "></span>    <span class="c1"># Handle colormaps</span>
<span class="linenos" data-linenos="1964 "></span>    <span class="k">if</span> <span class="n">cmaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1965 "></span>        <span class="c1"># Default colors for overlay: Red, Green, Blue, Cyan, Magenta, Yellow</span>
<span class="linenos" data-linenos="1966 "></span>        <span class="n">default_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'#FF0000'</span><span class="p">,</span> <span class="s1">'#00FF00'</span><span class="p">,</span> <span class="s1">'#0000FF'</span><span class="p">,</span> <span class="s1">'#00FFFF'</span><span class="p">,</span> <span class="s1">'#FF00FF'</span><span class="p">,</span> <span class="s1">'#FFFF00'</span><span class="p">]</span>
<span class="linenos" data-linenos="1967 "></span>        <span class="n">cmaps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="1968 "></span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
<span class="linenos" data-linenos="1969 "></span>            <span class="n">base_color</span> <span class="o">=</span> <span class="n">default_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_colors</span><span class="p">)]</span>
<span class="linenos" data-linenos="1970 "></span>            <span class="n">base_rgb</span> <span class="o">=</span> <span class="n">to_rgb</span><span class="p">(</span><span class="n">base_color</span><span class="p">)</span>
<span class="linenos" data-linenos="1971 "></span>            <span class="n">cmap_colors</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="1972 "></span>                <span class="n">base_rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,),</span>  <span class="c1"># Transparent</span>
<span class="linenos" data-linenos="1973 "></span>                <span class="n">base_rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,)</span>   <span class="c1"># Opaque</span>
<span class="linenos" data-linenos="1974 "></span>            <span class="p">]</span>
<span class="linenos" data-linenos="1975 "></span>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="sa">f</span><span class="s1">'overlay_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">cmap_colors</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos" data-linenos="1976 "></span>            <span class="n">cmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
<span class="linenos" data-linenos="1977 "></span>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmaps</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos" data-linenos="1978 "></span>        <span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmaps</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
<span class="linenos" data-linenos="1979 "></span>
<span class="linenos" data-linenos="1980 "></span>    <span class="c1"># Create figure and axes with colorbar layout</span>
<span class="linenos" data-linenos="1981 "></span>    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1982 "></span>        <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="linenos" data-linenos="1983 "></span>
<span class="linenos" data-linenos="1984 "></span>        <span class="k">if</span> <span class="n">colorbar</span> <span class="ow">and</span> <span class="n">colorbar_position</span> <span class="o">!=</span> <span class="s2">"none"</span><span class="p">:</span>
<span class="linenos" data-linenos="1985 "></span>            <span class="c1"># Set default colorbar dimensions and spacing</span>
<span class="linenos" data-linenos="1986 "></span>            <span class="k">if</span> <span class="n">colorbar_spacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1987 "></span>                <span class="n">colorbar_spacing</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos" data-linenos="1988 "></span>
<span class="linenos" data-linenos="1989 "></span>            <span class="c1"># Determine colorbar grid layout</span>
<span class="linenos" data-linenos="1990 "></span>            <span class="k">if</span> <span class="n">colorbar_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="1991 "></span>                <span class="k">if</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"bottom"</span><span class="p">:</span>
<span class="linenos" data-linenos="1992 "></span>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos" data-linenos="1993 "></span>                        <span class="n">colorbar_grid</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>
<span class="linenos" data-linenos="1994 "></span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="1995 "></span>                        <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>  <span class="c1"># Round up division</span>
<span class="linenos" data-linenos="1996 "></span>                        <span class="n">colorbar_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos" data-linenos="1997 "></span>                <span class="k">elif</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"right"</span><span class="p">:</span>
<span class="linenos" data-linenos="1998 "></span>                    <span class="n">colorbar_grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="1999 "></span>
<span class="linenos" data-linenos="2000 "></span>            <span class="c1"># Create GridSpec layout with customizable dimensions</span>
<span class="linenos" data-linenos="2001 "></span>            <span class="k">if</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"bottom"</span><span class="p">:</span>
<span class="linenos" data-linenos="2002 "></span>                <span class="c1"># Default dimensions for bottom colorbars</span>
<span class="linenos" data-linenos="2003 "></span>                <span class="n">default_width</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="k">if</span> <span class="n">colorbar_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">colorbar_width</span>
<span class="linenos" data-linenos="2004 "></span>                <span class="n">default_height</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="k">if</span> <span class="n">colorbar_height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">colorbar_height</span>
<span class="linenos" data-linenos="2005 "></span>                <span class="n">default_hspace</span> <span class="o">=</span> <span class="n">colorbar_spacing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'hspace'</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="linenos" data-linenos="2006 "></span>                <span class="n">default_wspace</span> <span class="o">=</span> <span class="n">colorbar_spacing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'wspace'</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos" data-linenos="2007 "></span>
<span class="linenos" data-linenos="2008 "></span>                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span>
<span class="linenos" data-linenos="2009 "></span>                    <span class="n">nrows</span><span class="o">=</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="2010 "></span>                    <span class="n">ncols</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos" data-linenos="2011 "></span>                    <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">default_width</span><span class="p">]</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="linenos" data-linenos="2012 "></span>                    <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">default_height</span><span class="p">]</span> <span class="o">*</span> <span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
<span class="linenos" data-linenos="2013 "></span>                    <span class="n">hspace</span><span class="o">=</span><span class="n">default_hspace</span><span class="p">,</span>
<span class="linenos" data-linenos="2014 "></span>                    <span class="n">wspace</span><span class="o">=</span><span class="n">default_wspace</span><span class="p">,</span>
<span class="linenos" data-linenos="2015 "></span>                    <span class="n">figure</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
<span class="linenos" data-linenos="2016 "></span>                <span class="p">)</span>
<span class="linenos" data-linenos="2017 "></span>                <span class="n">fig</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">figure</span>
<span class="linenos" data-linenos="2018 "></span>                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="linenos" data-linenos="2019 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="2020 "></span>            <span class="k">elif</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"right"</span><span class="p">:</span>
<span class="linenos" data-linenos="2021 "></span>                <span class="c1"># Default dimensions for right colorbars</span>
<span class="linenos" data-linenos="2022 "></span>                <span class="n">default_width</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="k">if</span> <span class="n">colorbar_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">colorbar_width</span>
<span class="linenos" data-linenos="2023 "></span>                <span class="n">default_height</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="k">if</span> <span class="n">colorbar_height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">colorbar_height</span>
<span class="linenos" data-linenos="2024 "></span>                <span class="n">default_hspace</span> <span class="o">=</span> <span class="n">colorbar_spacing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'hspace'</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos" data-linenos="2025 "></span>                <span class="n">default_wspace</span> <span class="o">=</span> <span class="n">colorbar_spacing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'wspace'</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="linenos" data-linenos="2026 "></span>
<span class="linenos" data-linenos="2027 "></span>                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span>
<span class="linenos" data-linenos="2028 "></span>                    <span class="n">nrows</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos" data-linenos="2029 "></span>                    <span class="n">ncols</span><span class="o">=</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="2030 "></span>                    <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">default_width</span><span class="p">]</span> <span class="o">*</span> <span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
<span class="linenos" data-linenos="2031 "></span>                    <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">default_height</span><span class="p">]</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="linenos" data-linenos="2032 "></span>                    <span class="n">hspace</span><span class="o">=</span><span class="n">default_hspace</span><span class="p">,</span>
<span class="linenos" data-linenos="2033 "></span>                    <span class="n">wspace</span><span class="o">=</span><span class="n">default_wspace</span><span class="p">,</span>
<span class="linenos" data-linenos="2034 "></span>                    <span class="n">figure</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
<span class="linenos" data-linenos="2035 "></span>                <span class="p">)</span>
<span class="linenos" data-linenos="2036 "></span>                <span class="n">fig</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">figure</span>
<span class="linenos" data-linenos="2037 "></span>                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="linenos" data-linenos="2038 "></span>                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="2039 "></span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="2040 "></span>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
<span class="linenos" data-linenos="2041 "></span>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="2042 "></span>            <span class="n">gs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No GridSpec when no colorbars</span>
<span class="linenos" data-linenos="2043 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="2044 "></span>        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span> <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fig</span>
<span class="linenos" data-linenos="2045 "></span>        <span class="n">gs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No GridSpec when external ax is provided</span>
<span class="linenos" data-linenos="2046 "></span>
<span class="linenos" data-linenos="2047 "></span>    <span class="c1"># Get spatial parameters once</span>
<span class="linenos" data-linenos="2048 "></span>    <span class="n">spatial_params</span> <span class="o">=</span> <span class="n">_image_spatial_attrs</span><span class="p">(</span>
<span class="linenos" data-linenos="2049 "></span>        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="2050 "></span>        <span class="n">spatial_key</span><span class="o">=</span><span class="n">spatial_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2051 "></span>        <span class="n">library_id</span><span class="o">=</span><span class="n">library_id</span><span class="p">,</span>
<span class="linenos" data-linenos="2052 "></span>        <span class="n">library_key</span><span class="o">=</span><span class="n">library_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2053 "></span>        <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
<span class="linenos" data-linenos="2054 "></span>        <span class="n">img_res_key</span><span class="o">=</span><span class="n">img_res_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2055 "></span>        <span class="n">img_channel</span><span class="o">=</span><span class="n">img_channel</span><span class="p">,</span>
<span class="linenos" data-linenos="2056 "></span>        <span class="n">seg</span><span class="o">=</span><span class="n">seg</span><span class="p">,</span> 
<span class="linenos" data-linenos="2057 "></span>        <span class="n">seg_key</span><span class="o">=</span><span class="n">seg_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2058 "></span>        <span class="n">cell_id_key</span><span class="o">=</span><span class="n">seg_cell_id</span><span class="p">,</span>
<span class="linenos" data-linenos="2059 "></span>        <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span>
<span class="linenos" data-linenos="2060 "></span>        <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
<span class="linenos" data-linenos="2061 "></span>        <span class="n">size_key</span><span class="o">=</span><span class="n">size_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2062 "></span>        <span class="n">img_cmap</span><span class="o">=</span><span class="n">img_cmap</span><span class="p">,</span>
<span class="linenos" data-linenos="2063 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="2064 "></span>
<span class="linenos" data-linenos="2065 "></span>    <span class="c1"># Get coordinates and crops</span>
<span class="linenos" data-linenos="2066 "></span>    <span class="n">coords</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="n">_set_coords_crops</span><span class="p">(</span>
<span class="linenos" data-linenos="2067 "></span>        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="2068 "></span>        <span class="n">spatial_params</span><span class="o">=</span><span class="n">spatial_params</span><span class="p">,</span>
<span class="linenos" data-linenos="2069 "></span>        <span class="n">spatial_key</span><span class="o">=</span><span class="n">spatial_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2070 "></span>        <span class="n">crop_coord</span><span class="o">=</span><span class="n">crop_coord</span><span class="p">,</span>
<span class="linenos" data-linenos="2071 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="2072 "></span>
<span class="linenos" data-linenos="2073 "></span>    <span class="c1"># Use first library for now (could be extended for multiple libraries)</span>
<span class="linenos" data-linenos="2074 "></span>    <span class="n">_lib_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos" data-linenos="2075 "></span>    <span class="n">_size</span> <span class="o">=</span> <span class="n">spatial_params</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2076 "></span>    <span class="n">_img</span> <span class="o">=</span> <span class="n">spatial_params</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2077 "></span>    <span class="n">_seg</span> <span class="o">=</span> <span class="n">spatial_params</span><span class="o">.</span><span class="n">segment</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2078 "></span>    <span class="n">_cell_id</span> <span class="o">=</span> <span class="n">spatial_params</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2079 "></span>    <span class="n">_crops</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2080 "></span>    <span class="n">_lib</span> <span class="o">=</span> <span class="n">spatial_params</span><span class="o">.</span><span class="n">library_id</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2081 "></span>    <span class="n">_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">_lib_count</span><span class="p">]</span>
<span class="linenos" data-linenos="2082 "></span>
<span class="linenos" data-linenos="2083 "></span>    <span class="c1"># Subset data</span>
<span class="linenos" data-linenos="2084 "></span>    <span class="n">adata_sub</span><span class="p">,</span> <span class="n">coords_sub</span><span class="p">,</span> <span class="n">image_sub</span> <span class="o">=</span> <span class="n">_subs</span><span class="p">(</span>
<span class="linenos" data-linenos="2085 "></span>        <span class="n">adata</span><span class="p">,</span>
<span class="linenos" data-linenos="2086 "></span>        <span class="n">_coords</span><span class="p">,</span>
<span class="linenos" data-linenos="2087 "></span>        <span class="n">_img</span><span class="p">,</span>
<span class="linenos" data-linenos="2088 "></span>        <span class="n">library_key</span><span class="o">=</span><span class="n">library_key</span><span class="p">,</span>
<span class="linenos" data-linenos="2089 "></span>        <span class="n">library_id</span><span class="o">=</span><span class="n">_lib</span><span class="p">,</span>
<span class="linenos" data-linenos="2090 "></span>        <span class="n">crop_coords</span><span class="o">=</span><span class="n">_crops</span><span class="p">,</span>
<span class="linenos" data-linenos="2091 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="2092 "></span>
<span class="linenos" data-linenos="2093 "></span>    <span class="c1"># Store colorbar information for each gene</span>
<span class="linenos" data-linenos="2094 "></span>    <span class="n">colorbar_info</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="2095 "></span>
<span class="linenos" data-linenos="2096 "></span>    <span class="c1"># Plot each gene as an overlay</span>
<span class="linenos" data-linenos="2097 "></span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">cmaps</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
<span class="linenos" data-linenos="2098 "></span>        <span class="c1"># Get color vector for this gene</span>
<span class="linenos" data-linenos="2099 "></span>        <span class="n">color_source_vector</span><span class="p">,</span> <span class="n">color_vector</span><span class="p">,</span> <span class="n">categorical</span> <span class="o">=</span> <span class="n">_set_color_source_vec</span><span class="p">(</span>
<span class="linenos" data-linenos="2100 "></span>            <span class="n">adata_sub</span><span class="p">,</span>
<span class="linenos" data-linenos="2101 "></span>            <span class="n">gene</span><span class="p">,</span>
<span class="linenos" data-linenos="2102 "></span>            <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span>
<span class="linenos" data-linenos="2103 "></span>            <span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span><span class="p">,</span>
<span class="linenos" data-linenos="2104 "></span>            <span class="n">alt_var</span><span class="o">=</span><span class="n">alt_var</span><span class="p">,</span>
<span class="linenos" data-linenos="2105 "></span>            <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
<span class="linenos" data-linenos="2106 "></span>            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
<span class="linenos" data-linenos="2107 "></span>            <span class="n">na_color</span><span class="o">=</span><span class="n">na_color</span><span class="p">,</span>
<span class="linenos" data-linenos="2108 "></span>            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
<span class="linenos" data-linenos="2109 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="2110 "></span>
<span class="linenos" data-linenos="2111 "></span>        <span class="k">if</span> <span class="n">_seg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_cell_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2112 "></span>            <span class="c1"># Create colormap parameters</span>
<span class="linenos" data-linenos="2113 "></span>            <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="linenos" data-linenos="2114 "></span>            <span class="n">norm_to_use</span> <span class="o">=</span> <span class="n">norm</span> <span class="ow">or</span> <span class="n">Normalize</span><span class="p">()</span>
<span class="linenos" data-linenos="2115 "></span>
<span class="linenos" data-linenos="2116 "></span>            <span class="c1"># Fix normalization if needed</span>
<span class="linenos" data-linenos="2117 "></span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">categorical</span> <span class="ow">and</span> <span class="p">(</span><span class="n">norm_to_use</span><span class="o">.</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">norm_to_use</span><span class="o">.</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos" data-linenos="2118 "></span>                <span class="n">valid_values</span> <span class="o">=</span> <span class="n">color_vector</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">color_vector</span><span class="p">)]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">color_vector</span><span class="p">,</span> <span class="s1">'isna'</span><span class="p">)</span> <span class="k">else</span> <span class="n">color_vector</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">color_vector</span><span class="p">)]</span>
<span class="linenos" data-linenos="2119 "></span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="2120 "></span>                    <span class="n">norm_to_use</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span>
<span class="linenos" data-linenos="2121 "></span>                    <span class="n">norm_to_use</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span>
<span class="linenos" data-linenos="2122 "></span>
<span class="linenos" data-linenos="2123 "></span>            <span class="n">cmap_params</span> <span class="o">=</span> <span class="n">CmapParams</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">img_cmap</span><span class="p">,</span> <span class="n">norm_to_use</span><span class="p">)</span>
<span class="linenos" data-linenos="2124 "></span>            <span class="n">color_params</span> <span class="o">=</span> <span class="n">ColorParams</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">gene</span><span class="p">],</span> <span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">img_alpha</span> <span class="ow">or</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">use_raw</span> <span class="ow">or</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="2125 "></span>
<span class="linenos" data-linenos="2126 "></span>            <span class="c1"># Store colorbar information</span>
<span class="linenos" data-linenos="2127 "></span>            <span class="k">if</span> <span class="n">colorbar</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">categorical</span><span class="p">:</span>
<span class="linenos" data-linenos="2128 "></span>                <span class="n">colorbar_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos" data-linenos="2129 "></span>                    <span class="s1">'gene'</span><span class="p">:</span> <span class="n">gene</span><span class="p">,</span>
<span class="linenos" data-linenos="2130 "></span>                    <span class="s1">'cmap'</span><span class="p">:</span> <span class="n">cmap</span><span class="p">,</span>
<span class="linenos" data-linenos="2131 "></span>                    <span class="s1">'norm'</span><span class="p">:</span> <span class="n">norm_to_use</span><span class="p">,</span>
<span class="linenos" data-linenos="2132 "></span>                    <span class="s1">'values'</span><span class="p">:</span> <span class="n">color_vector</span>
<span class="linenos" data-linenos="2133 "></span>                <span class="p">})</span>
<span class="linenos" data-linenos="2134 "></span>
<span class="linenos" data-linenos="2135 "></span>            <span class="c1"># Plot this gene's segmentation</span>
<span class="linenos" data-linenos="2136 "></span>            <span class="n">ax</span><span class="p">,</span> <span class="n">cax</span> <span class="o">=</span> <span class="n">_plot_segment</span><span class="p">(</span>
<span class="linenos" data-linenos="2137 "></span>                <span class="n">seg</span><span class="o">=</span><span class="n">_seg</span><span class="p">,</span>
<span class="linenos" data-linenos="2138 "></span>                <span class="n">cell_id</span><span class="o">=</span><span class="n">_cell_id</span><span class="p">,</span>
<span class="linenos" data-linenos="2139 "></span>                <span class="n">color_vector</span><span class="o">=</span><span class="n">color_vector</span><span class="p">,</span>
<span class="linenos" data-linenos="2140 "></span>                <span class="n">color_source_vector</span><span class="o">=</span><span class="n">color_source_vector</span><span class="p">,</span>
<span class="linenos" data-linenos="2141 "></span>                <span class="n">seg_contourpx</span><span class="o">=</span><span class="n">seg_contourpx</span><span class="p">,</span>
<span class="linenos" data-linenos="2142 "></span>                <span class="n">seg_outline</span><span class="o">=</span><span class="n">seg_outline</span><span class="p">,</span>
<span class="linenos" data-linenos="2143 "></span>                <span class="n">na_color</span><span class="o">=</span><span class="n">na_color</span><span class="p">,</span>
<span class="linenos" data-linenos="2144 "></span>                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="linenos" data-linenos="2145 "></span>                <span class="n">cmap_params</span><span class="o">=</span><span class="n">cmap_params</span><span class="p">,</span>
<span class="linenos" data-linenos="2146 "></span>                <span class="n">color_params</span><span class="o">=</span><span class="n">color_params</span><span class="p">,</span>
<span class="linenos" data-linenos="2147 "></span>                <span class="n">categorical</span><span class="o">=</span><span class="n">categorical</span><span class="p">,</span>
<span class="linenos" data-linenos="2148 "></span>                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos" data-linenos="2149 "></span>            <span class="p">)</span>
<span class="linenos" data-linenos="2150 "></span>
<span class="linenos" data-linenos="2151 "></span>    <span class="c1"># Handle axis decoration manually (essential parts from _decorate_axs)</span>
<span class="linenos" data-linenos="2152 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="2153 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="linenos" data-linenos="2154 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">()</span>  <span class="c1"># needed when plotting points but no image</span>
<span class="linenos" data-linenos="2155 "></span>
<span class="linenos" data-linenos="2156 "></span>    <span class="c1"># Handle image display and axis orientation (core logic from _decorate_axs)</span>
<span class="linenos" data-linenos="2157 "></span>    <span class="k">if</span> <span class="n">image_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2158 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_sub</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">img_cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">img_alpha</span><span class="p">)</span>
<span class="linenos" data-linenos="2159 "></span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="2160 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"equal"</span><span class="p">)</span>
<span class="linenos" data-linenos="2161 "></span>        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="linenos" data-linenos="2162 "></span>
<span class="linenos" data-linenos="2163 "></span>    <span class="c1"># Set title</span>
<span class="linenos" data-linenos="2164 "></span>    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2165 "></span>        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Overlay: </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="linenos" data-linenos="2166 "></span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="linenos" data-linenos="2167 "></span>
<span class="linenos" data-linenos="2168 "></span>    <span class="c1"># Add colorbars</span>
<span class="linenos" data-linenos="2169 "></span>    <span class="k">if</span> <span class="n">colorbar</span> <span class="ow">and</span> <span class="n">colorbar_position</span> <span class="o">!=</span> <span class="s2">"none"</span> <span class="ow">and</span> <span class="n">colorbar_info</span><span class="p">:</span>
<span class="linenos" data-linenos="2170 "></span>        <span class="c1"># Create colorbar axes</span>
<span class="linenos" data-linenos="2171 "></span>        <span class="n">cbar_axes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="2172 "></span>        <span class="n">n_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colorbar_info</span><span class="p">)</span>
<span class="linenos" data-linenos="2173 "></span>
<span class="linenos" data-linenos="2174 "></span>        <span class="k">if</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"bottom"</span><span class="p">:</span>
<span class="linenos" data-linenos="2175 "></span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="linenos" data-linenos="2176 "></span>                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<span class="linenos" data-linenos="2177 "></span>                    <span class="n">idx</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">col</span>
<span class="linenos" data-linenos="2178 "></span>                    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n_genes</span><span class="p">:</span>
<span class="linenos" data-linenos="2179 "></span>                        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos" data-linenos="2180 "></span>                        <span class="n">cbar_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbar_ax</span><span class="p">)</span>
<span class="linenos" data-linenos="2181 "></span>        <span class="k">elif</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"right"</span><span class="p">:</span>
<span class="linenos" data-linenos="2182 "></span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">colorbar_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_genes</span><span class="p">)):</span>
<span class="linenos" data-linenos="2183 "></span>                <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos" data-linenos="2184 "></span>                <span class="n">cbar_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbar_ax</span><span class="p">)</span>
<span class="linenos" data-linenos="2185 "></span>
<span class="linenos" data-linenos="2186 "></span>        <span class="c1"># Create colorbars</span>
<span class="linenos" data-linenos="2187 "></span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cbar_info</span><span class="p">,</span> <span class="n">cbar_ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">colorbar_info</span><span class="p">,</span> <span class="n">cbar_axes</span><span class="p">)):</span>
<span class="linenos" data-linenos="2188 "></span>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbar_axes</span><span class="p">):</span>
<span class="linenos" data-linenos="2189 "></span>                <span class="c1"># Calculate ticks</span>
<span class="linenos" data-linenos="2190 "></span>                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cbar_info</span><span class="p">[</span><span class="s1">'norm'</span><span class="p">]</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">cbar_info</span><span class="p">[</span><span class="s1">'norm'</span><span class="p">]</span><span class="o">.</span><span class="n">vmax</span>
<span class="linenos" data-linenos="2191 "></span>                <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2192 "></span>                    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vmin</span><span class="p">,</span> <span class="p">(</span><span class="n">vmin</span> <span class="o">+</span> <span class="n">vmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="p">]</span>
<span class="linenos" data-linenos="2193 "></span>                    <span class="k">if</span> <span class="n">vmax</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos" data-linenos="2194 "></span>                        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="linenos" data-linenos="2195 "></span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="2196 "></span>                        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="linenos" data-linenos="2197 "></span>
<span class="linenos" data-linenos="2198 "></span>                    <span class="c1"># Create colorbar</span>
<span class="linenos" data-linenos="2199 "></span>                    <span class="n">orientation</span> <span class="o">=</span> <span class="s2">"horizontal"</span> <span class="k">if</span> <span class="n">colorbar_position</span> <span class="o">==</span> <span class="s2">"bottom"</span> <span class="k">else</span> <span class="s2">"vertical"</span>
<span class="linenos" data-linenos="2200 "></span>                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
<span class="linenos" data-linenos="2201 "></span>                        <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">cbar_info</span><span class="p">[</span><span class="s1">'norm'</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cbar_info</span><span class="p">[</span><span class="s1">'cmap'</span><span class="p">]),</span>
<span class="linenos" data-linenos="2202 "></span>                        <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span>
<span class="linenos" data-linenos="2203 "></span>                        <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
<span class="linenos" data-linenos="2204 "></span>                        <span class="n">extend</span><span class="o">=</span><span class="s2">"both"</span><span class="p">,</span>
<span class="linenos" data-linenos="2205 "></span>                        <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span>
<span class="linenos" data-linenos="2206 "></span>                    <span class="p">)</span>
<span class="linenos" data-linenos="2207 "></span>
<span class="linenos" data-linenos="2208 "></span>                    <span class="c1"># Style colorbar</span>
<span class="linenos" data-linenos="2209 "></span>                    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">colorbar_tick_size</span><span class="p">)</span>
<span class="linenos" data-linenos="2210 "></span>                    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cbar_info</span><span class="p">[</span><span class="s1">'gene'</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">colorbar_title_size</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos" data-linenos="2211 "></span>
<span class="linenos" data-linenos="2212 "></span>    <span class="c1"># Add scalebar if specified</span>
<span class="linenos" data-linenos="2213 "></span>    <span class="k">if</span> <span class="n">scalebar_dx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2214 "></span>        <span class="kn">from</span> <span class="nn">matplotlib_scalebar.scalebar</span> <span class="kn">import</span> <span class="n">ScaleBar</span>
<span class="linenos" data-linenos="2215 "></span>        <span class="n">scalebar_dx</span><span class="p">,</span> <span class="n">scalebar_units</span> <span class="o">=</span> <span class="n">_get_scalebar</span><span class="p">(</span><span class="n">scalebar_dx</span><span class="p">,</span> <span class="n">scalebar_units</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="2216 "></span>        <span class="k">if</span> <span class="n">scalebar_dx</span> <span class="ow">and</span> <span class="n">scalebar_units</span><span class="p">:</span>
<span class="linenos" data-linenos="2217 "></span>            <span class="n">scalebar</span> <span class="o">=</span> <span class="n">ScaleBar</span><span class="p">(</span><span class="n">scalebar_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">scalebar_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">scalebar_kwargs</span><span class="p">)</span>
<span class="linenos" data-linenos="2218 "></span>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">scalebar</span><span class="p">)</span>
<span class="linenos" data-linenos="2219 "></span>
<span class="linenos" data-linenos="2220 "></span>    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos" data-linenos="2221 "></span>        <span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
<span class="linenos" data-linenos="2222 "></span>
<span class="linenos" data-linenos="2223 "></span>    <span class="k">if</span> <span class="n">return_ax</span><span class="p">:</span>
<span class="linenos" data-linenos="2224 "></span>        <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
</details>
</div>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2019-2025, 112 Lab, USTB
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.fc8c2696.min.js"></script>
<script src="../../../javascripts/config.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>