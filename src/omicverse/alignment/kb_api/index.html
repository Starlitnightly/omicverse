
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Zehua Zeng" name="author"/>
<link href="../../../../img/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.1.2" name="generator"/>
<title>omicverse.alignment.kb_api - omicverse Readthedocs</title>
<link href="../../../../assets/stylesheets/main.7bf56d0a.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../../css/mkapi-common.css" rel="stylesheet"/>
<link href="../../../../css/mkapi-material.css" rel="stylesheet"/>
<link href="../../../../css/tags.css" rel="stylesheet"/>
<link href="../../../../css/custom.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#omicverse.alignment.kb_api">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="omicverse Readthedocs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="omicverse Readthedocs">
<img alt="logo" src="../../../../img/ico.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            omicverse Readthedocs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              omicverse.alignment.kb_api
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/Starlitnightly/omicverse" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="omicverse Readthedocs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="omicverse Readthedocs">
<img alt="logo" src="../../../../img/ico.png"/>
</a>
    omicverse Readthedocs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/Starlitnightly/omicverse" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
        Index
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Installation_guild/">
        Installation
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          Bulk
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_1">
<span class="md-nav__icon md-icon"></span>
          Bulk
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
          Preprocessing
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_1">
<span class="md-nav__icon md-icon"></span>
          Preprocessing
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_bulk_combat/">
        Batch correction in Bulk RNA-seq or microarray data
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_2" id="__nav_3_1_2_label" tabindex="0">
          Downstream
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_2">
<span class="md-nav__icon md-icon"></span>
          Downstream
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_deg/">
        Different Expression Analysis
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_deseq2/">
        Different Expression Analysis with DEseq2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_network/">
        Protein-Protein interaction (PPI) analysis by String-db
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_wgcna/">
        WGCNA (Weighted gene co-expression network analysis) analysis
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
          Deconvolution
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_3">
<span class="md-nav__icon md-icon"></span>
          Deconvolution
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_decov_bulk/">
        Bulk deconvolution with reference scRNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
          Others
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_4">
<span class="md-nav__icon md-icon"></span>
          Others
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk/t_tcga/">
        TCGA database preprocess
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Single
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
          Single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
          Alignment
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_1">
<span class="md-nav__icon md-icon"></span>
          Alignment
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_alignment_1k/">
        Alignment and analysis of single-cell RNA-seq data
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_alignment_velocity/">
        Alignment and RNA velocity analysis of single-cell RNA-seq data.
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
          Preprocessing
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_2">
<span class="md-nav__icon md-icon"></span>
          Preprocessing
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_preprocess_cpu/">
        Preprocessing the data of scRNA-seq with omicverse[CPU-GPU-mixed]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_preprocess_gpu/">
        Preprocessing the data of scRNA-seq with omicverse[GPU]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cluster/">
        Clustering space
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_single_batch/">
        Data integration and batch correction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cnmf/">
        GeneModule Identified
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_lazy/">
        Lazy analysis of scRNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_3" id="__nav_3_2_3_label" tabindex="0">
          Annotation
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_3">
<span class="md-nav__icon md-icon"></span>
          Annotation
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_anno_noref/">
        Reference-free automated single-cell cell type annotation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_anno_ref/">
        Reference automated single-cell cell type annotation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_gptanno/">
        Automatic cell type annotation with GPT/Other
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellmatch/">
        Mapping Cell Names to the Cell Ontology/Taxonomy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellanno/">
        Celltype auto annotation with SCSA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_metatime/">
        Celltype auto annotation with MetaTiME
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_tosica/">
        Celltype annotation migration(mapping) with TOSICA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_scmulan/">
        Celltype auto annotation with scMulan
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellvote/">
        Consensus annotation with CellVote
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_4" id="__nav_3_2_4_label" tabindex="0">
          Trajectory
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_4">
<span class="md-nav__icon md-icon"></span>
          Trajectory
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cytotrace/">
        Prediction of absolute developmental potential using CytoTrace2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_traj/">
        Basic Trajectory Inference
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_stavia/">
        Trajectory Inference with StaVIA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellfate_gene/">
        Timing-associated genes analysis with TimeFateKernel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellfate/">
        Identify the driver regulators of cell fate decisions
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_5" id="__nav_3_2_5_label" tabindex="0">
          Cell Structure
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_5_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_5">
<span class="md-nav__icon md-icon"></span>
          Cell Structure
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_metacells/">
        Inference of MetaCell from Single-Cell RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_deg_single/">
        Differential expression and celltype analysis [All Cell]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_scdeg/">
        Differential expression analysis [Meta Cell]
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_scenic/">
        Gene Regulatory Network Analysis with SCENIC
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_aucell/">
        Pathway analysis with AUCell
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_cellphonedb/">
        Cell-cell communication using CellPhoneDBViz
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_scdrug/">
        Drug response predict with scDrug
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_simba/">
        Data integration and batch correction with SIMBA
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_6" id="__nav_3_2_6_label" tabindex="0">
          Velocity
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_6_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_6">
<span class="md-nav__icon md-icon"></span>
          Velocity
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-velo/t_velo/">
        Velocity Basic Calculation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-velo/t_graphvelo/">
        Velocity Optimization
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_7" id="__nav_3_2_7_label" tabindex="0">
          Multi omics
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_7_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_7">
<span class="md-nav__icon md-icon"></span>
          Multi omics
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_mofa/">
        Multi omics analysis by MOFA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_mofa_glue/">
        Multi omics analysis by MOFA and GLUE
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-single/t_anno_trans/">
        Celltype annotation transfer in multi-omics
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          Bulk2Single
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
          Bulk2Single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk2single/t_bulktrajblend/">
        Bulk RNA-seq generate 'interrupted' cells to interpolate scRNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk2single/t_bulk2single/">
        Bulk RNA-seq to Single RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-bulk2single/t_single2spatial/">
        Single RNA-seq to Spatial RNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          Space
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
          Space
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_1" id="__nav_3_4_1_label" tabindex="0">
          Preprocess
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_1">
<span class="md-nav__icon md-icon"></span>
          Preprocess
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_crop_rotate/">
        Crop and Rotation of spatial transcriptomic data
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_cellpose/">
        Cell Segmemtation (10x HD)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_cluster_space/">
        Spatial clustering and denoising expressions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_staligner/">
        Spatial integration and clustering
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
          Deconvolution
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_2">
<span class="md-nav__icon md-icon"></span>
          Deconvolution
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_spaceflow/">
        Identifying Pseudo-Spatial Map
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_decov/">
        Spatial deconvolution with reference scRNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_flashdeconv/">
        FlashDeconv: Fast Spatial Deconvolution via Structure-Preserving Sketching
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_starfysh_new/">
        Spatial deconvolution without reference scRNA-seq
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
          Downstream
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_3">
<span class="md-nav__icon md-icon"></span>
          Downstream
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_stt/">
        Spatial transition tensor of single cells
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_commot_flowsig/">
        Spatial Communication
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_gaston/">
        Spatial IsoDepth Calculation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-space/t_slat/">
        Single cell spatial alignment tools
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
          LLM
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
          LLM
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_dr/">
        Domain Research (dr): Comprehensive Report Tutorial
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_dr_web/">
        Domain Research (dr) — Live Web
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_ov_agent_pbmc3k/">
        ov.Agent with Skills: Natural‑Language Single‑Cell Analysis (PBMC3k)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_uce/">
        UCE
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_scgpt/">
        scGPT
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_scfoundation/">
        scFoundation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_geneformer/">
        GeneFormer
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-llm/t_cellplm/">
        CellPLM
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Plotting
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
          Plotting
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-plotting/t_visualize_single/">
        Visualization of single cell RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-plotting/t_visualize_bulk/">
        Visualization of Bulk RNA-seq
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Tutorials-plotting/t_visualize_colorsystem/">
        Color system
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../GPU_supported_registry_functions/">
        GPU Support
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/">API documentation</a>
<label for="__nav_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          API documentation
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/agent/">agent</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
          agent
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/alignment/">alignment</a>
<label for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
          alignment
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../api/omicverse/alignment/kb_api/">
        kb_api
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/bulk/">bulk</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_4">
<span class="md-nav__icon md-icon"></span>
          bulk
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/bulk2single/">bulk2single</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_5">
<span class="md-nav__icon md-icon"></span>
          bulk2single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_6" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/datasets/">datasets</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_6">
<span class="md-nav__icon md-icon"></span>
          datasets
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_7" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/pl/">pl</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_7">
<span class="md-nav__icon md-icon"></span>
          pl
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_8" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/pp/">pp</a>
<label for="__nav_5_8">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_8">
<span class="md-nav__icon md-icon"></span>
          pp
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_8_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/pp/experimental/">experimental</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_8_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_8_2">
<span class="md-nav__icon md-icon"></span>
          experimental
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../api/omicverse/pp/pyg_knn_implementation/">
        pyg_knn_implementation
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_9" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/single/">single</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_9">
<span class="md-nav__icon md-icon"></span>
          single
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_10" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/space/">space</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_10_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_10">
<span class="md-nav__icon md-icon"></span>
          space
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_11" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../../api/omicverse/utils/">utils</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_11_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_11">
<span class="md-nav__icon md-icon"></span>
          utils
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Release_notes/">
        Release notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../Developer_guild/">
        Developer guild
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.alignment.kb_api.Colors">
    Colors
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.alignment.kb_api.ref">
    ref
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.alignment.kb_api.count">
    count
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omicverse.alignment.kb_api.analyze_10x_v3_data">
    analyze_10x_v3_data
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 style="display: none;">omicverse.alignment.kb_api<a class="headerlink" href="#omicverse.alignment.kb_api" title="Permanent link">¶</a></h1><p class="mkapi-object mkapi-page-object" id="omicverse.alignment.kb_api">
<span class="mkapi-object-link">
<a href="../../../../api/omicverse/alignment/kb_api/#omicverse.alignment.kb_api" title="Go to docs">[docs]</a>
<span class="mkapi-document-toggle" title="Toggle all docs">
<i class="fa-regular fa-square-minus"></i>
</span>
</span><span class="mkapi-object-kind">module</span>
<span class="mkapi-object-name"><a href="./#omicverse.alignment.kb_api" title="omicverse.alignment.kb_api">omicverse.alignment.kb_api</a></span>
</p>
<div class="mkapi-source no-copy highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">CLI Interface Wrapper - Run kb-python via command-line with a function-style API</span>

<span class="sd">This module provides a Python interface that wraps the `kb` command line tool</span>
<span class="sd">(kb-python), so you can call kb workflows from Python without importing</span>
<span class="sd">kb_python internals.</span>

<span class="sd">Author: Claude Code</span>
<span class="sd">Created: 2025</span>
<span class="sd">"""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Colors</span><span class="p">:</span><div class="mkapi-source-link" id="omicverse.alignment.kb_api.Colors"><a href="../../../../api/omicverse/alignment/kb_api/#omicverse.alignment.kb_api.Colors" title="Go to docs">[docs]</a></div>
<span class="w">    </span><span class="sd">"""ANSI color codes for terminal output styling."""</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[95m'</span>    <span class="c1"># Purple</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[94m'</span>      <span class="c1"># Blue</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[96m'</span>      <span class="c1"># Cyan</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[92m'</span>     <span class="c1"># Green</span>
    <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[93m'</span>   <span class="c1"># Yellow</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[91m'</span>      <span class="c1"># Red</span>
    <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[0m'</span>       <span class="c1"># Reset</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[1m'</span>       <span class="c1"># Bold</span>
    <span class="n">UNDERLINE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[4m'</span>  <span class="c1"># Underline</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_which_kb</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Resolve the 'kb' executable.</span>

<span class="sd">    Priority:</span>
<span class="sd">    1) Return the 'kb' executable found on the PATH.</span>
<span class="sd">    2) If not found, try to find an executable named 'kb' in the same directory</span>
<span class="sd">       as the current Python interpreter (this covers venv/conda installs).</span>
<span class="sd">    3) If still not found, fall back to invoking a module with the current Python:</span>
<span class="sd">       prefer `python -m kb` if the 'kb' module is importable, otherwise try</span>
<span class="sd">       `python -m kb_python` if that module is importable.</span>
<span class="sd">    If none of the above are available, raise FileNotFoundError.</span>
<span class="sd">    """</span>
    <span class="c1"># 1) Look for 'kb' on PATH first</span>
    <span class="n">kb</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">'kb'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kb</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kb</span>

    <span class="c1"># 2) Try to find a 'kb' executable next to the current Python executable</span>
    <span class="c1">#    (handles cases where the console script is installed into the env's bin/)</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">:</span>
        <span class="n">exe_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'kb'</span><span class="p">,</span> <span class="s1">'kb.exe'</span><span class="p">):</span>
            <span class="n">cand_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exe_dir</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cand_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">cand_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cand_path</span>

    <span class="c1"># 3) Fall back to using `python -m &lt;module&gt;` but only if the module exists.</span>
    <span class="n">python_exe</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span> <span class="ow">or</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">'python3'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">'python'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_exe</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Prefer the 'kb' module (if present) so we run `python -m kb`</span>
            <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">'kb'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">python_exe</span><span class="si">}</span><span class="s1"> -m kb'</span>
            <span class="c1"># Otherwise, try the legacy/alternate 'kb_python' package</span>
            <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">'kb_python'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">python_exe</span><span class="si">}</span><span class="s1"> -m kb_python'</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If importlib checks fail unexpectedly, fall through to the final error.</span>
            <span class="k">pass</span>

    <span class="c1"># Nothing found — raise a helpful error</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="s2">"Could not find the 'kb' executable on PATH or next to the current Python interpreter, "</span>
        <span class="s2">"and neither 'kb' nor 'kb_python' modules are importable for `python -m` invocation. "</span>
        <span class="s2">"Please ensure kb-python is installed in the active environment (e.g. activate your conda/venv), "</span>
        <span class="s2">"or provide the absolute path to the 'kb' executable."</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_run_kb</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Run a kb command, streaming output to the console. Raises on non-zero exit.</span>
<span class="sd">    """</span>
    <span class="c1"># If _which_kb returned "python -m kb_python", split it</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">' '</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cmd</span><span class="p">)</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"kb command failed with exit code </span><span class="si">{</span><span class="n">ret</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span> <span class="n">as_bool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Utility to add flags to the CLI command.</span>
<span class="sd">    - as_bool: if True, interpret value as boolean; add flag if True (no value)</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">as_bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">flag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_normalize_list_arg</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">','</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_include_exclude_to_flags</span><span class="p">(</span><span class="n">include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
                              <span class="n">exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Convert include/exclude attribute dicts to CLI flags.</span>
<span class="sd">    Each item should be like {"attribute": "key", "pattern": "value"} or {"key": "...", "value": "..."}.</span>
<span class="sd">    Produces repeated flags:</span>
<span class="sd">      --include-attribute key:pattern</span>
<span class="sd">      --exclude-attribute key:pattern</span>
<span class="sd">    """</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'attribute'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">)</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'pattern'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">pat</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--include-attribute'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">pat</span><span class="si">}</span><span class="s1">'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'attribute'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">)</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'pattern'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">pat</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--exclude-attribute'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">pat</span><span class="si">}</span><span class="s1">'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ref</span><span class="p">(</span><div class="mkapi-source-link" id="omicverse.alignment.kb_api.ref"><a href="../../../../api/omicverse/alignment/kb_api/#omicverse.alignment.kb_api.ref" title="Go to docs">[docs]</a></div>
    <span class="n">index_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t2g_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fasta_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gtf_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cdna_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'standard'</span><span class="p">,</span>
    <span class="n">d</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">temp_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'tmp'</span><span class="p">,</span>
    <span class="n">make_unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dlist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dlist_overhang</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">aa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_ec_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nucleus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># NAC/velocity workflow specific</span>
    <span class="n">f2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">flank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># KITE workflow specific</span>
    <span class="n">feature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_mismatches</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Custom workflow specific</span>
    <span class="n">distinguish</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Build kallisto index and transcript-to-gene mapping via `kb ref`.</span>
<span class="sd">    Returns a dict with metadata and common output paths.</span>
<span class="sd">    """</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s2">🚀 Starting ref workflow: </span><span class="si">{</span><span class="n">workflow</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># If user sets nucleus=True but workflow left default, switch workflow accordingly</span>
    <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s1">'standard'</span> <span class="ow">and</span> <span class="n">nucleus</span><span class="p">:</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="s1">'nucleus'</span>

    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'.'</span><span class="p">)</span>
    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">t2g_path</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'.'</span><span class="p">)</span>

    <span class="n">kb</span> <span class="o">=</span> <span class="n">_which_kb</span><span class="p">()</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="s1">'ref'</span><span class="p">]</span>

    <span class="c1"># Workflow</span>
    <span class="k">if</span> <span class="n">workflow</span> <span class="ow">and</span> <span class="n">workflow</span> <span class="o">!=</span> <span class="s1">'standard'</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--workflow'</span><span class="p">,</span> <span class="n">workflow</span><span class="p">])</span>

    <span class="c1"># Choose a unique tmp dir and pass via --tmp (do NOT pre-create)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_dir</span> <span class="ow">or</span> <span class="n">temp_dir</span> <span class="o">==</span> <span class="s1">'tmp'</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
        <span class="n">run_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"tmp-kb-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_tmp</span> <span class="o">=</span> <span class="n">temp_dir</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">    Using temporary directory: </span><span class="si">{</span><span class="n">run_tmp</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--tmp'</span><span class="p">,</span> <span class="n">run_tmp</span><span class="p">])</span>

    <span class="c1"># Common required outputs</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-i'</span><span class="p">,</span> <span class="n">index_path</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-g'</span><span class="p">,</span> <span class="n">t2g_path</span><span class="p">)</span>

    <span class="c1"># Options common to most workflows</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-k'</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-t'</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--overwrite'</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--make-unique'</span><span class="p">,</span> <span class="n">make_unique</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--no-mismatches'</span><span class="p">,</span> <span class="n">no_mismatches</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--aa'</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--flank'</span><span class="p">,</span> <span class="n">flank</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--d-list'</span><span class="p">,</span> <span class="n">dlist</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--d-list-overhang'</span><span class="p">,</span> <span class="n">dlist_overhang</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--ec-max-size'</span><span class="p">,</span> <span class="n">max_ec_size</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--distinguish'</span><span class="p">,</span> <span class="n">distinguish</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Include/Exclude attributes</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_include_exclude_to_flags</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">))</span>

    <span class="c1"># Pass-through optional flags for binary paths and optimizations</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'kallisto'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--kallisto'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'kallisto'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'bustools'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--bustools'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'bustools'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'opt_off'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--opt-off'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Build positional / workflow-specific arguments</span>
    <span class="n">positional</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">    Using pre-built reference: </span><span class="si">{</span><span class="n">d</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'-d'</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f1'</span><span class="p">,</span> <span class="n">cdna_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f2</span><span class="p">:</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f2'</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c1</span><span class="p">:</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c1'</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c2'</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fasta_joined</span> <span class="o">=</span> <span class="n">_normalize_list_arg</span><span class="p">(</span><span class="n">fasta_paths</span><span class="p">,</span> <span class="s1">','</span><span class="p">)</span>
        <span class="n">gtf_joined</span> <span class="o">=</span> <span class="n">_normalize_list_arg</span><span class="p">(</span><span class="n">gtf_paths</span><span class="p">,</span> <span class="s1">','</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s1">'kite'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f1'</span><span class="p">,</span> <span class="n">cdna_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'lamanno'</span><span class="p">,</span> <span class="s1">'nucleus'</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f1'</span><span class="p">,</span> <span class="n">cdna_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f2</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f2'</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c1'</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c2'</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fasta_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fasta_joined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gtf_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gtf_joined</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s1">'nac'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f1'</span><span class="p">,</span> <span class="n">cdna_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f2</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f2'</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c1'</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c2'</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fasta_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fasta_joined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gtf_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gtf_joined</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s1">'custom'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fasta_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fasta_joined</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fasta_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fasta_joined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gtf_joined</span><span class="p">:</span>
                <span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gtf_joined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
                <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-f1'</span><span class="p">,</span> <span class="n">cdna_path</span><span class="p">)</span>

    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">positional</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># 可选：env['TMPDIR'] = run_tmp</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_run_kb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✓ ref workflow completed!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">FAIL</span><span class="si">}</span><span class="s2">✗ ref workflow failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Best-effort cleanup if we created a unique tmp path</span>
        <span class="k">if</span> <span class="n">run_tmp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'tmp-kb-'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">run_tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">run_tmp</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'workflow'</span><span class="p">:</span> <span class="n">workflow</span><span class="p">,</span>
        <span class="s1">'technology'</span><span class="p">:</span> <span class="s1">'N/A'</span><span class="p">,</span>
        <span class="s1">'parameters'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'threads'</span><span class="p">:</span> <span class="n">threads</span><span class="p">,</span>
            <span class="s1">'k'</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s1">'overwrite'</span><span class="p">:</span> <span class="n">overwrite</span><span class="p">,</span>
            <span class="s1">'workflow_type'</span><span class="p">:</span> <span class="n">workflow</span>
        <span class="p">},</span>
        <span class="s1">'index_path'</span><span class="p">:</span> <span class="n">index_path</span><span class="p">,</span>
        <span class="s1">'t2g_path'</span><span class="p">:</span> <span class="n">t2g_path</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">cdna_path</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">'cdna_path'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdna_path</span>
    <span class="k">return</span> <span class="n">result</span>  <span class="c1"># type: ignore[return-value]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><div class="mkapi-source-link" id="omicverse.alignment.kb_api.count"><a href="../../../../api/omicverse/alignment/kb_api/#omicverse.alignment.kb_api.count" title="Go to docs">[docs]</a></div>
    <span class="n">index_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t2g_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">technology</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fastq_paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'.'</span><span class="p">,</span>
    <span class="n">whitelist_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">replacement_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">memory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'2G'</span><span class="p">,</span>
    <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'standard'</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">temp_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'tmp'</span><span class="p">,</span>
    <span class="c1"># Matrix options</span>
    <span class="n">tcc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">filter_barcodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">filter_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Output formats</span>
    <span class="n">loom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">loom_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">h5ad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cellranger</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">gene_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Technology-specific parameters</span>
    <span class="n">strand</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fragment_l</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fragment_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bootstraps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Advanced options</span>
    <span class="n">em</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">aa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">genomebam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">inleaved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">batch_barcodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exact_barcodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">numreads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">store_num</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Long-read options</span>
    <span class="n">long_read</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'ONT'</span><span class="p">,</span>
    <span class="c1"># NAC/lamanno workflow specific</span>
    <span class="n">c1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nucleus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Other parameters</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Generate count matrix from single-cell FASTQ files via `kb count`.</span>
<span class="sd">    Returns a dict with metadata and commonly generated output files if present.</span>
<span class="sd">    """</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s2">🚀 Starting count workflow: </span><span class="si">{</span><span class="n">workflow</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">    Technology: </span><span class="si">{</span><span class="n">technology</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">CYAN</span><span class="si">}</span><span class="s2">    Output directory: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># validate tcc/mm</span>
    <span class="k">if</span> <span class="n">tcc</span> <span class="ow">and</span> <span class="n">mm</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">! Both tcc and mm were set; kb CLI treats them as mutually exclusive. Preferring --tcc.</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="c1"># Switch to nucleus workflow if requested</span>
    <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s1">'standard'</span> <span class="ow">and</span> <span class="n">nucleus</span><span class="p">:</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="s1">'nucleus'</span>

    <span class="n">kb</span> <span class="o">=</span> <span class="n">_which_kb</span><span class="p">()</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="s1">'count'</span><span class="p">]</span>

    <span class="c1"># Workflow</span>
    <span class="k">if</span> <span class="n">workflow</span> <span class="ow">and</span> <span class="n">workflow</span> <span class="o">!=</span> <span class="s1">'standard'</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--workflow'</span><span class="p">,</span> <span class="n">workflow</span><span class="p">])</span>

    <span class="c1"># Choose a unique tmp dir and pass via --tmp (do NOT pre-create)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_dir</span> <span class="ow">or</span> <span class="n">temp_dir</span> <span class="o">==</span> <span class="s1">'tmp'</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
        <span class="n">run_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"tmp-kb-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_tmp</span> <span class="o">=</span> <span class="n">temp_dir</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">    Using temporary directory: </span><span class="si">{</span><span class="n">run_tmp</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--tmp'</span><span class="p">,</span> <span class="n">run_tmp</span><span class="p">])</span>

    <span class="c1"># Required basic args</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-i'</span><span class="p">,</span> <span class="n">index_path</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-g'</span><span class="p">,</span> <span class="n">t2g_path</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-x'</span><span class="p">,</span> <span class="n">technology</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-o'</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>

    <span class="c1"># c1/c2 (velocity-type workflows)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c1'</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c2'</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="c1"># Optional core args</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-t'</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-m'</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--overwrite'</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Filtering</span>
    <span class="k">if</span> <span class="n">filter_barcodes</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'--filter'</span><span class="p">,</span> <span class="s1">'bustools'</span><span class="p">])</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--filter-threshold'</span><span class="p">,</span> <span class="n">filter_threshold</span><span class="p">)</span>

    <span class="c1"># Matrix mode</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--tcc'</span><span class="p">,</span> <span class="n">tcc</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tcc</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--mm'</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Output format flags</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--loom'</span><span class="p">,</span> <span class="n">loom</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loom_names</span><span class="p">:</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">loom_names</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loom_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loom_names</span><span class="p">)</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--loom-names'</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--h5ad'</span><span class="p">,</span> <span class="n">h5ad</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--cellranger'</span><span class="p">,</span> <span class="n">cellranger</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--gene-names'</span><span class="p">,</span> <span class="n">gene_names</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--report'</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># gzip defaults on with cellranger unless --no-gzip specified</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'no_gzip'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--no-gzip'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cellranger</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'gzip'</span><span class="p">):</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--gzip'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Velocity / nac extras</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c1'</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-c2'</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="c1"># Tech-specific</span>
    <span class="k">if</span> <span class="n">parity</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--parity'</span><span class="p">,</span> <span class="n">parity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strand</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--strand'</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--fragment-l'</span><span class="p">,</span> <span class="n">fragment_l</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--fragment-s'</span><span class="p">,</span> <span class="n">fragment_s</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--bootstraps'</span><span class="p">,</span> <span class="n">bootstraps</span><span class="p">)</span>

    <span class="c1"># Advanced toggles</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--em'</span><span class="p">,</span> <span class="n">em</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--aa'</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">genomebam</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">WARNING</span><span class="si">}</span><span class="s2">! --genomebam is not supported in many kb versions and may error out.</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--genomebam'</span><span class="p">,</span> <span class="n">genomebam</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--inleaved'</span><span class="p">,</span> <span class="n">inleaved</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--batch-barcodes'</span><span class="p">,</span> <span class="n">batch_barcodes</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--exact-barcodes'</span><span class="p">,</span> <span class="n">exact_barcodes</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Read count / BUS number switches</span>
    <span class="k">if</span> <span class="n">numreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-N'</span><span class="p">,</span> <span class="n">numreads</span><span class="p">)</span>
    <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--num'</span><span class="p">,</span> <span class="n">store_num</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Long-read options</span>
    <span class="k">if</span> <span class="n">long_read</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--long'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--threshold'</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--platform'</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error_rate'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--error-rate'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'error_rate'</span><span class="p">])</span>

    <span class="c1"># Additional inputs</span>
    <span class="k">if</span> <span class="n">whitelist_path</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-w'</span><span class="p">,</span> <span class="n">whitelist_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">replacement_path</span><span class="p">:</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'-r'</span><span class="p">,</span> <span class="n">replacement_path</span><span class="p">)</span>

    <span class="c1"># Pass-through params commonly used</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'kallisto'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--kallisto'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'kallisto'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'bustools'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--bustools'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'bustools'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'opt_off'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--opt-off'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'dry_run'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--dry-run'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'no_inspect'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--no-inspect'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'delete_bus'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--delete-bus'</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Rare/hidden toggles</span>
    <span class="n">passthrough_bool</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'matrix_to_files'</span><span class="p">,</span> <span class="s1">'matrix_to_directories'</span><span class="p">,</span> <span class="s1">'no_fragment'</span><span class="p">,</span>
        <span class="s1">'union'</span><span class="p">,</span> <span class="s1">'no_jump'</span><span class="p">,</span> <span class="s1">'quant_umis'</span><span class="p">,</span> <span class="s1">'keep_flags'</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">passthrough_bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"--</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span><span class="s1">'-'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Scalar extras</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'gtf'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--gtf'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'gtf'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'chromosomes'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--chromosomes'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'chromosomes'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">):</span>
        <span class="n">_append_flag</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'--sum'</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'sum'</span><span class="p">])</span>

    <span class="c1"># Append FASTQ paths last</span>
    <span class="n">fastqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fastq_paths</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fastq_paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">fastq_paths</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fastqs</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># 可选：env['TMPDIR'] = run_tmp</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_run_kb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✓ count workflow completed!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">FAIL</span><span class="si">}</span><span class="s2">✗ count workflow failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">run_tmp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'tmp-kb-'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">run_tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">run_tmp</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">output_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'workflow'</span><span class="p">:</span> <span class="n">workflow</span><span class="p">,</span>
        <span class="s1">'technology'</span><span class="p">:</span> <span class="n">technology</span><span class="p">,</span>
        <span class="s1">'output_path'</span><span class="p">:</span> <span class="n">output_path</span><span class="p">,</span>
        <span class="s1">'parameters'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'threads'</span><span class="p">:</span> <span class="n">threads</span><span class="p">,</span>
            <span class="s1">'memory'</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span>
            <span class="s1">'filter_barcodes'</span><span class="p">:</span> <span class="n">filter_barcodes</span><span class="p">,</span>
            <span class="s1">'h5ad'</span><span class="p">:</span> <span class="n">h5ad</span><span class="p">,</span>
            <span class="s1">'loom'</span><span class="p">:</span> <span class="n">loom</span><span class="p">,</span>
            <span class="s1">'cellranger'</span><span class="p">:</span> <span class="n">cellranger</span><span class="p">,</span>
            <span class="s1">'tcc'</span><span class="p">:</span> <span class="n">tcc</span><span class="p">,</span>
            <span class="s1">'mm'</span><span class="p">:</span> <span class="n">mm</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_maybe</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="n">output_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpath</span>  <span class="c1"># type: ignore[index]</span>

    <span class="n">_maybe</span><span class="p">(</span><span class="s2">"adata.h5ad"</span><span class="p">,</span> <span class="s2">"h5ad_file"</span><span class="p">)</span>
    <span class="n">_maybe</span><span class="p">(</span><span class="s2">"adata.loom"</span><span class="p">,</span> <span class="s2">"loom_file"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cellranger</span><span class="p">:</span>
        <span class="n">cr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">"cellranger"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cr_dir</span><span class="p">):</span>
            <span class="n">output_info</span><span class="p">[</span><span class="s1">'cellranger_dir'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_dir</span>  <span class="c1"># type: ignore[index]</span>
    <span class="n">_maybe</span><span class="p">(</span><span class="s2">"matrix.mtx"</span><span class="p">,</span> <span class="s2">"matrix_file"</span><span class="p">)</span>
    <span class="n">_maybe</span><span class="p">(</span><span class="s2">"barcodes.tsv"</span><span class="p">,</span> <span class="s2">"barcodes_file"</span><span class="p">)</span>
    <span class="n">_maybe</span><span class="p">(</span><span class="s2">"genes.tsv"</span><span class="p">,</span> <span class="s2">"genes_file"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_info</span>  <span class="c1"># type: ignore[return-value]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_10x_v3_data</span><span class="p">(</span><div class="mkapi-source-link" id="omicverse.alignment.kb_api.analyze_10x_v3_data"><a href="../../../../api/omicverse/alignment/kb_api/#omicverse.alignment.kb_api.analyze_10x_v3_data" title="Go to docs">[docs]</a></div>
    <span class="n">fastq_files</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">reference_output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"reference"</span><span class="p">,</span>
    <span class="n">analysis_output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"analysis"</span><span class="p">,</span>
    <span class="n">threads_ref</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">threads_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">download_reference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    One-click 10x v3 data analysis using the kb CLI: Download reference + Count analysis.</span>
<span class="sd">    """</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">)</span>
    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">analysis_output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">download_reference</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s2">Step 1: Downloading human reference genome...</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">ref_result</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span>
            <span class="n">index_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"index.idx"</span><span class="p">),</span>
            <span class="n">t2g_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"t2g.txt"</span><span class="p">),</span>
            <span class="n">d</span><span class="o">=</span><span class="s1">'human'</span><span class="p">,</span>
            <span class="n">cdna_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"transcriptome.fasta"</span><span class="p">),</span>
            <span class="n">threads</span><span class="o">=</span><span class="n">threads_ref</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">'reference'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_result</span>  <span class="c1"># type: ignore[index]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✓ Reference genome download complete!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">index_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"index.idx"</span><span class="p">)</span>
        <span class="n">t2g_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"t2g.txt"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"index.idx"</span><span class="p">)</span>
        <span class="n">t2g_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_output_dir</span><span class="p">,</span> <span class="s2">"t2g.txt"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">BOLD</span><span class="si">}{</span><span class="n">Colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s2">Step 2: Performing count analysis...</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">count_result</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span>
        <span class="n">fastq_paths</span><span class="o">=</span><span class="n">fastq_files</span><span class="p">,</span>
        <span class="n">index_path</span><span class="o">=</span><span class="n">index_file</span><span class="p">,</span>
        <span class="n">t2g_path</span><span class="o">=</span><span class="n">t2g_file</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">analysis_output_dir</span><span class="p">,</span>
        <span class="n">technology</span><span class="o">=</span><span class="s1">'10XV3'</span><span class="p">,</span>
        <span class="n">threads</span><span class="o">=</span><span class="n">threads_count</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="n">count_result</span>  <span class="c1"># type: ignore[index]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">✓ Count analysis complete!</span><span class="si">{</span><span class="n">Colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>  <span class="c1"># type: ignore[return-value]</span>


<span class="c1"># Optional namespace similar to your previous code</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
<span class="n">single</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">()</span>
<span class="n">single</span><span class="o">.</span><span class="n">Colors</span> <span class="o">=</span> <span class="n">Colors</span>
<span class="n">single</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
<span class="n">single</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
<span class="n">single</span><span class="o">.</span><span class="n">analyze_10x_v3_data</span> <span class="o">=</span> <span class="n">analyze_10x_v3_data</span>
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2019-2025, 112 Lab, USTB
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes"], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../../../assets/javascripts/bundle.fc8c2696.min.js"></script>
<script src="../../../../javascript/mkapi.js"></script>
<script src="../../../../javascripts/config.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>